# ========================================
# Development Environment Configuration
# ========================================

# Global settings
global:
  domain: "api.158.220.110.88.nip.io"
  letsencrypt: "letsencrypt-http01"  # or letsencrypt-staging for testing
  imageRegistry: "ghcr.io/your-org"
  imageTag: "latest"
  imagePullPolicy: "IfNotPresent"

# ========================================
# Message Broker Toggle (Kafka or RabbitMQ)
# ========================================
kafka:
  enabled: true  # Set to false to use RabbitMQ instead
  replicaCount: 1
  persistence:
    enabled: true
    size: 20Gi
    storageClass: "local-path"
  resources:
    requests:
      memory: 1Gi
      cpu: 500m
    limits:
      memory: 2Gi
      cpu: 1000m
  zookeeper:
    persistence:
      enabled: true
      size: 8Gi
      storageClass: "local-path"
  metrics:
    kafka:
      enabled: true
    jmx:
      enabled: true
    serviceMonitor:
      enabled: true

rabbitmq:
  enabled: false  # Set to true to use RabbitMQ instead of Kafka
  auth:
    username: "admin"
    password: "rabbitmq-changeme"  # CHANGE IN PRODUCTION
  replicaCount: 1
  persistence:
    enabled: true
    size: 10Gi
    storageClass: "local-path"
  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 1Gi
      cpu: 500m
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# ========================================
# MinIO (S3-compatible object storage)
# ========================================
minio:
  rootUser: "admin"
  rootPassword: "minio-admin-changeme"  # CHANGE IN PRODUCTION
  buckets:
    - name: documents
      policy: none
      purge: false
    - name: audit-attachments
      policy: none
      purge: false
  persistence:
    enabled: true
    size: 50Gi
    storageClass: "local-path"
  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 1Gi
      cpu: 500m
  consoleService:
    type: ClusterIP
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-http01"
    hosts:
      - minio-console.yourdomain.tld
    tls:
      - secretName: minio-console-tls
        hosts:
          - minio-console.yourdomain.tld

# ========================================
# PostgreSQL
# ========================================
postgresql:
  auth:
    username: "onboarding_user"
    password: "postgres-changeme"  # CHANGE IN PRODUCTION
    database: "onboarding"
    postgresPassword: "postgres-root-changeme"  # CHANGE IN PRODUCTION
  primary:
    persistence:
      enabled: true
      size: 20Gi
      storageClass: "local-path"
    resources:
      requests:
        memory: 512Mi
        cpu: 250m
      limits:
        memory: 2Gi
        cpu: 1000m
    initdb:
      scripts:
        01-init-schemas.sql: |
          -- Create schemas for each service
          CREATE SCHEMA IF NOT EXISTS onboarding;
          CREATE SCHEMA IF NOT EXISTS documents;
          CREATE SCHEMA IF NOT EXISTS checklist;
          CREATE SCHEMA IF NOT EXISTS risk;
          CREATE SCHEMA IF NOT EXISTS notifications;
          CREATE SCHEMA IF NOT EXISTS audit;
          CREATE SCHEMA IF NOT EXISTS projections;
          
          -- Grant permissions
          GRANT ALL PRIVILEGES ON SCHEMA onboarding TO onboarding_user;
          GRANT ALL PRIVILEGES ON SCHEMA documents TO onboarding_user;
          GRANT ALL PRIVILEGES ON SCHEMA checklist TO onboarding_user;
          GRANT ALL PRIVILEGES ON SCHEMA risk TO onboarding_user;
          GRANT ALL PRIVILEGES ON SCHEMA notifications TO onboarding_user;
          GRANT ALL PRIVILEGES ON SCHEMA audit TO onboarding_user;
          GRANT ALL PRIVILEGES ON SCHEMA projections TO onboarding_user;
        
        02-outbox-tables.sql: |
          -- Outbox pattern table for each service
          CREATE TABLE IF NOT EXISTS onboarding.outbox_events (
            id UUID PRIMARY KEY,
            aggregate_id UUID NOT NULL,
            aggregate_type VARCHAR(255) NOT NULL,
            event_type VARCHAR(255) NOT NULL,
            payload JSONB NOT NULL,
            occurred_at TIMESTAMP NOT NULL DEFAULT NOW(),
            processed_at TIMESTAMP NULL,
            INDEX idx_outbox_processed (processed_at, occurred_at)
          );
          
          CREATE TABLE IF NOT EXISTS documents.outbox_events (
            id UUID PRIMARY KEY,
            aggregate_id UUID NOT NULL,
            aggregate_type VARCHAR(255) NOT NULL,
            event_type VARCHAR(255) NOT NULL,
            payload JSONB NOT NULL,
            occurred_at TIMESTAMP NOT NULL DEFAULT NOW(),
            processed_at TIMESTAMP NULL,
            INDEX idx_outbox_processed (processed_at, occurred_at)
          );
          
          CREATE TABLE IF NOT EXISTS checklist.outbox_events (
            id UUID PRIMARY KEY,
            aggregate_id UUID NOT NULL,
            aggregate_type VARCHAR(255) NOT NULL,
            event_type VARCHAR(255) NOT NULL,
            payload JSONB NOT NULL,
            occurred_at TIMESTAMP NOT NULL DEFAULT NOW(),
            processed_at TIMESTAMP NULL,
            INDEX idx_outbox_processed (processed_at, occurred_at)
          );
          
          CREATE TABLE IF NOT EXISTS risk.outbox_events (
            id UUID PRIMARY KEY,
            aggregate_id UUID NOT NULL,
            aggregate_type VARCHAR(255) NOT NULL,
            event_type VARCHAR(255) NOT NULL,
            payload JSONB NOT NULL,
            occurred_at TIMESTAMP NOT NULL DEFAULT NOW(),
            processed_at TIMESTAMP NULL,
            INDEX idx_outbox_processed (processed_at, occurred_at)
          );
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# ========================================
# Redis (Cache + Idempotency)
# ========================================
redis:
  architecture: standalone
  auth:
    password: "redis-changeme"  # CHANGE IN PRODUCTION
  master:
    persistence:
      enabled: true
      size: 8Gi
      storageClass: "local-path"
    resources:
      requests:
        memory: 256Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 250m
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# Duplicate kafka and rabbitmq sections removed - configurations merged above

# ========================================
# Authentication - Using external services
# ========================================
# Keycloak removed - using Azure AD for admin and Mukuru Keycloak for partners

# ========================================
# Elasticsearch
# ========================================
elasticsearch:
  replicas: 1
  minimumMasterNodes: 1
  clusterHealthCheckParams: "wait_for_status=yellow&timeout=1s"
  volumeClaimTemplate:
    accessModes: ["ReadWriteOnce"]
    storageClassName: "local-path"
    resources:
      requests:
        storage: 30Gi
  resources:
    requests:
      cpu: 500m
      memory: 2Gi
    limits:
      cpu: 1000m
      memory: 4Gi
  esJavaOpts: "-Xmx2g -Xms2g"

# ========================================
# Fluent Bit
# ========================================
fluent-bit:
  config:
    service: |
      [SERVICE]
          Daemon Off
          Flush 5
          Log_Level info
          Parsers_File parsers.conf
          Parsers_File custom_parsers.conf
          HTTP_Server On
          HTTP_Listen 0.0.0.0
          HTTP_Port 2020
          Health_Check On
    
    inputs: |
      [INPUT]
          Name tail
          Path /var/log/containers/*_business-*.log
          Parser docker
          Tag kube.*
          Mem_Buf_Limit 5MB
          Skip_Long_Lines On
    
    filters: |
      [FILTER]
          Name kubernetes
          Match kube.*
          Kube_URL https://kubernetes.default.svc:443
          Kube_CA_File /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          Kube_Token_File /var/run/secrets/kubernetes.io/serviceaccount/token
          Kube_Tag_Prefix kube.var.log.containers.
          Merge_Log On
          Keep_Log Off
      
      [FILTER]
          Name modify
          Match *
          Remove_regex log (password|token|secret|apikey|credit_card|ssn).*
    
    outputs: |
      [OUTPUT]
          Name es
          Match kube.*
          Host elasticsearch-master.platform-observability.svc.cluster.local
          Port 9200
          Logstash_Format On
          Logstash_Prefix fluentbit
          Retry_Limit 5

# ========================================
# Prometheus Stack
# ========================================
prometheus:
  prometheus:
    prometheusSpec:
      retention: 15d
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 20Gi
      resources:
        requests:
          memory: 1Gi
          cpu: 500m
        limits:
          memory: 2Gi
          cpu: 1000m
  alertmanager:
    alertmanagerSpec:
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi

# ========================================
# Grafana
# ========================================
grafana:
  adminUser: "admin"
  adminPassword: "grafana-admin-changeme"  # CHANGE IN PRODUCTION
  persistence:
    enabled: true
    storageClassName: "local-path"
    size: 2Gi
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-http01"
    hosts:
      - grafana.yourdomain.tld
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana.yourdomain.tld
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://prometheus-kube-prometheus-prometheus.platform-observability:9090
          access: proxy
          isDefault: true
        - name: Elasticsearch
          type: elasticsearch
          url: http://elasticsearch-master.platform-observability:9200
          access: proxy
          database: "[fluentbit-]YYYY.MM.DD"
          jsonData:
            timeField: "@timestamp"

# ========================================
# OpenTelemetry Collector
# ========================================
opentelemetry-collector:
  mode: deployment
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 250m
  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
    
    processors:
      batch:
        timeout: 10s
        send_batch_size: 1024
      
      memory_limiter:
        check_interval: 1s
        limit_mib: 400
    
    exporters:
      prometheus:
        endpoint: "0.0.0.0:8889"
      
      elasticsearch:
        endpoints: ["http://elasticsearch-master.platform-observability:9200"]
        logs_index: "otel-logs"
        traces_index: "otel-traces"
    
    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [elasticsearch]
        
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [prometheus]
        
        logs:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [elasticsearch]

# ========================================
# Business Services Configuration
# ========================================
kyc-onboarding-api:
  image:
    repository: ghcr.io/your-org/kyc-onboarding-api
    tag: latest
    pullPolicy: IfNotPresent
  replicaCount: 2
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m
  env:
    - name: ASPNETCORE_ENVIRONMENT
      value: "Development"
    - name: ConnectionStrings__PostgreSQL
      value: "Host=postgresql.platform-observability;Database=onboarding;Username=onboarding_user;Password=postgres-changeme"
    - name: ConnectionStrings__Redis
      value: "redis.platform-observability:6379,password=redis-changeme"
    - name: Kafka__BootstrapServers
      value: "kafka.platform-observability:9092"
    # Keycloak authentication removed - using external auth services
    - name: MinIO__Endpoint
      value: "minio.platform-observability:9000"
    - name: MinIO__AccessKey
      value: "admin"
    - name: MinIO__SecretKey
      value: "minio-admin-changeme"
    - name: OpenTelemetry__Endpoint
      value: "http://opentelemetry-collector.platform-observability:4317"

kyc-document-api:
  image:
    repository: ghcr.io/your-org/kyc-document-api
    tag: latest
    pullPolicy: IfNotPresent
  replicaCount: 2
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m

kyc-checklist-api:
  image:
    repository: ghcr.io/your-org/kyc-checklist-api
    tag: latest
    pullPolicy: IfNotPresent
  replicaCount: 2
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m

kyc-risk-api:
  image:
    repository: ghcr.io/your-org/kyc-risk-api
    tag: latest
    pullPolicy: IfNotPresent
  replicaCount: 2
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m

kyc-notification-api:
  image:
    repository: ghcr.io/your-org/kyc-notification-api
    tag: latest
    pullPolicy: IfNotPresent
  replicaCount: 2
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m

kyc-webhook-handler:
  image:
    repository: ghcr.io/your-org/kyc-webhook-handler
    tag: latest
    pullPolicy: IfNotPresent
  replicaCount: 2
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m

kyc-audit-api:
  image:
    repository: ghcr.io/your-org/kyc-audit-api
    tag: latest
    pullPolicy: IfNotPresent
  replicaCount: 2
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m

kyc-projections-api:
  image:
    repository: ghcr.io/your-org/kyc-projections-api
    tag: latest
    pullPolicy: IfNotPresent
  replicaCount: 2
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m

