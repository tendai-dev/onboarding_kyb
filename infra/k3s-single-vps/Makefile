.PHONY: help up down status kubeconfig install-platform logs restart clean

KUBECONFIG ?= ~/.kube/config
HELMFILE := helmfile --file ../../infra/helm/helmfile.yaml

help: ## Show this help message
	@echo 'Usage: make [target]'
	@echo ''
	@echo 'Available targets:'
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

up: ## Install/upgrade all platform and application services
	@echo "ğŸš€ Deploying platform and services..."
	@$(HELMFILE) sync
	@echo ""
	@echo "âœ… Deployment complete!"
	@$(MAKE) status

down: ## Uninstall all platform and application services
	@echo "ğŸ—‘ï¸  Removing all services..."
	@$(HELMFILE) destroy
	@echo "âœ… All services removed"

status: ## Show cluster and service status
	@echo "ğŸ“Š Cluster Status"
	@echo "================="
	@kubectl get nodes
	@echo ""
	@echo "ğŸ“¦ Namespaces and Pods"
	@echo "======================"
	@kubectl get pods -A -o wide
	@echo ""
	@echo "ğŸŒ Ingress Routes"
	@echo "================="
	@kubectl get ingress -A
	@echo ""
	@echo "ğŸ“œ Certificates"
	@echo "==============="
	@kubectl get certificates -A

kubeconfig: ## Display kubeconfig info
	@echo "Kubeconfig: ${KUBECONFIG}"
	@echo ""
	@kubectl config view --minify

install-platform: ## Install only platform services (infra)
	@echo "ğŸ—ï¸  Installing platform services..."
	@$(HELMFILE) sync --selector tier=platform

logs: ## Tail logs from all business services
	@echo "ğŸ“‹ Tailing logs from business services..."
	@kubectl logs -f -l tier=business -n business-onboarding --tail=100

restart: ## Restart all business service deployments
	@echo "ğŸ”„ Restarting business services..."
	@kubectl rollout restart deployment -n business-onboarding
	@kubectl rollout restart deployment -n business-documents
	@kubectl rollout restart deployment -n business-risk
	@kubectl rollout restart deployment -n business-notifications
	@kubectl rollout restart deployment -n business-webhooks
	@kubectl rollout restart deployment -n business-readmodel
	@kubectl rollout restart deployment -n business-admin

clean: ## Delete all PVCs and data (DESTRUCTIVE)
	@echo "âš ï¸  WARNING: This will delete all data!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo ""; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		kubectl delete pvc --all -A; \
		echo "âœ… All PVCs deleted"; \
	fi

