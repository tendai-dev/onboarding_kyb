;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="5a0c4328-9fe0-7022-2c5b-33a8f74b52fb")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,515570,e=>{"use strict";var t,r,n,o,s,i,a,c,l,h,d=e.i(843476),g=e.i(843011),u=e.i(297630),p=e.i(53545),m=e.i(361035),f=e.i(571798),_=e.i(761869),y=e.i(300713),w=e.i(522207);e.i(643983);var S=e.i(825402),v=e.i(554646),b=e.i(191348),x=e.i(613056),C=e.i(44999),I=e.i(404372),k=e.i(778528),T=e.i(192199),j=e.i(178849),E=e.i(271645),R=e.i(862873),P=e.i(247167);async function M(){let e={"Content-Type":"application/json"};try{let t=await fetch("/api/auth/session"),r=await t.json();if(r?.user?.email&&(e["X-User-Email"]=r.user.email),r?.user?.name&&(e["X-User-Name"]=r.user.name),r?.user?.role||r?.user?.roles){let t=r.user.role||r.user.roles?.[0]||"Admin";e["X-User-Role"]=t}}catch(e){console.warn("Failed to get session:",e)}return e}async function A(e,t){let r=`/api/proxy/messaging${e}`,n=await M();try{let e=await fetch("/api/auth/session"),t=await e.json();if(t?.user?.email&&(n["X-User-Email"]=t.user.email),t?.user?.name&&(n["X-User-Name"]=t.user.name),t?.user?.role||t?.user?.roles){let e=t.user.role||t.user.roles?.[0]||"Administrator";if(n["X-User-Role"]=e,t?.user?.email){let e=t.user.email,r=function(e,t){let r=e.toLowerCase(),n=0;for(let e=0;e<r.length;e++)n=(n<<5)-n+r.charCodeAt(e),n&=n;let o=Math.abs(n).toString(16).padStart(8,"0");return`${o.substring(0,8)}-${o.substring(0,4)}-5000-8000-${o.padEnd(12,"0")}`}(e,0);n["X-User-Id"]=r}}}catch(e){console.warn("Failed to get session for user headers:",e)}try{let o=await fetch(r,{...t,headers:{...n,...t?.headers},credentials:"include"}),s=await o.text();if(!o.ok){let e=`Messaging API request failed: ${o.status} ${o.statusText}`;try{let t=JSON.parse(s);t.message?e=t.message:t.details?e=t.details:t.error&&(e=t.error)}catch{s&&s.trim().length>0&&(e=s.length>200?s.substring(0,200)+"...":s)}throw 503===o.status&&(e="Backend messaging service is unavailable. Please ensure the messaging service is running."),Error(e)}let i=o.headers.get("content-type");if(i&&i.includes("application/json")){if(!s||""===s.trim())return console.warn("[Messaging API] Empty response body for:",e),{};try{return JSON.parse(s)}catch(e){throw console.error("[Messaging API] JSON parse error:",e,"Response text:",s),Error("Invalid JSON response from server")}}return s&&s.trim().length>0&&console.warn("[Messaging API] Non-JSON response received:",s.substring(0,200)),{}}catch(e){if(e instanceof TypeError&&e.message.includes("Failed to fetch"))throw Error("Cannot connect to Messaging API. Please ensure the backend services are running.");throw e}}let D={async getMyThreads(e=1,t=20){let r=new URLSearchParams({page:String(e),pageSize:String(t)}).toString(),n=await A(`/api/v1/messages/threads/my?${r}`);return{items:n.items||n.Items||[],totalCount:n.totalCount??n.TotalCount??0,page:n.page??n.Page??e,pageSize:n.pageSize??n.PageSize??t,totalPages:n.totalPages??n.TotalPages??0,hasNextPage:n.hasNextPage??n.HasNextPage??!1,hasPreviousPage:n.hasPreviousPage??n.HasPreviousPage??!1}},async getAllThreads(e=1,t=20){let r=new URLSearchParams({page:String(e),pageSize:String(t)}).toString(),n=await A(`/api/v1/messages/threads/all?${r}`);return{items:n.items||n.Items||[],totalCount:n.totalCount??n.TotalCount??0,page:n.page??n.Page??e,pageSize:n.pageSize??n.PageSize??t,totalPages:n.totalPages??n.TotalPages??0,hasNextPage:n.hasNextPage??n.HasNextPage??!1,hasPreviousPage:n.hasPreviousPage??n.HasPreviousPage??!1}},getThreadByApplication:async e=>A(`/api/v1/messages/threads/application/${encodeURIComponent(e)}`),async getThreadMessages(e,t=1,r=50){let n=new URLSearchParams({page:String(t),pageSize:String(r)}).toString();return A(`/api/v1/messages/threads/${encodeURIComponent(e)}/messages?${n}`)},async sendMessage(e,t,r,n,o){try{let s=e;if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e))try{let{applicationsApi:t}=await (()=>{let e=Error("Cannot find module './applicationsApi'");throw e.code="MODULE_NOT_FOUND",e})(),r=await t.getApplicationById(e);if(r?.id)s=r.id;else throw Error(`Could not find application GUID for case ID: ${e}`)}catch(t){throw console.error("Failed to fetch application GUID from case ID:",t),Error(`Invalid application ID: ${e}. Could not resolve to GUID.`)}let i={ApplicationId:s,Content:t};r&&(i.ReceiverId=r),n&&(i.ReplyToMessageId=n),o&&o.length>0&&(i.Attachments=o.map(e=>({FileName:e.fileName,ContentType:e.contentType,FileSizeBytes:e.fileSizeBytes,StorageKey:e.storageKey,StorageUrl:e.storageUrl,DocumentId:e.documentId,Description:e.description})));let a=await A("/api/v1/messages",{method:"POST",body:JSON.stringify(i)}),c=a.Success??a.success??!1,l=a.MessageId??a.messageId,h=a.ThreadId??a.threadId,d=a.ErrorMessage??a.errorMessage;if(!c&&d)throw Error(d);return{success:c,messageId:l,threadId:h,errorMessage:d}}catch(e){throw console.error("Error sending message:",e),e}},async getUnreadCount(){try{return await A("/api/v1/messages/unread/count")}catch(e){return{count:(await this.getMyThreads(1,1e3)).items.reduce((e,t)=>e+(t.unreadCount||0),0)}}},async markMessageRead(e){await A(`/api/v1/messages/${encodeURIComponent(e)}/read`,{method:"PUT"})},async deleteMessage(e){try{return await A(`/api/v1/messages/${encodeURIComponent(e)}`,{method:"DELETE"}),{success:!0}}catch(e){return{success:!1,errorMessage:e instanceof Error?e.message:"Failed to delete message"}}},async starMessage(e){try{let t=await A(`/api/v1/messages/${encodeURIComponent(e)}/star`,{method:"PUT"});return{success:t.Success??t.success??!1,isStarred:t.IsStarred??t.isStarred??!1,errorMessage:t.ErrorMessage}}catch(e){return{success:!1,isStarred:!1,errorMessage:e instanceof Error?e.message:"Failed to star message"}}},async archiveThread(e,t=!0){try{let r=await A(`/api/v1/messages/threads/${encodeURIComponent(e)}/archive`,{method:"PUT",body:JSON.stringify({Archive:t})});return{success:r.Success??r.success??!1,isArchived:r.IsArchived??r.isArchived??!1,errorMessage:r.ErrorMessage}}catch(e){return{success:!1,isArchived:!1,errorMessage:e instanceof Error?e.message:"Failed to archive thread"}}},async forwardMessage(e,t,r,n){try{let o=await A(`/api/v1/messages/${encodeURIComponent(e)}/forward`,{method:"POST",body:JSON.stringify({ToApplicationId:t,ToReceiverId:r,AdditionalContent:n})});return{success:o.Success??o.success??!1,newMessageId:o.NewMessageId??o.newMessageId,newThreadId:o.NewThreadId??o.newThreadId,errorMessage:o.ErrorMessage}}catch(e){return{success:!1,errorMessage:e instanceof Error?e.message:"Failed to forward message"}}}};class ${static write(e){return`${e}${$.RecordSeparator}`}static parse(e){if(e[e.length-1]!==$.RecordSeparator)throw Error("Message is incomplete.");let t=e.split($.RecordSeparator);return t.pop(),t}}$.RecordSeparatorCode=30,$.RecordSeparator=String.fromCharCode($.RecordSeparatorCode),(t=i||(i={}))[t.Trace=0]="Trace",t[t.Debug=1]="Debug",t[t.Information=2]="Information",t[t.Warning=3]="Warning",t[t.Error=4]="Error",t[t.Critical=5]="Critical",t[t.None=6]="None";class N{constructor(){}log(e,t){}}N.instance=new N;class F{static isRequired(e,t){if(null==e)throw Error(`The '${t}' argument is required.`)}static isNotEmpty(e,t){if(!e||e.match(/^\s*$/))throw Error(`The '${t}' argument should not be empty.`)}static isIn(e,t,r){if(!(e in t))throw Error(`Unknown ${r} value: ${e}.`)}}class z{static get isBrowser(){return!z.isNode&&"object"==typeof window&&"object"==typeof window.document}static get isWebWorker(){return!z.isNode&&"object"==typeof self&&"importScripts"in self}static get isReactNative(){return!z.isNode&&"object"==typeof window&&void 0===window.document}static get isNode(){return void 0!==P.default&&P.default.release&&"node"===P.default.release.name}}function W(e,t){let r,n,o="";return U(e)?(o=`Binary data of length ${e.byteLength}`,t&&(o+=`. Content: '${r=new Uint8Array(e),n="",r.forEach(e=>{let t=e<16?"0":"";n+=`0x${t}${e.toString(16)} `}),n.substr(0,n.length-1)}'`)):"string"==typeof e&&(o=`String data of length ${e.length}`,t&&(o+=`. Content: '${e}'`)),o}function U(e){return e&&"undefined"!=typeof ArrayBuffer&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name)}async function B(e,t,r,n,o,s){let a={},[c,l]=q();a[c]=l,e.log(i.Trace,`(${t} transport) sending data. ${W(o,s.logMessageContent)}.`);let h=U(o)?"arraybuffer":"text",d=await r.post(n,{content:o,headers:{...a,...s.headers},responseType:h,timeout:s.timeout,withCredentials:s.withCredentials});e.log(i.Trace,`(${t} transport) request complete. Response status: ${d.statusCode}.`)}class H{constructor(e,t){this._subject=e,this._observer=t}dispose(){let e=this._subject.observers.indexOf(this._observer);e>-1&&this._subject.observers.splice(e,1),0===this._subject.observers.length&&this._subject.cancelCallback&&this._subject.cancelCallback().catch(e=>{})}}class L{constructor(e){this._minLevel=e,this.out=console}log(e,t){if(e>=this._minLevel){let r=`[${new Date().toISOString()}] ${i[e]}: ${t}`;switch(e){case i.Critical:case i.Error:this.out.error(r);break;case i.Warning:this.out.warn(r);break;case i.Information:this.out.info(r);break;default:this.out.log(r)}}}}function q(){var e,t,r,n;let o,s,i="X-SignalR-User-Agent";return z.isNode&&(i="User-Agent"),[i,(e="9.0.6",t=function(){if(!z.isNode)return"";switch(P.default.platform){case"win32":return"Windows NT";case"darwin":return"macOS";case"linux":return"Linux";default:return P.default.platform}}(),r=z.isNode?"NodeJS":"Browser",n=function(){if(z.isNode)return P.default.versions.node}(),o="Microsoft SignalR/",s=e.split("."),o+=`${s[0]}.${s[1]} (${e}; `,t&&""!==t?o+=`${t}; `:o+="Unknown OS; ",o+=`${r}`,n?o+=`; ${n}`:o+="; Unknown Runtime Version",o+=")")]}function O(e){return e.stack?e.stack:e.message?e.message:`${e}`}class V{writeHandshakeRequest(e){return $.write(JSON.stringify(e))}parseHandshakeResponse(e){let t,r;if(U(e)){let n=new Uint8Array(e),o=n.indexOf($.RecordSeparatorCode);if(-1===o)throw Error("Message is incomplete.");let s=o+1;t=String.fromCharCode.apply(null,Array.prototype.slice.call(n.slice(0,s))),r=n.byteLength>s?n.slice(s).buffer:null}else{let n=e.indexOf($.RecordSeparator);if(-1===n)throw Error("Message is incomplete.");let o=n+1;t=e.substring(0,o),r=e.length>o?e.substring(o):null}let n=JSON.parse($.parse(t)[0]);if(n.type)throw Error("Expected a handshake response from the server.");return[r,n]}}class K extends Error{constructor(e,t){const r=new.target.prototype;super(`${e}: Status code '${t}'`),this.statusCode=t,this.__proto__=r}}class X extends Error{constructor(e="A timeout occurred."){const t=new.target.prototype;super(e),this.__proto__=t}}class J extends Error{constructor(e="An abort occurred."){const t=new.target.prototype;super(e),this.__proto__=t}}class G extends Error{constructor(e,t){const r=new.target.prototype;super(e),this.transport=t,this.errorType="UnsupportedTransportError",this.__proto__=r}}class Q extends Error{constructor(e,t){const r=new.target.prototype;super(e),this.transport=t,this.errorType="DisabledTransportError",this.__proto__=r}}class Y extends Error{constructor(e,t){const r=new.target.prototype;super(e),this.transport=t,this.errorType="FailedToStartTransportError",this.__proto__=r}}class Z extends Error{constructor(e){const t=new.target.prototype;super(e),this.errorType="FailedToNegotiateWithServerError",this.__proto__=t}}class ee extends Error{constructor(e,t){const r=new.target.prototype;super(e),this.innerErrors=t,this.__proto__=r}}(r=a||(a={}))[r.Invocation=1]="Invocation",r[r.StreamItem=2]="StreamItem",r[r.Completion=3]="Completion",r[r.StreamInvocation=4]="StreamInvocation",r[r.CancelInvocation=5]="CancelInvocation",r[r.Ping=6]="Ping",r[r.Close=7]="Close",r[r.Ack=8]="Ack",r[r.Sequence=9]="Sequence";class et{constructor(){this.observers=[]}next(e){for(let t of this.observers)t.next(e)}error(e){for(let t of this.observers)t.error&&t.error(e)}complete(){for(let e of this.observers)e.complete&&e.complete()}subscribe(e){return this.observers.push(e),new H(this,e)}}class er{constructor(e,t,r){this._bufferSize=1e5,this._messages=[],this._totalMessageCount=0,this._waitForSequenceMessage=!1,this._nextReceivingSequenceId=1,this._latestReceivedSequenceId=0,this._bufferedByteCount=0,this._reconnectInProgress=!1,this._protocol=e,this._connection=t,this._bufferSize=r}async _send(e){let t=this._protocol.writeMessage(e),r=Promise.resolve();if(this._isInvocationMessage(e)){this._totalMessageCount++;let e=()=>{},n=()=>{};U(t)?this._bufferedByteCount+=t.byteLength:this._bufferedByteCount+=t.length,this._bufferedByteCount>=this._bufferSize&&(r=new Promise((t,r)=>{e=t,n=r})),this._messages.push(new en(t,this._totalMessageCount,e,n))}try{this._reconnectInProgress||await this._connection.send(t)}catch{this._disconnected()}await r}_ack(e){let t=-1;for(let r=0;r<this._messages.length;r++){let n=this._messages[r];if(n._id<=e.sequenceId)t=r,U(n._message)?this._bufferedByteCount-=n._message.byteLength:this._bufferedByteCount-=n._message.length,n._resolver();else if(this._bufferedByteCount<this._bufferSize)n._resolver();else break}-1!==t&&(this._messages=this._messages.slice(t+1))}_shouldProcessMessage(e){if(this._waitForSequenceMessage)if(e.type!==a.Sequence)return!1;else return this._waitForSequenceMessage=!1,!0;if(!this._isInvocationMessage(e))return!0;let t=this._nextReceivingSequenceId;return(this._nextReceivingSequenceId++,t<=this._latestReceivedSequenceId)?(t===this._latestReceivedSequenceId&&this._ackTimer(),!1):(this._latestReceivedSequenceId=t,this._ackTimer(),!0)}_resetSequence(e){e.sequenceId>this._nextReceivingSequenceId?this._connection.stop(Error("Sequence ID greater than amount of messages we've received.")):this._nextReceivingSequenceId=e.sequenceId}_disconnected(){this._reconnectInProgress=!0,this._waitForSequenceMessage=!0}async _resend(){let e=0!==this._messages.length?this._messages[0]._id:this._totalMessageCount+1;for(let t of(await this._connection.send(this._protocol.writeMessage({type:a.Sequence,sequenceId:e})),this._messages))await this._connection.send(t._message);this._reconnectInProgress=!1}_dispose(e){for(let t of(null!=e||(e=Error("Unable to reconnect to server.")),this._messages))t._rejector(e)}_isInvocationMessage(e){switch(e.type){case a.Invocation:case a.StreamItem:case a.Completion:case a.StreamInvocation:case a.CancelInvocation:return!0;case a.Close:case a.Sequence:case a.Ping:case a.Ack:return!1}}_ackTimer(){void 0===this._ackTimerHandle&&(this._ackTimerHandle=setTimeout(async()=>{try{this._reconnectInProgress||await this._connection.send(this._protocol.writeMessage({type:a.Ack,sequenceId:this._latestReceivedSequenceId}))}catch{}clearTimeout(this._ackTimerHandle),this._ackTimerHandle=void 0},1e3))}}class en{constructor(e,t,r,n){this._message=e,this._id=t,this._resolver=r,this._rejector=n}}(n=c||(c={})).Disconnected="Disconnected",n.Connecting="Connecting",n.Connected="Connected",n.Disconnecting="Disconnecting",n.Reconnecting="Reconnecting";class eo{static create(e,t,r,n,o,s,i){return new eo(e,t,r,n,o,s,i)}constructor(e,t,r,n,o,s,l){this._nextKeepAlive=0,this._freezeEventListener=()=>{this._logger.log(i.Warning,"The page is being frozen, this will likely lead to the connection being closed and messages being lost. For more information see the docs at https://learn.microsoft.com/aspnet/core/signalr/javascript-client#bsleep")},F.isRequired(e,"connection"),F.isRequired(t,"logger"),F.isRequired(r,"protocol"),this.serverTimeoutInMilliseconds=null!=o?o:3e4,this.keepAliveIntervalInMilliseconds=null!=s?s:15e3,this._statefulReconnectBufferSize=null!=l?l:1e5,this._logger=t,this._protocol=r,this.connection=e,this._reconnectPolicy=n,this._handshakeProtocol=new V,this.connection.onreceive=e=>this._processIncomingData(e),this.connection.onclose=e=>this._connectionClosed(e),this._callbacks={},this._methods={},this._closedCallbacks=[],this._reconnectingCallbacks=[],this._reconnectedCallbacks=[],this._invocationId=0,this._receivedHandshakeResponse=!1,this._connectionState=c.Disconnected,this._connectionStarted=!1,this._cachedPingMessage=this._protocol.writeMessage({type:a.Ping})}get state(){return this._connectionState}get connectionId(){return this.connection&&this.connection.connectionId||null}get baseUrl(){return this.connection.baseUrl||""}set baseUrl(e){if(this._connectionState!==c.Disconnected&&this._connectionState!==c.Reconnecting)throw Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!e)throw Error("The HubConnection url must be a valid url.");this.connection.baseUrl=e}start(){return this._startPromise=this._startWithStateTransitions(),this._startPromise}async _startWithStateTransitions(){if(this._connectionState!==c.Disconnected)return Promise.reject(Error("Cannot start a HubConnection that is not in the 'Disconnected' state."));this._connectionState=c.Connecting,this._logger.log(i.Debug,"Starting HubConnection.");try{await this._startInternal(),z.isBrowser&&window.document.addEventListener("freeze",this._freezeEventListener),this._connectionState=c.Connected,this._connectionStarted=!0,this._logger.log(i.Debug,"HubConnection connected successfully.")}catch(e){return this._connectionState=c.Disconnected,this._logger.log(i.Debug,`HubConnection failed to start successfully because of error '${e}'.`),Promise.reject(e)}}async _startInternal(){this._stopDuringStartError=void 0,this._receivedHandshakeResponse=!1;let e=new Promise((e,t)=>{this._handshakeResolver=e,this._handshakeRejecter=t});await this.connection.start(this._protocol.transferFormat);try{let t=this._protocol.version;this.connection.features.reconnect||(t=1);let r={protocol:this._protocol.name,version:t};if(this._logger.log(i.Debug,"Sending handshake request."),await this._sendMessage(this._handshakeProtocol.writeHandshakeRequest(r)),this._logger.log(i.Information,`Using HubProtocol '${this._protocol.name}'.`),this._cleanupTimeout(),this._resetTimeoutPeriod(),this._resetKeepAliveInterval(),await e,this._stopDuringStartError)throw this._stopDuringStartError;(this.connection.features.reconnect||0)&&(this._messageBuffer=new er(this._protocol,this.connection,this._statefulReconnectBufferSize),this.connection.features.disconnected=this._messageBuffer._disconnected.bind(this._messageBuffer),this.connection.features.resend=()=>{if(this._messageBuffer)return this._messageBuffer._resend()}),this.connection.features.inherentKeepAlive||await this._sendMessage(this._cachedPingMessage)}catch(e){throw this._logger.log(i.Debug,`Hub handshake failed with error '${e}' during start(). Stopping HubConnection.`),this._cleanupTimeout(),this._cleanupPingTimer(),await this.connection.stop(e),e}}async stop(){let e=this._startPromise;this.connection.features.reconnect=!1,this._stopPromise=this._stopInternal(),await this._stopPromise;try{await e}catch(e){}}_stopInternal(e){if(this._connectionState===c.Disconnected)return this._logger.log(i.Debug,`Call to HubConnection.stop(${e}) ignored because it is already in the disconnected state.`),Promise.resolve();if(this._connectionState===c.Disconnecting)return this._logger.log(i.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnecting state.`),this._stopPromise;let t=this._connectionState;return(this._connectionState=c.Disconnecting,this._logger.log(i.Debug,"Stopping HubConnection."),this._reconnectDelayHandle)?(this._logger.log(i.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this._reconnectDelayHandle),this._reconnectDelayHandle=void 0,this._completeClose(),Promise.resolve()):(t===c.Connected&&this._sendCloseMessage(),this._cleanupTimeout(),this._cleanupPingTimer(),this._stopDuringStartError=e||new J("The connection was stopped before the hub handshake could complete."),this.connection.stop(e))}async _sendCloseMessage(){try{await this._sendWithProtocol(this._createCloseMessage())}catch{}}stream(e,...t){let r,[n,o]=this._replaceStreamingParams(t),s=this._createStreamInvocation(e,t,o),i=new et;return i.cancelCallback=()=>{let e=this._createCancelInvocation(s.invocationId);return delete this._callbacks[s.invocationId],r.then(()=>this._sendWithProtocol(e))},this._callbacks[s.invocationId]=(e,t)=>{t?i.error(t):e&&(e.type===a.Completion?e.error?i.error(Error(e.error)):i.complete():i.next(e.item))},r=this._sendWithProtocol(s).catch(e=>{i.error(e),delete this._callbacks[s.invocationId]}),this._launchStreams(n,r),i}_sendMessage(e){return this._resetKeepAliveInterval(),this.connection.send(e)}_sendWithProtocol(e){return this._messageBuffer?this._messageBuffer._send(e):this._sendMessage(this._protocol.writeMessage(e))}send(e,...t){let[r,n]=this._replaceStreamingParams(t),o=this._sendWithProtocol(this._createInvocation(e,t,!0,n));return this._launchStreams(r,o),o}invoke(e,...t){let[r,n]=this._replaceStreamingParams(t),o=this._createInvocation(e,t,!1,n);return new Promise((e,t)=>{this._callbacks[o.invocationId]=(r,n)=>{n?t(n):r&&(r.type===a.Completion?r.error?t(Error(r.error)):e(r.result):t(Error(`Unexpected message type: ${r.type}`)))};let n=this._sendWithProtocol(o).catch(e=>{t(e),delete this._callbacks[o.invocationId]});this._launchStreams(r,n)})}on(e,t){e&&t&&(e=e.toLowerCase(),this._methods[e]||(this._methods[e]=[]),-1===this._methods[e].indexOf(t)&&this._methods[e].push(t))}off(e,t){if(!e)return;e=e.toLowerCase();let r=this._methods[e];if(r)if(t){let n=r.indexOf(t);-1!==n&&(r.splice(n,1),0===r.length&&delete this._methods[e])}else delete this._methods[e]}onclose(e){e&&this._closedCallbacks.push(e)}onreconnecting(e){e&&this._reconnectingCallbacks.push(e)}onreconnected(e){e&&this._reconnectedCallbacks.push(e)}_processIncomingData(e){if(this._cleanupTimeout(),this._receivedHandshakeResponse||(e=this._processHandshakeResponse(e),this._receivedHandshakeResponse=!0),e){for(let t of this._protocol.parseMessages(e,this._logger))if(!this._messageBuffer||this._messageBuffer._shouldProcessMessage(t))switch(t.type){case a.Invocation:this._invokeClientMethod(t).catch(e=>{this._logger.log(i.Error,`Invoke client method threw error: ${O(e)}`)});break;case a.StreamItem:case a.Completion:{let e=this._callbacks[t.invocationId];if(e){t.type===a.Completion&&delete this._callbacks[t.invocationId];try{e(t)}catch(e){this._logger.log(i.Error,`Stream callback threw error: ${O(e)}`)}}break}case a.Ping:break;case a.Close:{this._logger.log(i.Information,"Close message received from server.");let e=t.error?Error("Server returned an error on close: "+t.error):void 0;!0===t.allowReconnect?this.connection.stop(e):this._stopPromise=this._stopInternal(e);break}case a.Ack:this._messageBuffer&&this._messageBuffer._ack(t);break;case a.Sequence:this._messageBuffer&&this._messageBuffer._resetSequence(t);break;default:this._logger.log(i.Warning,`Invalid message type: ${t.type}.`)}}this._resetTimeoutPeriod()}_processHandshakeResponse(e){let t,r;try{[r,t]=this._handshakeProtocol.parseHandshakeResponse(e)}catch(r){let e="Error parsing handshake response: "+r;this._logger.log(i.Error,e);let t=Error(e);throw this._handshakeRejecter(t),t}if(t.error){let e="Server returned handshake error: "+t.error;this._logger.log(i.Error,e);let r=Error(e);throw this._handshakeRejecter(r),r}return this._logger.log(i.Debug,"Server handshake complete."),this._handshakeResolver(),r}_resetKeepAliveInterval(){this.connection.features.inherentKeepAlive||(this._nextKeepAlive=new Date().getTime()+this.keepAliveIntervalInMilliseconds,this._cleanupPingTimer())}_resetTimeoutPeriod(){if((!this.connection.features||!this.connection.features.inherentKeepAlive)&&(this._timeoutHandle=setTimeout(()=>this.serverTimeout(),this.serverTimeoutInMilliseconds),void 0===this._pingServerHandle)){let e=this._nextKeepAlive-new Date().getTime();e<0&&(e=0),this._pingServerHandle=setTimeout(async()=>{if(this._connectionState===c.Connected)try{await this._sendMessage(this._cachedPingMessage)}catch{this._cleanupPingTimer()}},e)}}serverTimeout(){this.connection.stop(Error("Server timeout elapsed without receiving a message from the server."))}async _invokeClientMethod(e){let t,r,n,o=e.target.toLowerCase(),s=this._methods[o];if(!s){this._logger.log(i.Warning,`No client method with the name '${o}' found.`),e.invocationId&&(this._logger.log(i.Warning,`No result given for '${o}' method and invocation ID '${e.invocationId}'.`),await this._sendWithProtocol(this._createCompletionMessage(e.invocationId,"Client didn't provide a result.",null)));return}let a=s.slice(),c=!!e.invocationId;for(let s of a)try{let a=t;t=await s.apply(this,e.arguments),c&&t&&a&&(this._logger.log(i.Error,`Multiple results provided for '${o}'. Sending error to server.`),n=this._createCompletionMessage(e.invocationId,"Client provided multiple results.",null)),r=void 0}catch(e){r=e,this._logger.log(i.Error,`A callback for the method '${o}' threw error '${e}'.`)}n?await this._sendWithProtocol(n):c?(r?n=this._createCompletionMessage(e.invocationId,`${r}`,null):void 0!==t?n=this._createCompletionMessage(e.invocationId,null,t):(this._logger.log(i.Warning,`No result given for '${o}' method and invocation ID '${e.invocationId}'.`),n=this._createCompletionMessage(e.invocationId,"Client didn't provide a result.",null)),await this._sendWithProtocol(n)):t&&this._logger.log(i.Error,`Result given for '${o}' method but server is not expecting a result.`)}_connectionClosed(e){this._logger.log(i.Debug,`HubConnection.connectionClosed(${e}) called while in state ${this._connectionState}.`),this._stopDuringStartError=this._stopDuringStartError||e||new J("The underlying connection was closed before the hub handshake could complete."),this._handshakeResolver&&this._handshakeResolver(),this._cancelCallbacksWithError(e||Error("Invocation canceled due to the underlying connection being closed.")),this._cleanupTimeout(),this._cleanupPingTimer(),this._connectionState===c.Disconnecting?this._completeClose(e):this._connectionState===c.Connected&&this._reconnectPolicy?this._reconnect(e):this._connectionState===c.Connected&&this._completeClose(e)}_completeClose(e){if(this._connectionStarted){this._connectionState=c.Disconnected,this._connectionStarted=!1,this._messageBuffer&&(this._messageBuffer._dispose(null!=e?e:Error("Connection closed.")),this._messageBuffer=void 0),z.isBrowser&&window.document.removeEventListener("freeze",this._freezeEventListener);try{this._closedCallbacks.forEach(t=>t.apply(this,[e]))}catch(t){this._logger.log(i.Error,`An onclose callback called with error '${e}' threw error '${t}'.`)}}}async _reconnect(e){let t=Date.now(),r=0,n=void 0!==e?e:Error("Attempting to reconnect due to a unknown error."),o=this._getNextRetryDelay(r++,0,n);if(null===o){this._logger.log(i.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),this._completeClose(e);return}if(this._connectionState=c.Reconnecting,e?this._logger.log(i.Information,`Connection reconnecting because of error '${e}'.`):this._logger.log(i.Information,"Connection reconnecting."),0!==this._reconnectingCallbacks.length){try{this._reconnectingCallbacks.forEach(t=>t.apply(this,[e]))}catch(t){this._logger.log(i.Error,`An onreconnecting callback called with error '${e}' threw error '${t}'.`)}if(this._connectionState!==c.Reconnecting)return void this._logger.log(i.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting.")}for(;null!==o;){if(this._logger.log(i.Information,`Reconnect attempt number ${r} will start in ${o} ms.`),await new Promise(e=>{this._reconnectDelayHandle=setTimeout(e,o)}),this._reconnectDelayHandle=void 0,this._connectionState!==c.Reconnecting)return void this._logger.log(i.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting.");try{if(await this._startInternal(),this._connectionState=c.Connected,this._logger.log(i.Information,"HubConnection reconnected successfully."),0!==this._reconnectedCallbacks.length)try{this._reconnectedCallbacks.forEach(e=>e.apply(this,[this.connection.connectionId]))}catch(e){this._logger.log(i.Error,`An onreconnected callback called with connectionId '${this.connection.connectionId}; threw error '${e}'.`)}return}catch(e){if(this._logger.log(i.Information,`Reconnect attempt failed because of error '${e}'.`),this._connectionState!==c.Reconnecting){this._logger.log(i.Debug,`Connection moved to the '${this._connectionState}' from the reconnecting state during reconnect attempt. Done reconnecting.`),this._connectionState===c.Disconnecting&&this._completeClose();return}n=e instanceof Error?e:Error(e.toString()),o=this._getNextRetryDelay(r++,Date.now()-t,n)}}this._logger.log(i.Information,`Reconnect retries have been exhausted after ${Date.now()-t} ms and ${r} failed attempts. Connection disconnecting.`),this._completeClose()}_getNextRetryDelay(e,t,r){try{return this._reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:t,previousRetryCount:e,retryReason:r})}catch(r){return this._logger.log(i.Error,`IRetryPolicy.nextRetryDelayInMilliseconds(${e}, ${t}) threw error '${r}'.`),null}}_cancelCallbacksWithError(e){let t=this._callbacks;this._callbacks={},Object.keys(t).forEach(r=>{let n=t[r];try{n(null,e)}catch(t){this._logger.log(i.Error,`Stream 'error' callback called with '${e}' threw error: ${O(t)}`)}})}_cleanupPingTimer(){this._pingServerHandle&&(clearTimeout(this._pingServerHandle),this._pingServerHandle=void 0)}_cleanupTimeout(){this._timeoutHandle&&clearTimeout(this._timeoutHandle)}_createInvocation(e,t,r,n){if(r)if(0!==n.length)return{target:e,arguments:t,streamIds:n,type:a.Invocation};else return{target:e,arguments:t,type:a.Invocation};{let r=this._invocationId;return(this._invocationId++,0!==n.length)?{target:e,arguments:t,invocationId:r.toString(),streamIds:n,type:a.Invocation}:{target:e,arguments:t,invocationId:r.toString(),type:a.Invocation}}}_launchStreams(e,t){if(0!==e.length)for(let r in t||(t=Promise.resolve()),e)e[r].subscribe({complete:()=>{t=t.then(()=>this._sendWithProtocol(this._createCompletionMessage(r)))},error:e=>{let n;n=e instanceof Error?e.message:e&&e.toString?e.toString():"Unknown error",t=t.then(()=>this._sendWithProtocol(this._createCompletionMessage(r,n)))},next:e=>{t=t.then(()=>this._sendWithProtocol(this._createStreamItemMessage(r,e)))}})}_replaceStreamingParams(e){let t=[],r=[];for(let n=0;n<e.length;n++){let o=e[n];if(this._isObservable(o)){let s=this._invocationId;this._invocationId++,t[s]=o,r.push(s.toString()),e.splice(n,1)}}return[t,r]}_isObservable(e){return e&&e.subscribe&&"function"==typeof e.subscribe}_createStreamInvocation(e,t,r){let n=this._invocationId;return(this._invocationId++,0!==r.length)?{target:e,arguments:t,invocationId:n.toString(),streamIds:r,type:a.StreamInvocation}:{target:e,arguments:t,invocationId:n.toString(),type:a.StreamInvocation}}_createCancelInvocation(e){return{invocationId:e,type:a.CancelInvocation}}_createStreamItemMessage(e,t){return{invocationId:e,item:t,type:a.StreamItem}}_createCompletionMessage(e,t,r){return t?{error:t,invocationId:e,type:a.Completion}:{invocationId:e,result:r,type:a.Completion}}_createCloseMessage(){return{type:a.Close}}}let es=[0,2e3,1e4,3e4,null];class ei{constructor(e){this._retryDelays=void 0!==e?[...e,null]:es}nextRetryDelayInMilliseconds(e){return this._retryDelays[e.previousRetryCount]}}class ea{}ea.Authorization="Authorization",ea.Cookie="Cookie";class ec{constructor(e,t,r){this.statusCode=e,this.statusText=t,this.content=r}}class el{get(e,t){return this.send({...t,method:"GET",url:e})}post(e,t){return this.send({...t,method:"POST",url:e})}delete(e,t){return this.send({...t,method:"DELETE",url:e})}getCookieString(e){return""}}class eh extends el{constructor(e,t){super(),this._innerClient=e,this._accessTokenFactory=t}async send(e){let t=!0;this._accessTokenFactory&&(!this._accessToken||e.url&&e.url.indexOf("/negotiate?")>0)&&(t=!1,this._accessToken=await this._accessTokenFactory()),this._setAuthorizationHeader(e);let r=await this._innerClient.send(e);return t&&401===r.statusCode&&this._accessTokenFactory?(this._accessToken=await this._accessTokenFactory(),this._setAuthorizationHeader(e),await this._innerClient.send(e)):r}_setAuthorizationHeader(e){e.headers||(e.headers={}),this._accessToken?e.headers[ea.Authorization]=`Bearer ${this._accessToken}`:this._accessTokenFactory&&e.headers[ea.Authorization]&&delete e.headers[ea.Authorization]}getCookieString(e){return this._innerClient.getCookieString(e)}}class ed extends el{constructor(t){if(super(),this._logger=t,"undefined"==typeof fetch||z.isNode){const t="function"==typeof __webpack_require__?__non_webpack_require__:e.z;this._jar=new(t("tough-cookie")).CookieJar,"undefined"==typeof fetch?this._fetchType=t("node-fetch"):this._fetchType=fetch,this._fetchType=t("fetch-cookie")(this._fetchType,this._jar)}else this._fetchType=fetch.bind("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:e.g);if("undefined"==typeof AbortController){const t="function"==typeof __webpack_require__?__non_webpack_require__:e.z;this._abortControllerType=t("abort-controller")}else this._abortControllerType=AbortController}async send(e){let t,r;if(e.abortSignal&&e.abortSignal.aborted)throw new J;if(!e.method)throw Error("No method defined.");if(!e.url)throw Error("No url defined.");let n=new this._abortControllerType;e.abortSignal&&(e.abortSignal.onabort=()=>{n.abort(),t=new J});let o=null;e.timeout&&(o=setTimeout(()=>{n.abort(),this._logger.log(i.Warning,"Timeout from HTTP request."),t=new X},e.timeout)),""===e.content&&(e.content=void 0),e.content&&(e.headers=e.headers||{},U(e.content)?e.headers["Content-Type"]="application/octet-stream":e.headers["Content-Type"]="text/plain;charset=UTF-8");try{r=await this._fetchType(e.url,{body:e.content,cache:"no-cache",credentials:!0===e.withCredentials?"include":"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",...e.headers},method:e.method,mode:"cors",redirect:"follow",signal:n.signal})}catch(e){if(t)throw t;throw this._logger.log(i.Warning,`Error from HTTP request. ${e}.`),e}finally{o&&clearTimeout(o),e.abortSignal&&(e.abortSignal.onabort=null)}if(!r.ok)throw new K(await eg(r,"text")||r.statusText,r.status);let s=eg(r,e.responseType),a=await s;return new ec(r.status,r.statusText,a)}getCookieString(e){let t="";return z.isNode&&this._jar&&this._jar.getCookies(e,(e,r)=>t=r.join("; ")),t}}function eg(e,t){let r;switch(t){case"arraybuffer":r=e.arrayBuffer();break;case"text":default:r=e.text();break;case"blob":case"document":case"json":throw Error(`${t} is not supported.`)}return r}class eu extends el{constructor(e){super(),this._logger=e}send(e){return e.abortSignal&&e.abortSignal.aborted?Promise.reject(new J):e.method?e.url?new Promise((t,r)=>{let n=new XMLHttpRequest;n.open(e.method,e.url,!0),n.withCredentials=void 0===e.withCredentials||e.withCredentials,n.setRequestHeader("X-Requested-With","XMLHttpRequest"),""===e.content&&(e.content=void 0),e.content&&(U(e.content)?n.setRequestHeader("Content-Type","application/octet-stream"):n.setRequestHeader("Content-Type","text/plain;charset=UTF-8"));let o=e.headers;o&&Object.keys(o).forEach(e=>{n.setRequestHeader(e,o[e])}),e.responseType&&(n.responseType=e.responseType),e.abortSignal&&(e.abortSignal.onabort=()=>{n.abort(),r(new J)}),e.timeout&&(n.timeout=e.timeout),n.onload=()=>{e.abortSignal&&(e.abortSignal.onabort=null),n.status>=200&&n.status<300?t(new ec(n.status,n.statusText,n.response||n.responseText)):r(new K(n.response||n.responseText||n.statusText,n.status))},n.onerror=()=>{this._logger.log(i.Warning,`Error from HTTP request. ${n.status}: ${n.statusText}.`),r(new K(n.statusText,n.status))},n.ontimeout=()=>{this._logger.log(i.Warning,"Timeout from HTTP request."),r(new X)},n.send(e.content)}):Promise.reject(Error("No url defined.")):Promise.reject(Error("No method defined."))}}class ep extends el{constructor(e){if(super(),"undefined"!=typeof fetch||z.isNode)this._httpClient=new ed(e);else if("undefined"!=typeof XMLHttpRequest)this._httpClient=new eu(e);else throw Error("No usable HttpClient found.")}send(e){return e.abortSignal&&e.abortSignal.aborted?Promise.reject(new J):e.method?e.url?this._httpClient.send(e):Promise.reject(Error("No url defined.")):Promise.reject(Error("No method defined."))}getCookieString(e){return this._httpClient.getCookieString(e)}}(o=l||(l={}))[o.None=0]="None",o[o.WebSockets=1]="WebSockets",o[o.ServerSentEvents=2]="ServerSentEvents",o[o.LongPolling=4]="LongPolling",(s=h||(h={}))[s.Text=1]="Text",s[s.Binary=2]="Binary";class em{constructor(){this._isAborted=!1,this.onabort=null}abort(){!this._isAborted&&(this._isAborted=!0,this.onabort&&this.onabort())}get signal(){return this}get aborted(){return this._isAborted}}class ef{get pollAborted(){return this._pollAbort.aborted}constructor(e,t,r){this._httpClient=e,this._logger=t,this._pollAbort=new em,this._options=r,this._running=!1,this.onreceive=null,this.onclose=null}async connect(e,t){if(F.isRequired(e,"url"),F.isRequired(t,"transferFormat"),F.isIn(t,h,"transferFormat"),this._url=e,this._logger.log(i.Trace,"(LongPolling transport) Connecting."),t===h.Binary&&"undefined"!=typeof XMLHttpRequest&&"string"!=typeof new XMLHttpRequest().responseType)throw Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");let[r,n]=q(),o={[r]:n,...this._options.headers},s={abortSignal:this._pollAbort.signal,headers:o,timeout:1e5,withCredentials:this._options.withCredentials};t===h.Binary&&(s.responseType="arraybuffer");let a=`${e}&_=${Date.now()}`;this._logger.log(i.Trace,`(LongPolling transport) polling: ${a}.`);let c=await this._httpClient.get(a,s);200!==c.statusCode?(this._logger.log(i.Error,`(LongPolling transport) Unexpected response code: ${c.statusCode}.`),this._closeError=new K(c.statusText||"",c.statusCode),this._running=!1):this._running=!0,this._receiving=this._poll(this._url,s)}async _poll(e,t){try{for(;this._running;)try{let r=`${e}&_=${Date.now()}`;this._logger.log(i.Trace,`(LongPolling transport) polling: ${r}.`);let n=await this._httpClient.get(r,t);204===n.statusCode?(this._logger.log(i.Information,"(LongPolling transport) Poll terminated by server."),this._running=!1):200!==n.statusCode?(this._logger.log(i.Error,`(LongPolling transport) Unexpected response code: ${n.statusCode}.`),this._closeError=new K(n.statusText||"",n.statusCode),this._running=!1):n.content?(this._logger.log(i.Trace,`(LongPolling transport) data received. ${W(n.content,this._options.logMessageContent)}.`),this.onreceive&&this.onreceive(n.content)):this._logger.log(i.Trace,"(LongPolling transport) Poll timed out, reissuing.")}catch(e){this._running?e instanceof X?this._logger.log(i.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this._closeError=e,this._running=!1):this._logger.log(i.Trace,`(LongPolling transport) Poll errored after shutdown: ${e.message}`)}}finally{this._logger.log(i.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this._raiseOnClose()}}async send(e){return this._running?B(this._logger,"LongPolling",this._httpClient,this._url,e,this._options):Promise.reject(Error("Cannot send until the transport is connected"))}async stop(){this._logger.log(i.Trace,"(LongPolling transport) Stopping polling."),this._running=!1,this._pollAbort.abort();try{let e;await this._receiving,this._logger.log(i.Trace,`(LongPolling transport) sending DELETE request to ${this._url}.`);let t={},[r,n]=q();t[r]=n;let o={headers:{...t,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials};try{await this._httpClient.delete(this._url,o)}catch(t){e=t}e?e instanceof K&&(404===e.statusCode?this._logger.log(i.Trace,"(LongPolling transport) A 404 response was returned from sending a DELETE request."):this._logger.log(i.Trace,`(LongPolling transport) Error sending a DELETE request: ${e}`)):this._logger.log(i.Trace,"(LongPolling transport) DELETE request accepted.")}finally{this._logger.log(i.Trace,"(LongPolling transport) Stop finished."),this._raiseOnClose()}}_raiseOnClose(){if(this.onclose){let e="(LongPolling transport) Firing onclose event.";this._closeError&&(e+=" Error: "+this._closeError),this._logger.log(i.Trace,e),this.onclose(this._closeError)}}}class e_{constructor(e,t,r,n){this._httpClient=e,this._accessToken=t,this._logger=r,this._options=n,this.onreceive=null,this.onclose=null}async connect(e,t){return F.isRequired(e,"url"),F.isRequired(t,"transferFormat"),F.isIn(t,h,"transferFormat"),this._logger.log(i.Trace,"(SSE transport) Connecting."),this._url=e,this._accessToken&&(e+=(0>e.indexOf("?")?"?":"&")+`access_token=${encodeURIComponent(this._accessToken)}`),new Promise((r,n)=>{let o,s=!1;if(t!==h.Text)return void n(Error("The Server-Sent Events transport only supports the 'Text' transfer format"));if(z.isBrowser||z.isWebWorker)o=new this._options.EventSource(e,{withCredentials:this._options.withCredentials});else{let t=this._httpClient.getCookieString(e),r={};r.Cookie=t;let[n,s]=q();r[n]=s,o=new this._options.EventSource(e,{withCredentials:this._options.withCredentials,headers:{...r,...this._options.headers}})}try{o.onmessage=e=>{if(this.onreceive)try{this._logger.log(i.Trace,`(SSE transport) data received. ${W(e.data,this._options.logMessageContent)}.`),this.onreceive(e.data)}catch(e){this._close(e);return}},o.onerror=e=>{s?this._close():n(Error("EventSource failed to connect. The connection could not be found on the server, either the connection ID is not present on the server, or a proxy is refusing/buffering the connection. If you have multiple servers check that sticky sessions are enabled."))},o.onopen=()=>{this._logger.log(i.Information,`SSE connected to ${this._url}`),this._eventSource=o,s=!0,r()}}catch(e){n(e);return}})}async send(e){return this._eventSource?B(this._logger,"SSE",this._httpClient,this._url,e,this._options):Promise.reject(Error("Cannot send until the transport is connected"))}stop(){return this._close(),Promise.resolve()}_close(e){this._eventSource&&(this._eventSource.close(),this._eventSource=void 0,this.onclose&&this.onclose(e))}}class ey{constructor(e,t,r,n,o,s){this._logger=r,this._accessTokenFactory=t,this._logMessageContent=n,this._webSocketConstructor=o,this._httpClient=e,this.onreceive=null,this.onclose=null,this._headers=s}async connect(e,t){let r;return F.isRequired(e,"url"),F.isRequired(t,"transferFormat"),F.isIn(t,h,"transferFormat"),this._logger.log(i.Trace,"(WebSockets transport) Connecting."),this._accessTokenFactory&&(r=await this._accessTokenFactory()),new Promise((n,o)=>{let s;e=e.replace(/^http/,"ws");let a=this._httpClient.getCookieString(e),c=!1;if(z.isNode||z.isReactNative){let t={},[n,o]=q();t[n]=o,r&&(t[ea.Authorization]=`Bearer ${r}`),a&&(t[ea.Cookie]=a),s=new this._webSocketConstructor(e,void 0,{headers:{...t,...this._headers}})}else r&&(e+=(0>e.indexOf("?")?"?":"&")+`access_token=${encodeURIComponent(r)}`);s||(s=new this._webSocketConstructor(e)),t===h.Binary&&(s.binaryType="arraybuffer"),s.onopen=t=>{this._logger.log(i.Information,`WebSocket connected to ${e}.`),this._webSocket=s,c=!0,n()},s.onerror=e=>{let t=null;t="undefined"!=typeof ErrorEvent&&e instanceof ErrorEvent?e.error:"There was an error with the transport",this._logger.log(i.Information,`(WebSockets transport) ${t}.`)},s.onmessage=e=>{if(this._logger.log(i.Trace,`(WebSockets transport) data received. ${W(e.data,this._logMessageContent)}.`),this.onreceive)try{this.onreceive(e.data)}catch(e){this._close(e);return}},s.onclose=e=>{if(c)this._close(e);else o(Error("undefined"!=typeof ErrorEvent&&e instanceof ErrorEvent?e.error:"WebSocket failed to connect. The connection could not be found on the server, either the endpoint may not be a SignalR endpoint, the connection ID is not present on the server, or there is a proxy blocking WebSockets. If you have multiple servers check that sticky sessions are enabled."))}})}send(e){return this._webSocket&&this._webSocket.readyState===this._webSocketConstructor.OPEN?(this._logger.log(i.Trace,`(WebSockets transport) sending data. ${W(e,this._logMessageContent)}.`),this._webSocket.send(e),Promise.resolve()):Promise.reject("WebSocket is not in the OPEN state")}stop(){return this._webSocket&&this._close(void 0),Promise.resolve()}_close(e){this._webSocket&&(this._webSocket.onclose=()=>{},this._webSocket.onmessage=()=>{},this._webSocket.onerror=()=>{},this._webSocket.close(),this._webSocket=void 0),this._logger.log(i.Trace,"(WebSockets transport) socket closed."),this.onclose&&(this._isCloseEvent(e)&&(!1===e.wasClean||1e3!==e.code)?this.onclose(Error(`WebSocket closed with status code: ${e.code} (${e.reason||"no reason given"}).`)):e instanceof Error?this.onclose(e):this.onclose())}_isCloseEvent(e){return e&&"boolean"==typeof e.wasClean&&"number"==typeof e.code}}class ew{constructor(t,r={}){if(this._stopPromiseResolver=()=>{},this.features={},this._negotiateVersion=1,F.isRequired(t,"url"),this._logger=function(e){return void 0===e?new L(i.Information):null===e?N.instance:void 0!==e.log?e:new L(e)}(r.logger),this.baseUrl=this._resolveUrl(t),(r=r||{}).logMessageContent=void 0!==r.logMessageContent&&r.logMessageContent,"boolean"==typeof r.withCredentials||void 0===r.withCredentials)r.withCredentials=void 0===r.withCredentials||r.withCredentials;else throw Error("withCredentials option was not a 'boolean' or 'undefined' value");r.timeout=void 0===r.timeout?1e5:r.timeout;let n=null,o=null;if(z.isNode&&1){const t="function"==typeof __webpack_require__?__non_webpack_require__:e.z;n=t("ws"),o=t("eventsource")}z.isNode||"undefined"==typeof WebSocket||r.WebSocket?z.isNode&&!r.WebSocket&&n&&(r.WebSocket=n):r.WebSocket=WebSocket,z.isNode||"undefined"==typeof EventSource||r.EventSource?z.isNode&&!r.EventSource&&void 0!==o&&(r.EventSource=o):r.EventSource=EventSource,this._httpClient=new eh(r.httpClient||new ep(this._logger),r.accessTokenFactory),this._connectionState="Disconnected",this._connectionStarted=!1,this._options=r,this.onreceive=null,this.onclose=null}async start(e){if(e=e||h.Binary,F.isIn(e,h,"transferFormat"),this._logger.log(i.Debug,`Starting connection with transfer format '${h[e]}'.`),"Disconnected"!==this._connectionState)return Promise.reject(Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."));if(this._connectionState="Connecting",this._startInternalPromise=this._startInternal(e),await this._startInternalPromise,"Disconnecting"===this._connectionState){let e="Failed to start the HttpConnection before stop() was called.";return this._logger.log(i.Error,e),await this._stopPromise,Promise.reject(new J(e))}if("Connected"!==this._connectionState){let e="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!";return this._logger.log(i.Error,e),Promise.reject(new J(e))}this._connectionStarted=!0}send(e){return"Connected"!==this._connectionState?Promise.reject(Error("Cannot send data if the connection is not in the 'Connected' State.")):(this._sendQueue||(this._sendQueue=new eS(this.transport)),this._sendQueue.send(e))}async stop(e){return"Disconnected"===this._connectionState?(this._logger.log(i.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnected state.`),Promise.resolve()):"Disconnecting"===this._connectionState?(this._logger.log(i.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnecting state.`),this._stopPromise):void(this._connectionState="Disconnecting",this._stopPromise=new Promise(e=>{this._stopPromiseResolver=e}),await this._stopInternal(e),await this._stopPromise)}async _stopInternal(e){this._stopError=e;try{await this._startInternalPromise}catch(e){}if(this.transport){try{await this.transport.stop()}catch(e){this._logger.log(i.Error,`HttpConnection.transport.stop() threw error '${e}'.`),this._stopConnection()}this.transport=void 0}else this._logger.log(i.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed.")}async _startInternal(e){let t=this.baseUrl;this._accessTokenFactory=this._options.accessTokenFactory,this._httpClient._accessTokenFactory=this._accessTokenFactory;try{if(this._options.skipNegotiation)if(this._options.transport===l.WebSockets)this.transport=this._constructTransport(l.WebSockets),await this._startTransport(t,e);else throw Error("Negotiation can only be skipped when using the WebSocket transport directly.");else{let r=null,n=0;do{if(r=await this._getNegotiationResponse(t),"Disconnecting"===this._connectionState||"Disconnected"===this._connectionState)throw new J("The connection was stopped during negotiation.");if(r.error)throw Error(r.error);if(r.ProtocolVersion)throw Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");if(r.url&&(t=r.url),r.accessToken){let e=r.accessToken;this._accessTokenFactory=()=>e,this._httpClient._accessToken=e,this._httpClient._accessTokenFactory=void 0}n++}while(r.url&&n<100)if(100===n&&r.url)throw Error("Negotiate redirection limit exceeded.");await this._createTransport(t,this._options.transport,r,e)}this.transport instanceof ef&&(this.features.inherentKeepAlive=!0),"Connecting"===this._connectionState&&(this._logger.log(i.Debug,"The HttpConnection connected successfully."),this._connectionState="Connected")}catch(e){return this._logger.log(i.Error,"Failed to start the connection: "+e),this._connectionState="Disconnected",this.transport=void 0,this._stopPromiseResolver(),Promise.reject(e)}}async _getNegotiationResponse(e){let t={},[r,n]=q();t[r]=n;let o=this._resolveNegotiateUrl(e);this._logger.log(i.Debug,`Sending negotiation request: ${o}.`);try{let e=await this._httpClient.post(o,{content:"",headers:{...t,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials});if(200!==e.statusCode)return Promise.reject(Error(`Unexpected status code returned from negotiate '${e.statusCode}'`));let r=JSON.parse(e.content);if((!r.negotiateVersion||r.negotiateVersion<1)&&(r.connectionToken=r.connectionId),r.useStatefulReconnect&&!0!==this._options._useStatefulReconnect)return Promise.reject(new Z("Client didn't negotiate Stateful Reconnect but the server did."));return r}catch(t){let e="Failed to complete negotiation with the server: "+t;return t instanceof K&&404===t.statusCode&&(e+=" Either this is not a SignalR endpoint or there is a proxy blocking the connection."),this._logger.log(i.Error,e),Promise.reject(new Z(e))}}_createConnectUrl(e,t){return t?e+(-1===e.indexOf("?")?"?":"&")+`id=${t}`:e}async _createTransport(e,t,r,n){let o=this._createConnectUrl(e,r.connectionToken);if(this._isITransport(t)){this._logger.log(i.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=t,await this._startTransport(o,n),this.connectionId=r.connectionId;return}let s=[],a=r.availableTransports||[],c=r;for(let r of a){let a=this._resolveTransportOrError(r,t,n,(null==c?void 0:c.useStatefulReconnect)===!0);if(a instanceof Error)s.push(`${r.transport} failed:`),s.push(a);else if(this._isITransport(a)){if(this.transport=a,!c){try{c=await this._getNegotiationResponse(e)}catch(e){return Promise.reject(e)}o=this._createConnectUrl(e,c.connectionToken)}try{await this._startTransport(o,n),this.connectionId=c.connectionId;return}catch(e){if(this._logger.log(i.Error,`Failed to start the transport '${r.transport}': ${e}`),c=void 0,s.push(new Y(`${r.transport} failed: ${e}`,l[r.transport])),"Connecting"!==this._connectionState){let e="Failed to select transport before stop() was called.";return this._logger.log(i.Debug,e),Promise.reject(new J(e))}}}}return s.length>0?Promise.reject(new ee(`Unable to connect to the server with any of the available transports. ${s.join(" ")}`,s)):Promise.reject(Error("None of the transports supported by the client are supported by the server."))}_constructTransport(e){switch(e){case l.WebSockets:if(!this._options.WebSocket)throw Error("'WebSocket' is not supported in your environment.");return new ey(this._httpClient,this._accessTokenFactory,this._logger,this._options.logMessageContent,this._options.WebSocket,this._options.headers||{});case l.ServerSentEvents:if(!this._options.EventSource)throw Error("'EventSource' is not supported in your environment.");return new e_(this._httpClient,this._httpClient._accessToken,this._logger,this._options);case l.LongPolling:return new ef(this._httpClient,this._logger,this._options);default:throw Error(`Unknown transport: ${e}.`)}}_startTransport(e,t){return this.transport.onreceive=this.onreceive,this.features.reconnect?this.transport.onclose=async r=>{let n=!1;if(!this.features.reconnect)return void this._stopConnection(r);try{this.features.disconnected(),await this.transport.connect(e,t),await this.features.resend()}catch{n=!0}n&&this._stopConnection(r)}:this.transport.onclose=e=>this._stopConnection(e),this.transport.connect(e,t)}_resolveTransportOrError(e,t,r,n){var o,s;let a=l[e.transport];if(null==a)return this._logger.log(i.Debug,`Skipping transport '${e.transport}' because it is not supported by this client.`),Error(`Skipping transport '${e.transport}' because it is not supported by this client.`);if(o=t,s=a,o&&(s&o)==0)return this._logger.log(i.Debug,`Skipping transport '${l[a]}' because it was disabled by the client.`),new Q(`'${l[a]}' is disabled by the client.`,a);if(!(e.transferFormats.map(e=>h[e]).indexOf(r)>=0))return this._logger.log(i.Debug,`Skipping transport '${l[a]}' because it does not support the requested transfer format '${h[r]}'.`),Error(`'${l[a]}' does not support ${h[r]}.`);if(a===l.WebSockets&&!this._options.WebSocket||a===l.ServerSentEvents&&!this._options.EventSource)return this._logger.log(i.Debug,`Skipping transport '${l[a]}' because it is not supported in your environment.'`),new G(`'${l[a]}' is not supported in your environment.`,a);this._logger.log(i.Debug,`Selecting transport '${l[a]}'.`);try{return this.features.reconnect=a===l.WebSockets?n:void 0,this._constructTransport(a)}catch(e){return e}}_isITransport(e){return e&&"object"==typeof e&&"connect"in e}_stopConnection(e){if(this._logger.log(i.Debug,`HttpConnection.stopConnection(${e}) called while in state ${this._connectionState}.`),this.transport=void 0,e=this._stopError||e,this._stopError=void 0,"Disconnected"===this._connectionState)return void this._logger.log(i.Debug,`Call to HttpConnection.stopConnection(${e}) was ignored because the connection is already in the disconnected state.`);if("Connecting"===this._connectionState)throw this._logger.log(i.Warning,`Call to HttpConnection.stopConnection(${e}) was ignored because the connection is still in the connecting state.`),Error(`HttpConnection.stopConnection(${e}) was called while the connection is still in the connecting state.`);if("Disconnecting"===this._connectionState&&this._stopPromiseResolver(),e?this._logger.log(i.Error,`Connection disconnected with error '${e}'.`):this._logger.log(i.Information,"Connection disconnected."),this._sendQueue&&(this._sendQueue.stop().catch(e=>{this._logger.log(i.Error,`TransportSendQueue.stop() threw error '${e}'.`)}),this._sendQueue=void 0),this.connectionId=void 0,this._connectionState="Disconnected",this._connectionStarted){this._connectionStarted=!1;try{this.onclose&&this.onclose(e)}catch(t){this._logger.log(i.Error,`HttpConnection.onclose(${e}) threw error '${t}'.`)}}}_resolveUrl(e){if(0===e.lastIndexOf("https://",0)||0===e.lastIndexOf("http://",0))return e;if(!z.isBrowser)throw Error(`Cannot resolve '${e}'.`);let t=window.document.createElement("a");return t.href=e,this._logger.log(i.Information,`Normalizing '${e}' to '${t.href}'.`),t.href}_resolveNegotiateUrl(e){let t=new URL(e);t.pathname.endsWith("/")?t.pathname+="negotiate":t.pathname+="/negotiate";let r=new URLSearchParams(t.searchParams);return r.has("negotiateVersion")||r.append("negotiateVersion",this._negotiateVersion.toString()),r.has("useStatefulReconnect")?"true"===r.get("useStatefulReconnect")&&(this._options._useStatefulReconnect=!0):!0===this._options._useStatefulReconnect&&r.append("useStatefulReconnect","true"),t.search=r.toString(),t.toString()}}class eS{constructor(e){this._transport=e,this._buffer=[],this._executing=!0,this._sendBufferedData=new ev,this._transportResult=new ev,this._sendLoopPromise=this._sendLoop()}send(e){return this._bufferData(e),this._transportResult||(this._transportResult=new ev),this._transportResult.promise}stop(){return this._executing=!1,this._sendBufferedData.resolve(),this._sendLoopPromise}_bufferData(e){if(this._buffer.length&&typeof this._buffer[0]!=typeof e)throw Error(`Expected data to be of type ${typeof this._buffer} but was of type ${typeof e}`);this._buffer.push(e),this._sendBufferedData.resolve()}async _sendLoop(){for(;;){if(await this._sendBufferedData.promise,!this._executing){this._transportResult&&this._transportResult.reject("Connection stopped.");break}this._sendBufferedData=new ev;let e=this._transportResult;this._transportResult=void 0;let t="string"==typeof this._buffer[0]?this._buffer.join(""):eS._concatBuffers(this._buffer);this._buffer.length=0;try{await this._transport.send(t),e.resolve()}catch(t){e.reject(t)}}}static _concatBuffers(e){let t=new Uint8Array(e.map(e=>e.byteLength).reduce((e,t)=>e+t)),r=0;for(let n of e)t.set(new Uint8Array(n),r),r+=n.byteLength;return t.buffer}}class ev{constructor(){this.promise=new Promise((e,t)=>([this._resolver,this._rejecter]=[e,t]))}resolve(){this._resolver()}reject(e){this._rejecter(e)}}class eb{constructor(){this.name="json",this.version=2,this.transferFormat=h.Text}parseMessages(e,t){if("string"!=typeof e)throw Error("Invalid input for JSON hub protocol. Expected a string.");if(!e)return[];null===t&&(t=N.instance);let r=$.parse(e),n=[];for(let e of r){let r=JSON.parse(e);if("number"!=typeof r.type)throw Error("Invalid payload.");switch(r.type){case a.Invocation:this._isInvocationMessage(r);break;case a.StreamItem:this._isStreamItemMessage(r);break;case a.Completion:this._isCompletionMessage(r);break;case a.Ping:case a.Close:break;case a.Ack:this._isAckMessage(r);break;case a.Sequence:this._isSequenceMessage(r);break;default:t.log(i.Information,"Unknown message type '"+r.type+"' ignored.");continue}n.push(r)}return n}writeMessage(e){return $.write(JSON.stringify(e))}_isInvocationMessage(e){this._assertNotEmptyString(e.target,"Invalid payload for Invocation message."),void 0!==e.invocationId&&this._assertNotEmptyString(e.invocationId,"Invalid payload for Invocation message.")}_isStreamItemMessage(e){if(this._assertNotEmptyString(e.invocationId,"Invalid payload for StreamItem message."),void 0===e.item)throw Error("Invalid payload for StreamItem message.")}_isCompletionMessage(e){if(e.result&&e.error)throw Error("Invalid payload for Completion message.");!e.result&&e.error&&this._assertNotEmptyString(e.error,"Invalid payload for Completion message."),this._assertNotEmptyString(e.invocationId,"Invalid payload for Completion message.")}_isAckMessage(e){if("number"!=typeof e.sequenceId)throw Error("Invalid SequenceId for Ack message.")}_isSequenceMessage(e){if("number"!=typeof e.sequenceId)throw Error("Invalid SequenceId for Sequence message.")}_assertNotEmptyString(e,t){if("string"!=typeof e||""===e)throw Error(t)}}let ex={trace:i.Trace,debug:i.Debug,info:i.Information,information:i.Information,warn:i.Warning,warning:i.Warning,error:i.Error,critical:i.Critical,none:i.None};class eC{configureLogging(e){if(F.isRequired(e,"logging"),void 0!==e.log)this.logger=e;else if("string"==typeof e){let t=function(e){let t=ex[e.toLowerCase()];if(void 0!==t)return t;throw Error(`Unknown log level: ${e}`)}(e);this.logger=new L(t)}else this.logger=new L(e);return this}withUrl(e,t){return F.isRequired(e,"url"),F.isNotEmpty(e,"url"),this.url=e,"object"==typeof t?this.httpConnectionOptions={...this.httpConnectionOptions,...t}:this.httpConnectionOptions={...this.httpConnectionOptions,transport:t},this}withHubProtocol(e){return F.isRequired(e,"protocol"),this.protocol=e,this}withAutomaticReconnect(e){if(this.reconnectPolicy)throw Error("A reconnectPolicy has already been set.");return e?Array.isArray(e)?this.reconnectPolicy=new ei(e):this.reconnectPolicy=e:this.reconnectPolicy=new ei,this}withServerTimeout(e){return F.isRequired(e,"milliseconds"),this._serverTimeoutInMilliseconds=e,this}withKeepAliveInterval(e){return F.isRequired(e,"milliseconds"),this._keepAliveIntervalInMilliseconds=e,this}withStatefulReconnect(e){return void 0===this.httpConnectionOptions&&(this.httpConnectionOptions={}),this.httpConnectionOptions._useStatefulReconnect=!0,this._statefulReconnectBufferSize=null==e?void 0:e.bufferSize,this}build(){let e=this.httpConnectionOptions||{};if(void 0===e.logger&&(e.logger=this.logger),!this.url)throw Error("The 'HubConnectionBuilder.withUrl' method must be called before building the connection.");let t=new ew(this.url,e);return eo.create(t,this.logger||N.instance,this.protocol||new eb,this.reconnectPolicy,this._serverTimeoutInMilliseconds,this._keepAliveIntervalInMilliseconds,this._statefulReconnectBufferSize)}}class eI{connection=null;reconnectAttempts=0;maxReconnectAttempts=5;listeners=new Map;async connect(){if(this.connection?.state!==c.Connected)try{let e="",t="",r="Administrator",n="";try{let o=await fetch("/api/auth/session"),s=await o.json();e=s?.user?.email||"",t=s?.user?.name||e,r=s?.user?.role||s?.user?.roles?.[0]||"Administrator",e&&(n=this.generateUserIdFromEmail(e))}catch(e){console.warn("[SignalR] Failed to get session:",e)}this.connection=new eC().withUrl("/api/proxy/messaging/messageHub",{accessTokenFactory:async()=>"",headers:{"X-User-Email":e,"X-User-Name":t,"X-User-Role":r,"X-User-Id":n}}).withAutomaticReconnect({nextRetryDelayInMilliseconds:e=>e.previousRetryCount<this.maxReconnectAttempts?Math.min(1e3*Math.pow(2,e.previousRetryCount),3e4):null}).configureLogging(i.Information).build(),this.setupEventHandlers(),await this.connection.start(),console.log("[SignalR] Connected to messaging hub"),this.reconnectAttempts=0}catch(e){throw console.error("[SignalR] Connection error:",e),this.reconnectAttempts++,e}}setupEventHandlers(){this.connection&&(this.connection.on("ReceiveMessage",e=>{console.log("[SignalR] Received message:",e),this.notifyListeners("ReceiveMessage",e)}),this.connection.on("MessageSent",e=>{console.log("[SignalR] Message sent:",e),this.notifyListeners("MessageSent",e)}),this.connection.on("MessageError",e=>{console.error("[SignalR] Message error:",e),this.notifyListeners("MessageError",e)}),this.connection.on("UserTyping",e=>{this.notifyListeners("UserTyping",e)}),this.connection.on("MessageRead",e=>{this.notifyListeners("MessageRead",e)}),this.connection.onreconnecting(e=>{console.warn("[SignalR] Reconnecting...",e),this.notifyListeners("Reconnecting",e)}),this.connection.onreconnected(e=>{console.log("[SignalR] Reconnected:",e),this.notifyListeners("Reconnected",e)}),this.connection.onclose(e=>{console.error("[SignalR] Connection closed:",e),this.notifyListeners("ConnectionClosed",e)}))}async disconnect(){this.connection&&(await this.connection.stop(),this.connection=null,this.listeners.clear(),console.log("[SignalR] Disconnected"))}async joinThread(e){if(this.connection?.state===c.Connected){if(!e||"00000000-0000-0000-0000-000000000000"===e)return void console.warn("[SignalR] Invalid threadId provided to JoinThread:",e);try{if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e))return void console.warn("[SignalR] threadId is not a valid GUID:",e);await this.connection.invoke("JoinThread",e),console.log("[SignalR] Joined thread:",e)}catch(t){throw console.error("[SignalR] Failed to join thread:",e,t),t}}}async leaveThread(e){this.connection?.state===c.Connected&&await this.connection.invoke("LeaveThread",e)}async sendTypingIndicator(e){this.connection?.state===c.Connected&&await this.connection.invoke("UserTyping",e)}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{this.listeners.get(e)?.delete(t)}}notifyListeners(e,t){let r=this.listeners.get(e);r&&r.forEach(r=>{try{r(t)}catch(t){console.error(`[SignalR] Error in listener for ${e}:`,t)}})}isConnected(){return this.connection?.state===c.Connected}getConnectionState(){return this.connection?.state||c.Disconnected}generateUserIdFromEmail(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t&=t;return Math.abs(t).toString()}}let ek=new eI;class eT{static instance;permission="default";constructor(){this.permission=Notification.permission}static getInstance(){return eT.instance||(eT.instance=new eT),eT.instance}async requestPermission(){if(!("Notification"in window))return console.warn("[PushNotifications] This browser does not support notifications"),!1;if("granted"===this.permission)return!0;if("denied"===this.permission)return console.warn("[PushNotifications] Notification permission denied"),!1;let e=await Notification.requestPermission();return this.permission=e,"granted"===e}async showNotification(e,t={}){!("Notification"in window)||("granted"===this.permission||await this.requestPermission())&&new Notification(e,{icon:"/mukuru-logo.png",badge:"/mukuru-logo.png",tag:"message",requireInteraction:!1,...t})}async showMessageNotification(e,t,r){await this.showNotification(`New message from ${e}`,{body:t.length>100?t.substring(0,100)+"...":t,tag:`message-${r||"new"}`,data:{threadId:r},requireInteraction:!1})}getPermission(){return this.permission}isSupported(){return"Notification"in window}}let ej=eT.getInstance();async function eE(e,t,r,n){if(!n)try{let e=await fetch("/api/auth/session"),t=await e.json();n=t?.user?.email||"admin@mukuru.com"}catch{n="admin@mukuru.com"}let o="";if(n){let e=n.toLowerCase(),t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t&=t;let r=Math.abs(t).toString(16).padStart(32,"0");o=`${r.substring(0,8)}-${r.substring(8,12)}-${r.substring(12,16)}-${r.substring(16,20)}-${r.substring(20,32)}`}let s=new FormData;s.append("file",t),s.append("caseId",e),s.append("partnerId",o),s.append("type","99"),r&&s.append("description",r),n&&s.append("uploadedBy",n);let i=await fetch("/api/proxy/api/v1/documents/upload",{method:"POST",body:s});if(!i.ok){let e=await i.text();throw Error(`Document upload failed: ${i.status} - ${e}`)}let a=await i.json(),c="";if(a.storageKey)try{let e=await fetch(`/api/proxy/api/v1/documents/download/${encodeURIComponent(a.storageKey)}`,{method:"GET"});if(e.ok){let t=await e.json();c=t.url||t.downloadUrl||""}}catch(e){console.warn("Failed to get download URL:",e)}return{documentId:a.documentId||a.id||"",documentNumber:a.documentNumber||"",wasDuplicate:a.wasDuplicate||!1,existingDocumentId:a.existingDocumentId,storageKey:a.storageKey||"",storageUrl:c}}var eR=e.i(778497),eP=e.i(522016);function eM(){let[t,r]=(0,E.useState)([]),[n,o]=(0,E.useState)(null),[s,i]=(0,E.useState)([]),[a,c]=(0,E.useState)(!0),[l,h]=(0,E.useState)(!1),[P,M]=(0,E.useState)(null),[A,$]=(0,E.useState)(0),[N,F]=(0,E.useState)(""),[z,W]=(0,E.useState)("ALL"),[U,B]=(0,E.useState)("ALL"),[H,L]=(0,E.useState)(!1),[q,O]=(0,E.useState)(!1),[V,K]=(0,E.useState)(""),[X,J]=(0,E.useState)(!1),[G,Q]=(0,E.useState)({applicationId:"",content:"",receiverId:""}),[Y,Z]=(0,E.useState)(!1),[ee,et]=(0,E.useState)(!1),[er,en]=(0,E.useState)({}),[eo,es]=(0,E.useState)(!1),[ei,ea]=(0,E.useState)(null),[ec,el]=(0,E.useState)(null),[eh,ed]=(0,E.useState)([]),[eg,eu]=(0,E.useState)(!1),[ep,em]=(0,E.useState)({}),ef=(0,E.useRef)(null),e_=(0,E.useRef)(null),ey=(0,E.useRef)(null);(0,E.useEffect)(()=>{(async()=>{try{await ek.connect(),es(!0);let e=ek.on("ReceiveMessage",async e=>{if(eR.logger.debug("[Admin Messages] Received SignalR message",{messageId:e.id}),document.hidden||!n||e.threadId!==n.id)try{await ej.showMessageNotification(e.senderName||"Admin",e.content||"New message",e.threadId)}catch(e){eR.logger.error(e,"[Messages] Failed to show notification",{tags:{error_type:"notification_error"}})}if(n&&e.threadId===n.id){let t=(e.senderName||"").toLowerCase(),r=(e.senderEmail||e.senderId||"").toLowerCase(),o=t.includes("@mukuru.com")||r.includes("@mukuru.com")||"Admin"===e.senderRole||"ComplianceManager"===e.senderRole,s={id:e.id,sender:e.senderName,senderType:o?"ADMIN":"PARTNER",subject:eb(n),content:e.content,timestamp:e.sentAt,applicationId:e.applicationId||n.applicationId,attachments:e.attachments||[],isRead:!1,isStarred:!1,priority:ex({content:e.content}),threadId:e.threadId};i(t=>t.some(t=>t.id===e.id)?t:[...t,s].sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime())),setTimeout(()=>{ef.current&&ef.current.scrollIntoView({behavior:"smooth"})},100),setTimeout(async()=>{try{await ev(n.id)}catch(e){eR.logger.error(e,"[Admin Messages] Failed to reload messages after SignalR update",{tags:{error_type:"messages_reload_error"}})}},500)}ew(),eS()}),t=ek.on("MessageSent",e=>{n&&e.threadId===n.id&&ev(n.id),ew(),eS()}),r=ek.on("UserTyping",e=>{n&&e.threadId===n.id&&(en(t=>({...t,[e.threadId]:{userName:e.userName}})),e_.current&&clearTimeout(e_.current),e_.current=setTimeout(()=>{en(t=>{let r={...t};return delete r[e.threadId],r})},3e3))}),o=ek.on("MessageRead",e=>{i(t=>t.map(t=>t.id===e?{...t,isRead:!0}:t))});return()=>{e(),t(),r(),o(),ek.disconnect()}}catch(e){eR.logger.error(e,"[Messages] Failed to connect SignalR",{tags:{error_type:"signalr_connection_error"}}),es(!1)}})()},[]),(0,E.useEffect)(()=>{if(n&&eo&&n.id){if(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(n.id)&&"00000000-0000-0000-0000-000000000000"!==n.id)return ek.joinThread(n.id).catch(e=>{eR.logger.error(e,"[Messages] Failed to join thread",{tags:{error_type:"thread_join_error"}})}),()=>{ek.leaveThread(n.id).catch(e=>{eR.logger.error(e,"[Messages] Failed to leave thread",{tags:{error_type:"thread_leave_error"}})})};eR.logger.warn("[Messages] Invalid thread ID, skipping join",{tags:{warning_type:"invalid_thread_id"},extra:{threadId:n.id}})}},[n,eo]),(0,E.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/proxy/messaging/api/v1/messages/diagnostic/identity");if(e.ok){let t=await e.json();eR.logger.debug("[Messages] Identity Diagnostic",{identity:t})}else eR.logger.warn("[Messages] Identity diagnostic endpoint returned non-OK status",{tags:{warning_type:"diagnostic_endpoint_error"},extra:{status:e.status}})}catch(e){eR.logger.warn("[Messages] Failed to get identity (non-critical)",{tags:{warning_type:"identity_check_failed"},extra:{error:e}})}})(),ew(),eS()},[]),(0,E.useEffect)(()=>{if(eo)return;let e=setInterval(()=>{ew(),eS(),n&&ev(n.id)},3e4);return()=>clearInterval(e)},[n,eo]),(0,E.useEffect)(()=>{n&&n.id&&(l||ev(n.id),Q(e=>({...e,applicationId:n.applicationId})))},[n?.id]),(0,E.useEffect)(()=>{ef.current&&ef.current.scrollIntoView({behavior:"smooth"})},[s]);let ew=async()=>{try{let e;c(!0),M(null),eR.logger.debug("[Messages] Loading threads...");try{e=await D.getAllThreads(1,100),eR.logger.debug("[Messages] Using getAllThreads - loaded all threads")}catch(t){eR.logger.warn("[Messages] getAllThreads failed, falling back to getMyThreads",{tags:{warning_type:"getallthreads_fallback"},extra:{error:t}}),e=await D.getMyThreads(1,100)}eR.logger.debug("[Messages] Threads loaded",{totalCount:e.totalCount,itemsCount:e.items?.length||0}),r(e.items||[]),e.items&&e.items.length>=0&&M(null),e.items&&0!==e.items.length||eR.logger.warn("[Messages] No threads found",{tags:{warning_type:"no_threads"},extra:{totalCount:e.totalCount}})}catch(n){{let{clientSentry:t}=await e.A(661405);t.reportError(n,{tags:{error_type:"messages",operation:"load_threads"},level:"error"})}let t=n instanceof Error?n.message:"Failed to load messages";t.includes("connect")||t.includes("unavailable")||t.includes("ECONNREFUSED")?M("Cannot connect to messaging service. Please ensure the backend messaging service is running on port 8087."):M(t),r([])}finally{c(!1)}},eS=async()=>{try{let e=await D.getUnreadCount();$(e.count||0)}catch(t){{let{clientSentry:r}=await e.A(661405);r.reportError(t,{tags:{error_type:"messages",operation:"load_unread_count"},level:"warning"})}}},ev=async t=>{try{h(!0);let r=((await D.getThreadMessages(t,1,100)).items||[]).map(e=>{let t,r=(e.senderName||"").toLowerCase(),o=(e.senderId||"").toLowerCase(),s=(e.senderRole||"").trim(),i=s.toUpperCase(),a=r.includes("@mukuru.com")||o.includes("@mukuru.com"),c=r.includes("@kurasika.com")||o.includes("@kurasika.com"),l=["tendai gatahwa","tendai","admin","compliance","mukuru"].some(e=>r.includes(e)),h=["alpha tembo","alpha","customer","applicant"].some(e=>r.includes(e));return t="Admin"===s||"ComplianceManager"===s||"ADMIN"===i||"COMPLIANCEMANAGER"===i||i.includes("ADMIN")||i.includes("COMPLIANCE")||a||l&&!h&&!c?"ADMIN":i.includes("PARTNER")||c?"PARTNER":"CUSTOMER",{id:e.id,sender:e.senderName,senderType:t,recipient:e.receiverName||void 0,subject:eb(n),content:e.content,timestamp:e.sentAt,applicationId:n?.applicationId||"",attachments:e.attachments?.map(e=>({id:e.id,fileName:e.fileName,contentType:e.contentType,fileSizeBytes:e.fileSizeBytes,storageKey:e.storageKey,storageUrl:e.storageUrl,documentId:e.documentId||void 0,description:e.description||void 0})),isRead:e.isRead,isStarred:e.isStarred||!1,priority:ex(e),threadId:e.threadId,replyToMessageId:e.replyToMessageId||void 0}}),o=r.sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime());i(o);let s=r.filter(e=>!e.isRead);s.length>0&&Promise.all(s.map(e=>D.markMessageRead(e.id).catch(e=>{eR.logger.warn("Failed to mark message as read",{tags:{warning_type:"mark_read_failed"},extra:{error:e}})}))).then(()=>{setTimeout(()=>{l||(ew().catch(t=>{e.A(661405).then(({clientSentry:e})=>{e.reportError(t,{tags:{error_type:"messages",operation:"load_threads"},level:"error"})})}),eS().catch(t=>{e.A(661405).then(({clientSentry:e})=>{e.reportError(t,{tags:{error_type:"messages",operation:"load_unread_count"},level:"warning"})})}))},2e3)})}catch(e){eR.logger.error(e,"Failed to load messages",{tags:{error_type:"messages_load_error"}})}finally{h(!1)}},eb=e=>e?`Application ${e.applicationReference||e.applicationId}`:"No Subject",ex=e=>{let t=e.content.toLowerCase();return t.includes("urgent")||t.includes("asap")||t.includes("immediate")?"HIGH":"MEDIUM"},eC=async()=>{if(!G.content.trim()&&0===eh.length||!n)return void await j.SweetAlert.warning("Message Required","Please enter a message or attach a file");try{Z(!0),M(null);let e=[];if(eh.length>0){eu(!0),em({});try{e=await Promise.all(eh.map(async(e,t)=>{try{em(t=>({...t,[e.name]:50}));let t=await eE(n.applicationId,e,`Message attachment: ${e.name}`,void 0);return em(t=>({...t,[e.name]:100})),{fileName:e.name,contentType:e.type||"application/octet-stream",fileSizeBytes:e.size,storageKey:t.storageKey,storageUrl:t.storageUrl||"",documentId:t.documentId,description:`Message attachment: ${e.name}`}}catch(t){if(eR.logger.error(t,`Failed to upload attachment ${e.name}`,{tags:{error_type:"attachment_upload_error"},extra:{fileName:e.name}}),em(t=>({...t,[e.name]:-1})),!(await j.SweetAlert.confirm("Upload Failed",`Failed to upload "${e.name}". Do you want to continue sending the message without this attachment?`,"Continue Without It","Cancel","warning")).isConfirmed)throw Error("User cancelled message send due to attachment upload failure");return{fileName:e.name,contentType:e.type||"application/octet-stream",fileSizeBytes:e.size,storageKey:`messages/${n.applicationId}/${Date.now()}-${e.name}`,storageUrl:"",description:void 0}}}))}catch(e){if(eR.logger.error(e,"Error uploading attachments",{tags:{error_type:"attachments_upload_error"}}),e instanceof Error&&e.message.includes("User cancelled")){eu(!1),em({});return}await j.SweetAlert.warning("Upload Warning","Some attachments failed to upload. The message will be sent without attachments.")}finally{eu(!1),em({})}}eR.logger.debug("Sending message",{applicationId:n.applicationId,content:G.content.substring(0,50)+"...",receiverId:G.receiverId||"none",replyToMessageId:ei?.id,attachmentsCount:e.length});let t=await D.sendMessage(n.applicationId,G.content.trim(),G.receiverId||void 0,ei?.id,e.length>0?e:void 0);if(t.success)et(!0),setTimeout(()=>et(!1),3e3),Q({applicationId:"",content:"",receiverId:""}),ed([]),ea(null),ey.current&&(ey.current.value=""),setTimeout(async()=>{await ev(n.id),await ew(),await eS(),setTimeout(()=>{ef.current&&ef.current.scrollIntoView({behavior:"smooth"})},100)},500);else throw Error(t.errorMessage||"Failed to send message")}catch(t){eR.logger.error(t,"Failed to send message",{tags:{error_type:"message_send_error"}});let e=t instanceof Error?t.message:"Failed to send message";M(e),await j.SweetAlert.error("Failed to Send",e)}finally{Z(!1)}},eI=t.filter(e=>{let t=e.applicantName.toLowerCase().includes(N.toLowerCase())||e.applicationReference?.toLowerCase().includes(N.toLowerCase())||e.lastMessage?.content.toLowerCase().includes(N.toLowerCase())||e.applicationId.toLowerCase().includes(N.toLowerCase()),r="ALL"===z||"UNREAD"===z&&e.unreadCount>0||"ACTIVE"===z&&e.isActive,n=H?e.isArchived:!e.isArchived,o=!q||e.isStarred;return t&&r&&n&&o}),eT=s.filter(e=>{if(!V)return!0;let t=V.toLowerCase();return e.content.toLowerCase().includes(t)||e.sender.toLowerCase().includes(t)||e.subject.toLowerCase().includes(t)}).sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime());return a?(0,d.jsxs)(g.Box,{height:"100vh",overflow:"hidden",display:"flex",children:[(0,d.jsx)(R.default,{}),(0,d.jsx)(g.Box,{ml:"240px",p:"8",bg:"gray.50",h:"100vh",flex:"1",display:"flex",alignItems:"center",justifyContent:"center",children:(0,d.jsx)(y.Spinner,{size:"xl",color:"orange.500"})})]}):(0,d.jsxs)(g.Box,{height:"100vh",overflow:"hidden",display:"flex",children:[(0,d.jsx)(R.default,{}),(0,d.jsx)(g.Box,{ml:"240px",bg:"gray.50",h:"100vh",display:"flex",flexDirection:"column",overflow:"hidden",flex:"1",children:(0,d.jsx)(u.Container,{maxW:"full",flex:"1",display:"flex",flexDirection:"column",p:"6",overflow:"hidden",minH:"0",children:(0,d.jsxs)(p.VStack,{gap:"4",align:"stretch",flex:"1",minH:"0",overflow:"hidden",children:[(0,d.jsxs)(_.Flex,{justify:"space-between",align:"center",flexShrink:0,children:[(0,d.jsxs)(p.VStack,{align:"start",gap:"1",children:[(0,d.jsx)(v.Typography,{fontSize:"2xl",fontWeight:"bold",color:"gray.900",children:"Messages"}),(0,d.jsx)(v.Typography,{fontSize:"sm",color:"gray.600",children:"Communicate with partners and customers"})]}),(0,d.jsxs)(m.HStack,{gap:"3",children:[(0,d.jsxs)(b.Button,{variant:"secondary",size:"sm",disabled:!0,children:[A," Unread"]}),eo?(0,d.jsx)(x.Tag,{variant:"success",children:" Live"}):(0,d.jsx)(x.Tag,{variant:"inactive",children:"Offline"}),(0,d.jsxs)(b.Button,{variant:"primary",size:"sm",onClick:()=>{J(!0),o(null),i([])},children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiPlus,{size:16})}),"New Message"]}),(0,d.jsxs)(b.Button,{variant:"secondary",size:"sm",onClick:()=>{ew(),eS(),n&&ev(n.id)},children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiRefreshCw,{size:16})}),"Refresh"]})]})]}),ee&&(0,d.jsx)(g.Box,{p:"3",bg:"green.50",borderRadius:"md",border:"1px",borderColor:"green.200",flexShrink:0,children:(0,d.jsxs)(m.HStack,{gap:"2",children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiCheckCircle,{size:16,color:"#38A169"})}),(0,d.jsx)(v.Typography,{fontSize:"sm",fontWeight:"medium",color:"green.800",children:"Message sent successfully!"})]})}),P&&(0,d.jsx)(g.Box,{p:"3",bg:"red.50",borderRadius:"md",border:"1px",borderColor:"red.200",flexShrink:0,children:(0,d.jsxs)(m.HStack,{gap:"2",justify:"space-between",align:"start",children:[(0,d.jsxs)(m.HStack,{gap:"2",flex:"1",children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiAlertCircle,{size:16,color:"#E53E3E"})}),(0,d.jsxs)(p.VStack,{align:"start",gap:"1",flex:"1",children:[(0,d.jsx)(v.Typography,{fontSize:"sm",fontWeight:"medium",color:"red.800",children:"Error loading messages"}),(0,d.jsx)(v.Typography,{fontSize:"xs",color:"red.700",children:P})]})]}),(0,d.jsx)(b.Button,{size:"sm",variant:"secondary",onClick:()=>{M(null),ew(),eS()},children:"Retry"})]})}),(0,d.jsxs)(_.Flex,{gap:"4",flex:"1",minH:"0",align:"stretch",overflow:"hidden",children:[(0,d.jsxs)(g.Box,{width:"380px",bg:"white",borderRadius:"lg",boxShadow:"sm",border:"1px",borderColor:"gray.200",display:"flex",flexDirection:"column",overflow:"hidden",flexShrink:0,children:[(0,d.jsx)(g.Box,{p:"3",borderBottom:"1px",borderColor:"gray.200",bg:"gray.50",flexShrink:0,children:(0,d.jsxs)(p.VStack,{gap:"2",align:"stretch",children:[(0,d.jsx)(g.Box,{flex:"1",maxW:"300px",children:(0,d.jsx)(S.Search,{placeholder:"Search messages...",onSearchChange:e=>F(e)})}),(0,d.jsxs)(m.HStack,{gap:"2",children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiFilter,{size:16,color:"#A0AEC0"})}),(0,d.jsxs)("select",{value:z,onChange:e=>W(e.target.value),style:{padding:"6px 12px",borderRadius:"6px",border:"1px solid #E2E8F0",backgroundColor:"white",fontSize:"13px",width:"100%",cursor:"pointer",color:"#000000"},children:[(0,d.jsx)("option",{value:"ALL",children:"All Messages"}),(0,d.jsx)("option",{value:"UNREAD",children:"Unread"}),(0,d.jsx)("option",{value:"ACTIVE",children:"Active"})]})]}),(0,d.jsxs)(m.HStack,{gap:"2",children:[(0,d.jsxs)(b.Button,{size:"sm",variant:H?"primary":"secondary",onClick:()=>L(!H),children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiArchive,{size:14})}),H?"Show Archived":"Hide Archived"]}),(0,d.jsxs)(b.Button,{size:"sm",variant:q?"primary":"secondary",onClick:()=>O(!q),children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiStar,{size:14})}),"Starred"]})]})]})}),(0,d.jsx)(g.Box,{flex:"1",overflowY:"auto",minH:"0",p:"2",children:0!==eI.length||a?0===eI.length&&a?(0,d.jsx)(_.Flex,{justify:"center",align:"center",height:"100%",minH:"300px",children:(0,d.jsx)(y.Spinner,{size:"lg",color:"orange.500"})}):(0,d.jsx)(p.VStack,{gap:"2",align:"stretch",children:eI.map(e=>(0,d.jsxs)(g.Box,{p:"3",borderRadius:"md",cursor:"pointer",bg:e.id===n?.id?"orange.50":"white",border:"1px",borderColor:e.id===n?.id?"orange.200":"gray.200",_hover:{bg:e.id===n?.id?"orange.50":"gray.50",borderColor:e.id===n?.id?"orange.300":"gray.300"},onClick:()=>o(e),transition:"all 0.2s",position:"relative",children:[e.id===n?.id&&(0,d.jsx)(g.Box,{position:"absolute",left:"0",top:"0",bottom:"0",width:"3px",bg:"orange.500",borderRadius:"md"}),(0,d.jsxs)(p.VStack,{gap:"2",align:"stretch",children:[(0,d.jsxs)(_.Flex,{justify:"space-between",align:"start",children:[(0,d.jsxs)(m.HStack,{gap:"2",flex:"1",minW:"0",children:[e.unreadCount>0&&(0,d.jsx)(g.Box,{px:"2",py:"0.5",borderRadius:"full",bg:"orange.500",color:"white",fontSize:"2xs",fontWeight:"bold",minW:"20px",textAlign:"center",children:e.unreadCount}),(0,d.jsx)(v.Typography,{fontSize:"xs",fontWeight:"semibold",color:"gray.700",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:e.applicantName})]}),(0,d.jsx)(v.Typography,{fontSize:"2xs",color:"gray.500",flexShrink:0,ml:"2",children:new Date(e.lastMessageAt).toLocaleDateString("en-US",{month:"short",day:"numeric"})})]}),e.lastMessage&&(0,d.jsx)(v.Typography,{fontSize:"xs",color:"gray.600",lineHeight:"1.4",style:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:e.lastMessage.content}),(0,d.jsxs)(m.HStack,{gap:"2",fontSize:"2xs",color:"gray.500",children:[(0,d.jsx)(x.Tag,{variant:"info",children:e.applicationReference||e.applicationId.substring(0,8)}),(0,d.jsx)(v.Typography,{children:""}),(0,d.jsxs)(v.Typography,{children:[e.messageCount," msgs"]})]})]})]},e.id))}):(0,d.jsx)(_.Flex,{justify:"center",align:"center",height:"100%",minH:"300px",children:(0,d.jsxs)(p.VStack,{gap:"3",children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiMessageSquare,{size:40,color:"#CBD5E0"})}),(0,d.jsx)(v.Typography,{color:"gray.500",fontSize:"sm",fontWeight:"medium",children:"No messages found"}),N||"ALL"!==z?(0,d.jsx)(v.Typography,{color:"gray.400",fontSize:"xs",children:"Try adjusting your search or filter"}):(0,d.jsx)(v.Typography,{color:"gray.400",fontSize:"xs",children:"Messages will appear here when available"})]})})})]}),(0,d.jsx)(g.Box,{flex:"1",bg:"white",borderRadius:"lg",boxShadow:"sm",border:"1px",borderColor:"gray.200",display:"flex",flexDirection:"column",overflow:"hidden",minW:"0",children:n?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(g.Box,{p:"4",borderBottom:"1px",borderColor:"gray.200",bg:"gray.50",flexShrink:0,children:(0,d.jsxs)(p.VStack,{gap:"2",align:"stretch",children:[(0,d.jsxs)(_.Flex,{justify:"space-between",align:"start",children:[(0,d.jsxs)(p.VStack,{align:"start",gap:"1",children:[(0,d.jsx)(v.Typography,{fontSize:"md",fontWeight:"semibold",color:"gray.900",children:eb(n)}),(0,d.jsx)(v.Typography,{fontSize:"sm",color:"gray.600",children:n.applicantName})]}),(0,d.jsx)(eP.default,{href:`/applications/${n.applicationId}`,children:(0,d.jsx)(b.Button,{size:"sm",variant:"secondary",children:"View Application"})})]}),(0,d.jsxs)(m.HStack,{gap:"4",fontSize:"xs",color:"gray.600",children:[(0,d.jsxs)(m.HStack,{gap:"1",children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiUser,{size:12})}),(0,d.jsxs)(v.Typography,{children:["Assigned: ",n.assignedAdminName||"Unassigned"]})]}),(0,d.jsxs)(m.HStack,{gap:"1",children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiMessageSquare,{size:12})}),(0,d.jsxs)(v.Typography,{children:[n.messageCount," messages"]})]})]})]})}),(0,d.jsxs)(g.Box,{flex:"1",overflowY:"auto",p:"4",bg:"gray.50",minH:"0",display:"flex",flexDirection:"column",children:[s.length>0&&(0,d.jsx)(g.Box,{mb:"3",flexShrink:0,children:(0,d.jsx)(g.Box,{flex:"1",maxW:"300px",children:(0,d.jsx)(S.Search,{placeholder:"Search messages in thread...",onSearchChange:e=>K(e)})})}),l?(0,d.jsx)(_.Flex,{justify:"center",align:"center",h:"200px",children:(0,d.jsx)(y.Spinner,{size:"md",color:"orange.500"})}):0===eT.length?(0,d.jsx)(_.Flex,{justify:"center",align:"center",height:"100%",minH:"300px",children:(0,d.jsxs)(p.VStack,{gap:"3",children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiMessageSquare,{size:40,color:"#CBD5E0"})}),(0,d.jsx)(v.Typography,{color:"gray.500",fontSize:"sm",fontWeight:"medium",children:V?"No messages match your search":"No messages in this thread"}),V&&(0,d.jsx)(b.Button,{size:"sm",variant:"ghost",onClick:()=>K(""),children:"Clear Search"})]})}):(0,d.jsxs)(p.VStack,{gap:"3",align:"stretch",children:[eT.map(e=>{let t=(e=>{if(!e.sender)return!1;let t=e.sender.toLowerCase();return!!("ADMIN"===e.senderType||t.includes("@mukuru.com"))||!!["tendai gatahwa","tendai","admin","compliance","mukuru"].some(e=>t.includes(e))||!["alpha tembo","alpha","customer","applicant"].some(e=>t.includes(e))&&"CUSTOMER"!==e.senderType&&(t.includes("mukuru")||t.includes("admin"))})(e);return 2>eT.indexOf(e)&&eR.logger.debug("[Messages] Rendering message",{sender:e.sender,senderType:e.senderType,isAdmin:t,willAlignRight:t}),(0,d.jsxs)(_.Flex,{justify:t?"flex-end":"flex-start",align:"flex-start",gap:"2",px:"2",children:[!t&&(0,d.jsx)(w.Avatar.Root,{size:"sm",children:(0,d.jsx)(w.Avatar.Fallback,{bg:"blue.500",children:e.sender.split(" ").map(e=>e[0]).join("").substring(0,2).toUpperCase()})}),(0,d.jsx)(g.Box,{maxW:"70%",p:"3",bg:t?"orange.500":"white",color:t?"white":"gray.800",borderRadius:"lg",boxShadow:"sm",border:t?"none":"1px",borderColor:t?"transparent":"gray.200",position:"relative",children:(0,d.jsxs)(p.VStack,{gap:"1.5",align:"stretch",children:[(0,d.jsxs)(_.Flex,{justify:"space-between",align:"center",gap:"2",children:[(0,d.jsx)(v.Typography,{fontSize:"xs",fontWeight:"semibold",color:t?"white":"gray.800",children:e.sender.split(",")[0].trim()}),(0,d.jsx)(v.Typography,{fontSize:"2xs",color:t?"orange.100":"gray.500",children:new Date(e.timestamp).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})})]}),(0,d.jsx)(v.Typography,{fontSize:"sm",whiteSpace:"pre-wrap",lineHeight:"1.5",color:t?"white":"gray.700",children:e.content}),e.attachments&&e.attachments.length>0&&(0,d.jsx)(g.Box,{mt:"2",p:"2",bg:t?"orange.600":"blue.50",borderRadius:"md",border:t?"none":"1px",borderColor:t?"transparent":"blue.100",children:(0,d.jsx)(p.VStack,{gap:"2",align:"stretch",children:e.attachments.map((e,r)=>(0,d.jsxs)(m.HStack,{gap:"2",justify:"space-between",children:[(0,d.jsxs)(m.HStack,{gap:"2",flex:"1",minW:"0",children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiPaperclip,{size:12,color:t?"white":"#3182CE"})}),(0,d.jsxs)(p.VStack,{align:"start",gap:"0",flex:"1",minW:"0",children:[(0,d.jsx)(v.Typography,{fontSize:"2xs",color:t?"white":"blue.700",fontWeight:"medium",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:e.fileName||`Attachment ${r+1}`}),(0,d.jsxs)(v.Typography,{fontSize:"2xs",color:t?"orange.100":"blue.600",children:[(e.fileSizeBytes/1024).toFixed(1)," KB"]})]})]}),(e.storageUrl||e.storageKey)&&(0,d.jsxs)(b.Button,{size:"sm",variant:t?"primary":"secondary",onClick:async()=>{try{let t=e.storageUrl;if(!t&&e.storageKey)try{let r=await fetch(`/api/proxy/api/v1/documents/download/${encodeURIComponent(e.storageKey)}`);if(r.ok){let e=await r.json();t=e.url||e.downloadUrl||""}}catch(e){eR.logger.error(e,"Failed to get download URL",{tags:{error_type:"download_url_error"}})}if(!t&&e.documentId)try{let r=await fetch(`/api/proxy/api/v1/documents/${e.documentId}/download`);if(r.ok){let e=await r.json();t=e.url||e.downloadUrl||""}}catch(e){eR.logger.error(e,"Failed to get document download URL",{tags:{error_type:"document_download_url_error"}})}t?window.open(t,"_blank"):await j.SweetAlert.warning("Download Unavailable","Download URL is not available for this attachment.")}catch(e){eR.logger.error(e,"Error downloading attachment",{tags:{error_type:"attachment_download_error"}}),await j.SweetAlert.error("Download Failed","Failed to download attachment. Please try again.")}},flexShrink:0,children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiDownload,{size:12})}),(0,d.jsx)(v.Typography,{ml:"1",children:"Download"})]})]},r))})}),e.replyToMessageId&&(0,d.jsx)(g.Box,{mt:"2",p:"2",bg:t?"orange.600":"gray.100",borderRadius:"md",borderLeft:t?"none":"3px",borderColor:t?"transparent":"blue.400",children:(0,d.jsxs)(v.Typography,{fontSize:"2xs",color:t?"orange.100":"gray.600",fontStyle:"italic",style:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:["Replying to: ",s.find(t=>t.id===e.replyToMessageId)?.content.substring(0,100)||"Previous message"]})}),(0,d.jsxs)(m.HStack,{gap:"1",mt:"2",justify:"flex-end",children:[(0,d.jsx)(b.Button,{size:"icon",variant:"ghost",onClick:()=>ea(e),title:"Reply",children:(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiCornerUpRight,{size:14})})}),(0,d.jsx)(b.Button,{size:"icon",variant:"ghost",onClick:()=>el(e),title:"Forward",children:(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiShare2,{size:14})})}),(0,d.jsx)(b.Button,{size:"icon",variant:"ghost",onClick:async()=>{try{(await D.starMessage(e.id)).success&&n&&await ev(n.id)}catch(e){eR.logger.error(e,"Failed to star message",{tags:{error_type:"star_message_error"}})}},title:e.isStarred?"Unstar":"Star",children:(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiStar,{size:14,color:e.isStarred?"#ECC94B":t?"white":"#A0AEC0"})})}),(0,d.jsx)(b.Button,{size:"icon",variant:"ghost",onClick:async()=>{if((await j.SweetAlert.confirm("Delete Message","Are you sure you want to delete this message? This action cannot be undone.","Yes, delete it!","Cancel","warning")).isConfirmed)try{j.SweetAlert.loading("Deleting...","Please wait while we delete the message.");let t=await D.deleteMessage(e.id);t.success?(i(t=>t.filter(t=>t.id!==e.id)),await ew(),j.SweetAlert.close(),await j.SweetAlert.success("Deleted!","Message has been deleted successfully.")):(j.SweetAlert.close(),await j.SweetAlert.error("Delete Failed",t.errorMessage||"Failed to delete message"))}catch(e){eR.logger.error(e,"Failed to delete message",{tags:{error_type:"delete_message_error"}}),j.SweetAlert.close(),await j.SweetAlert.error("Delete Failed","Failed to delete message. Please try again.")}},title:"Delete",children:(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiTrash2,{size:16})})})]})]})}),t&&(0,d.jsx)(w.Avatar.Root,{size:"sm",children:(0,d.jsx)(w.Avatar.Fallback,{bg:"orange.500",children:e.sender.split(" ").map(e=>e[0]).join("").substring(0,2).toUpperCase()})})]},e.id)}),(0,d.jsx)("div",{ref:ef})]})]}),(0,d.jsx)(g.Box,{p:"3",borderTop:"1px",borderColor:"gray.200",bg:"white",flexShrink:0,children:(0,d.jsxs)(p.VStack,{gap:"2",align:"stretch",children:[ei&&(0,d.jsx)(g.Box,{p:"2",bg:"blue.50",borderRadius:"md",borderLeft:"3px",borderColor:"blue.400",children:(0,d.jsxs)(m.HStack,{justify:"space-between",children:[(0,d.jsxs)(p.VStack,{align:"start",gap:"0",flex:"1",minW:"0",children:[(0,d.jsxs)(v.Typography,{fontSize:"2xs",fontWeight:"semibold",color:"blue.800",children:["Replying to ",ei.sender]}),(0,d.jsx)(v.Typography,{fontSize:"2xs",color:"blue.600",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:ei.content.substring(0,100)})]}),(0,d.jsx)(b.Button,{size:"icon",variant:"ghost",onClick:()=>ea(null),children:(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiX,{size:12})})})]})}),(0,d.jsx)(f.Textarea,{placeholder:ei?`Reply to ${ei.sender}...`:"Type your message...",value:G.content,onChange:e=>{Q(t=>({...t,content:e.target.value})),n&&eo&&e.target.value.length>0&&ek.sendTypingIndicator(n.id)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),eC())},size:"sm",rows:3,resize:"none",fontSize:"sm",color:"black",_focus:{color:"black"},_placeholder:{color:"gray.400"}}),eh.length>0&&(0,d.jsx)(p.VStack,{gap:"1.5",align:"stretch",children:eh.map((e,t)=>{let r=ep[e.name],n=-1===r;return(0,d.jsxs)(m.HStack,{p:"2",bg:n?"red.50":"gray.50",borderRadius:"md",justify:"space-between",border:n?"1px":"none",borderColor:n?"red.200":"transparent",children:[(0,d.jsxs)(m.HStack,{gap:"2",flex:"1",minW:"0",children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiPaperclip,{size:12,color:n?"#E53E3E":"#718096"})}),(0,d.jsxs)(p.VStack,{align:"start",gap:"0",flex:"1",minW:"0",children:[(0,d.jsx)(v.Typography,{fontSize:"xs",fontWeight:"medium",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:n?"red.700":"gray.800",children:e.name}),(0,d.jsxs)(m.HStack,{gap:"2",align:"center",children:[(0,d.jsxs)(v.Typography,{fontSize:"2xs",color:n?"red.600":"gray.500",children:[(e.size/1024).toFixed(1)," KB"]}),void 0!==r&&r>0&&r<100&&(0,d.jsxs)(v.Typography,{fontSize:"2xs",color:"blue.600",children:[r,"%"]}),n&&(0,d.jsx)(v.Typography,{fontSize:"2xs",color:"red.600",fontWeight:"medium",children:"Upload failed"})]})]})]}),(0,d.jsx)(b.Button,{size:"icon",variant:"ghost",onClick:()=>{ed(e=>e.filter((e,r)=>r!==t)),em(t=>{let r={...t};return delete r[e.name],r})},children:(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiX,{size:12})})})]},t)})}),n&&er[n.id]&&(0,d.jsxs)(v.Typography,{fontSize:"2xs",color:"gray.500",fontStyle:"italic",children:[er[n.id].userName," is typing..."]}),(0,d.jsxs)(m.HStack,{justify:"space-between",gap:"2",children:[(0,d.jsxs)(m.HStack,{gap:"2",flex:"1",children:[(0,d.jsx)("input",{ref:ey,type:"file",multiple:!0,style:{display:"none"},onChange:e=>{let t=Array.from(e.target.files||[]);ed(e=>[...e,...t])}}),(0,d.jsxs)(b.Button,{variant:"secondary",size:"sm",onClick:()=>ey.current?.click(),children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiPaperclip,{size:12})}),(0,d.jsx)(v.Typography,{children:"Attach"})]}),n&&(0,d.jsxs)(b.Button,{variant:"secondary",size:"sm",onClick:async()=>{try{let e=await D.archiveThread(n.id,!n.isArchived);e.success&&(await ew(),e.isArchived&&o(null))}catch(e){eR.logger.error(e,"Failed to archive thread",{tags:{error_type:"archive_thread_error"}}),await j.SweetAlert.error("Archive Failed","Failed to archive thread. Please try again.")}},fontSize:"xs",children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiArchive,{size:12})}),(0,d.jsx)(v.Typography,{ml:"1.5",children:n.isArchived?"Unarchive":"Archive"})]})]}),(0,d.jsx)(b.Button,{variant:"primary",size:"sm",onClick:eC,disabled:Y||eg,children:(0,d.jsxs)(m.HStack,{gap:"1.5",children:[Y||eg?(0,d.jsx)(y.Spinner,{size:"xs"}):(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiSend,{size:12})}),(0,d.jsx)(v.Typography,{children:eg?"Uploading...":Y?"Sending...":"Send"})]})})]})]})})]}):X?(0,d.jsx)(_.Flex,{justify:"center",align:"center",height:"100%",children:(0,d.jsxs)(p.VStack,{gap:"4",p:"8",children:[(0,d.jsx)(v.Typography,{fontSize:"md",fontWeight:"semibold",color:"gray.800",children:"Compose New Message"}),(0,d.jsx)(v.Typography,{fontSize:"sm",color:"gray.600",textAlign:"center",children:"To send a message, please select a thread or navigate to an application to start a conversation."}),(0,d.jsx)(b.Button,{variant:"secondary",size:"sm",onClick:()=>J(!1),children:"Cancel"})]})}):(0,d.jsx)(_.Flex,{justify:"center",align:"center",height:"100%",children:(0,d.jsxs)(p.VStack,{gap:"3",children:[(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiMessageSquare,{size:40,color:"#CBD5E0"})}),(0,d.jsx)(v.Typography,{fontSize:"sm",color:"gray.500",fontWeight:"medium",children:"Select a message to view details"})]})})})]})]})})}),(0,d.jsxs)(I.Modal,{isOpen:!!ec,onClose:()=>{el(null),Q({applicationId:"",content:"",receiverId:""})},title:"Forward Message",size:"large",closeOnBackdropClick:!0,closeOnEsc:!0,children:[(0,d.jsx)(I.ModalHeader,{children:(0,d.jsx)(v.Typography,{fontSize:"lg",fontWeight:"semibold",color:"gray.800",children:"Forward Message"})}),(0,d.jsx)(I.ModalBody,{children:(0,d.jsxs)(p.VStack,{gap:"4",align:"stretch",children:[(0,d.jsxs)(g.Box,{p:"3",bg:"gray.50",borderRadius:"md",borderLeft:"3px",borderColor:"blue.400",children:[(0,d.jsx)(v.Typography,{fontSize:"sm",fontWeight:"medium",color:"gray.700",mb:"2",children:"Original Message:"}),(0,d.jsxs)(v.Typography,{fontSize:"sm",color:"gray.600",mb:"1",children:["From: ",ec?.sender]}),(0,d.jsx)(v.Typography,{fontSize:"sm",color:"gray.600",whiteSpace:"pre-wrap",children:ec?.content})]}),(0,d.jsxs)(p.VStack,{gap:"3",align:"stretch",children:[(0,d.jsxs)(g.Box,{children:[(0,d.jsx)(v.Typography,{fontSize:"sm",fontWeight:"medium",color:"gray.700",mb:"2",children:"To Application ID:"}),(0,d.jsx)(k.Input,{placeholder:"Enter application ID (GUID)",value:G.receiverId||"",onChange:e=>Q(t=>({...t,receiverId:e.target.value}))})]}),(0,d.jsxs)(g.Box,{children:[(0,d.jsx)(v.Typography,{fontSize:"sm",fontWeight:"medium",color:"gray.700",mb:"2",children:"Additional Message (Optional):"}),(0,d.jsx)(f.Textarea,{placeholder:"Add any additional context...",value:G.content,onChange:e=>Q(t=>({...t,content:e.target.value})),rows:4})]})]})]})}),(0,d.jsx)(I.ModalFooter,{children:(0,d.jsxs)(m.HStack,{justify:"flex-end",gap:"3",w:"full",children:[(0,d.jsx)(b.Button,{variant:"secondary",onClick:()=>{el(null),Q({applicationId:"",content:"",receiverId:""})},children:"Cancel"}),(0,d.jsxs)(b.Button,{variant:"primary",onClick:async()=>{if(!G.receiverId?.trim())return void await j.SweetAlert.warning("Application ID Required","Please enter an application ID to forward to");try{Z(!0);let e=await D.forwardMessage(ec.id,G.receiverId.trim(),void 0,G.content.trim()||void 0);if(e.success)await j.SweetAlert.success("Message Forwarded","The message has been forwarded successfully."),el(null),Q({applicationId:"",content:"",receiverId:""}),await ew();else throw Error(e.errorMessage||"Failed to forward message")}catch(e){eR.logger.error(e,"Failed to forward message",{tags:{error_type:"forward_message_error"}}),await j.SweetAlert.error("Forward Failed",e instanceof Error?e.message:"Failed to forward message")}finally{Z(!1)}},disabled:Y,children:[Y?(0,d.jsx)(y.Spinner,{size:"sm"}):(0,d.jsx)(C.IconWrapper,{children:(0,d.jsx)(T.FiShare2,{size:16})}),(0,d.jsx)(v.Typography,{ml:"2",children:Y?"Forwarding...":"Forward"})]})]})})]})]})}e.s(["default",()=>eM],515570)}]);

//# debugId=5a0c4328-9fe0-7022-2c5b-33a8f74b52fb
//# sourceMappingURL=16cf6e0303ec7c84.js.map