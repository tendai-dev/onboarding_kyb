;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="67af6edb-9620-a148-5ea3-3e493eaf5c3d")}catch(e){}}();
module.exports=[526680,a=>{"use strict";var b,c,d,e,f,g,h,i,j,k,l=a.i(187924),m=a.i(247290),n=a.i(566701),o=a.i(480916),p=a.i(688294),q=a.i(154462),r=a.i(397225),s=a.i(15631),t=a.i(601167);a.i(525985);var u=a.i(790355),v=a.i(831551),w=a.i(492180),x=a.i(259580),y=a.i(138340),z=a.i(832141),A=a.i(790932),B=a.i(727348),C=a.i(151342),D=a.i(572131),E=a.i(992539);async function F(){return{"Content-Type":"application/json"}}async function G(a,b){let c=`http://localhost:3001/api/proxy/messaging${a}`,d=await F();try{let e=await fetch(c,{...b,headers:{...d,...b?.headers},credentials:"include"}),f=await e.text();if(!e.ok){let a=`Messaging API request failed: ${e.status} ${e.statusText}`;try{let b=JSON.parse(f);b.message?a=b.message:b.details?a=b.details:b.error&&(a=b.error)}catch{f&&f.trim().length>0&&(a=f.length>200?f.substring(0,200)+"...":f)}throw 503===e.status&&(a="Backend messaging service is unavailable. Please ensure the messaging service is running."),Error(a)}let g=e.headers.get("content-type");if(g&&g.includes("application/json")){if(!f||""===f.trim())return console.warn("[Messaging API] Empty response body for:",a),{};try{return JSON.parse(f)}catch(a){throw console.error("[Messaging API] JSON parse error:",a,"Response text:",f),Error("Invalid JSON response from server")}}return f&&f.trim().length>0&&console.warn("[Messaging API] Non-JSON response received:",f.substring(0,200)),{}}catch(a){if(a instanceof TypeError&&a.message.includes("Failed to fetch"))throw Error("Cannot connect to Messaging API. Please ensure the backend services are running.");throw a}}let H={async getMyThreads(a=1,b=20){let c=new URLSearchParams({page:String(a),pageSize:String(b)}).toString(),d=await G(`/api/v1/messages/threads/my?${c}`);return{items:d.items||d.Items||[],totalCount:d.totalCount??d.TotalCount??0,page:d.page??d.Page??a,pageSize:d.pageSize??d.PageSize??b,totalPages:d.totalPages??d.TotalPages??0,hasNextPage:d.hasNextPage??d.HasNextPage??!1,hasPreviousPage:d.hasPreviousPage??d.HasPreviousPage??!1}},async getAllThreads(a=1,b=20){let c=new URLSearchParams({page:String(a),pageSize:String(b)}).toString(),d=await G(`/api/v1/messages/threads/all?${c}`);return{items:d.items||d.Items||[],totalCount:d.totalCount??d.TotalCount??0,page:d.page??d.Page??a,pageSize:d.pageSize??d.PageSize??b,totalPages:d.totalPages??d.TotalPages??0,hasNextPage:d.hasNextPage??d.HasNextPage??!1,hasPreviousPage:d.hasPreviousPage??d.HasPreviousPage??!1}},getThreadByApplication:async a=>G(`/api/v1/messages/threads/application/${encodeURIComponent(a)}`),async getThreadMessages(a,b=1,c=50){let d=new URLSearchParams({page:String(b),pageSize:String(c)}).toString();return G(`/api/v1/messages/threads/${encodeURIComponent(a)}/messages?${d}`)},async sendMessage(a,b,c,d,e){try{let f=a;if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a))try{let{applicationsApi:b}=await (()=>{let a=Error("Cannot find module './applicationsApi'");throw a.code="MODULE_NOT_FOUND",a})(),c=await b.getApplicationById(a);if(c?.id)f=c.id;else throw Error(`Could not find application GUID for case ID: ${a}`)}catch(b){throw console.error("Failed to fetch application GUID from case ID:",b),Error(`Invalid application ID: ${a}. Could not resolve to GUID.`)}let g={ApplicationId:f,Content:b};c&&(g.ReceiverId=c),d&&(g.ReplyToMessageId=d),e&&e.length>0&&(g.Attachments=e.map(a=>({FileName:a.fileName,ContentType:a.contentType,FileSizeBytes:a.fileSizeBytes,StorageKey:a.storageKey,StorageUrl:a.storageUrl,DocumentId:a.documentId,Description:a.description})));let h=await G("/api/v1/messages",{method:"POST",body:JSON.stringify(g)}),i=h.Success??h.success??!1,j=h.MessageId??h.messageId,k=h.ThreadId??h.threadId,l=h.ErrorMessage??h.errorMessage;if(!i&&l)throw Error(l);return{success:i,messageId:j,threadId:k,errorMessage:l}}catch(a){throw console.error("Error sending message:",a),a}},async getUnreadCount(){try{return await G("/api/v1/messages/unread/count")}catch(a){return{count:(await this.getMyThreads(1,1e3)).items.reduce((a,b)=>a+(b.unreadCount||0),0)}}},async markMessageRead(a){await G(`/api/v1/messages/${encodeURIComponent(a)}/read`,{method:"PUT"})},async deleteMessage(a){try{return await G(`/api/v1/messages/${encodeURIComponent(a)}`,{method:"DELETE"}),{success:!0}}catch(a){return{success:!1,errorMessage:a instanceof Error?a.message:"Failed to delete message"}}},async starMessage(a){try{let b=await G(`/api/v1/messages/${encodeURIComponent(a)}/star`,{method:"PUT"});return{success:b.Success??b.success??!1,isStarred:b.IsStarred??b.isStarred??!1,errorMessage:b.ErrorMessage}}catch(a){return{success:!1,isStarred:!1,errorMessage:a instanceof Error?a.message:"Failed to star message"}}},async archiveThread(a,b=!0){try{let c=await G(`/api/v1/messages/threads/${encodeURIComponent(a)}/archive`,{method:"PUT",body:JSON.stringify({Archive:b})});return{success:c.Success??c.success??!1,isArchived:c.IsArchived??c.isArchived??!1,errorMessage:c.ErrorMessage}}catch(a){return{success:!1,isArchived:!1,errorMessage:a instanceof Error?a.message:"Failed to archive thread"}}},async forwardMessage(a,b,c,d){try{let e=await G(`/api/v1/messages/${encodeURIComponent(a)}/forward`,{method:"POST",body:JSON.stringify({ToApplicationId:b,ToReceiverId:c,AdditionalContent:d})});return{success:e.Success??e.success??!1,newMessageId:e.NewMessageId??e.newMessageId,newThreadId:e.NewThreadId??e.newThreadId,errorMessage:e.ErrorMessage}}catch(a){return{success:!1,errorMessage:a instanceof Error?a.message:"Failed to forward message"}}}};class I{static write(a){return`${a}${I.RecordSeparator}`}static parse(a){if(a[a.length-1]!==I.RecordSeparator)throw Error("Message is incomplete.");let b=a.split(I.RecordSeparator);return b.pop(),b}}I.RecordSeparatorCode=30,I.RecordSeparator=String.fromCharCode(I.RecordSeparatorCode),(b=g||(g={}))[b.Trace=0]="Trace",b[b.Debug=1]="Debug",b[b.Information=2]="Information",b[b.Warning=3]="Warning",b[b.Error=4]="Error",b[b.Critical=5]="Critical",b[b.None=6]="None";class J{constructor(){}log(a,b){}}J.instance=new J;class K{static isRequired(a,b){if(null==a)throw Error(`The '${b}' argument is required.`)}static isNotEmpty(a,b){if(!a||a.match(/^\s*$/))throw Error(`The '${b}' argument should not be empty.`)}static isIn(a,b,c){if(!(a in b))throw Error(`Unknown ${c} value: ${a}.`)}}class L{static get isBrowser(){return!L.isNode&&!1}static get isWebWorker(){return!L.isNode&&"object"==typeof self&&"importScripts"in self}static get isReactNative(){return!L.isNode&&!1}static get isNode(){return"undefined"!=typeof process&&process.release&&"node"===process.release.name}}function M(a,b){let c,d,e="";return N(a)?(e=`Binary data of length ${a.byteLength}`,b&&(e+=`. Content: '${c=new Uint8Array(a),d="",c.forEach(a=>{let b=a<16?"0":"";d+=`0x${b}${a.toString(16)} `}),d.substr(0,d.length-1)}'`)):"string"==typeof a&&(e=`String data of length ${a.length}`,b&&(e+=`. Content: '${a}'`)),e}function N(a){return a&&"undefined"!=typeof ArrayBuffer&&(a instanceof ArrayBuffer||a.constructor&&"ArrayBuffer"===a.constructor.name)}async function O(a,b,c,d,e,f){let h={},[i,j]=R();h[i]=j,a.log(g.Trace,`(${b} transport) sending data. ${M(e,f.logMessageContent)}.`);let k=N(e)?"arraybuffer":"text",l=await c.post(d,{content:e,headers:{...h,...f.headers},responseType:k,timeout:f.timeout,withCredentials:f.withCredentials});a.log(g.Trace,`(${b} transport) request complete. Response status: ${l.statusCode}.`)}class P{constructor(a,b){this._subject=a,this._observer=b}dispose(){let a=this._subject.observers.indexOf(this._observer);a>-1&&this._subject.observers.splice(a,1),0===this._subject.observers.length&&this._subject.cancelCallback&&this._subject.cancelCallback().catch(a=>{})}}class Q{constructor(a){this._minLevel=a,this.out=console}log(a,b){if(a>=this._minLevel){let c=`[${new Date().toISOString()}] ${g[a]}: ${b}`;switch(a){case g.Critical:case g.Error:this.out.error(c);break;case g.Warning:this.out.warn(c);break;case g.Information:this.out.info(c);break;default:this.out.log(c)}}}}function R(){var a,b,c,d;let e,f,g="X-SignalR-User-Agent";return L.isNode&&(g="User-Agent"),[g,(a="9.0.6",b=function(){if(!L.isNode)return"";switch(process.platform){case"win32":return"Windows NT";case"darwin":return"macOS";case"linux":return"Linux";default:return process.platform}}(),c=L.isNode?"NodeJS":"Browser",d=function(){if(L.isNode)return process.versions.node}(),e="Microsoft SignalR/",f=a.split("."),e+=`${f[0]}.${f[1]} (${a}; `,b&&""!==b?e+=`${b}; `:e+="Unknown OS; ",e+=`${c}`,d?e+=`; ${d}`:e+="; Unknown Runtime Version",e+=")")]}function S(a){return a.stack?a.stack:a.message?a.message:`${a}`}class T{writeHandshakeRequest(a){return I.write(JSON.stringify(a))}parseHandshakeResponse(a){let b,c;if(N(a)){let d=new Uint8Array(a),e=d.indexOf(I.RecordSeparatorCode);if(-1===e)throw Error("Message is incomplete.");let f=e+1;b=String.fromCharCode.apply(null,Array.prototype.slice.call(d.slice(0,f))),c=d.byteLength>f?d.slice(f).buffer:null}else{let d=a.indexOf(I.RecordSeparator);if(-1===d)throw Error("Message is incomplete.");let e=d+1;b=a.substring(0,e),c=a.length>e?a.substring(e):null}let d=JSON.parse(I.parse(b)[0]);if(d.type)throw Error("Expected a handshake response from the server.");return[c,d]}}class U extends Error{constructor(a,b){const c=new.target.prototype;super(`${a}: Status code '${b}'`),this.statusCode=b,this.__proto__=c}}class V extends Error{constructor(a="A timeout occurred."){const b=new.target.prototype;super(a),this.__proto__=b}}class W extends Error{constructor(a="An abort occurred."){const b=new.target.prototype;super(a),this.__proto__=b}}class X extends Error{constructor(a,b){const c=new.target.prototype;super(a),this.transport=b,this.errorType="UnsupportedTransportError",this.__proto__=c}}class Y extends Error{constructor(a,b){const c=new.target.prototype;super(a),this.transport=b,this.errorType="DisabledTransportError",this.__proto__=c}}class Z extends Error{constructor(a,b){const c=new.target.prototype;super(a),this.transport=b,this.errorType="FailedToStartTransportError",this.__proto__=c}}class $ extends Error{constructor(a){const b=new.target.prototype;super(a),this.errorType="FailedToNegotiateWithServerError",this.__proto__=b}}class _ extends Error{constructor(a,b){const c=new.target.prototype;super(a),this.innerErrors=b,this.__proto__=c}}(c=h||(h={}))[c.Invocation=1]="Invocation",c[c.StreamItem=2]="StreamItem",c[c.Completion=3]="Completion",c[c.StreamInvocation=4]="StreamInvocation",c[c.CancelInvocation=5]="CancelInvocation",c[c.Ping=6]="Ping",c[c.Close=7]="Close",c[c.Ack=8]="Ack",c[c.Sequence=9]="Sequence";class aa{constructor(){this.observers=[]}next(a){for(let b of this.observers)b.next(a)}error(a){for(let b of this.observers)b.error&&b.error(a)}complete(){for(let a of this.observers)a.complete&&a.complete()}subscribe(a){return this.observers.push(a),new P(this,a)}}class ab{constructor(a,b,c){this._bufferSize=1e5,this._messages=[],this._totalMessageCount=0,this._waitForSequenceMessage=!1,this._nextReceivingSequenceId=1,this._latestReceivedSequenceId=0,this._bufferedByteCount=0,this._reconnectInProgress=!1,this._protocol=a,this._connection=b,this._bufferSize=c}async _send(a){let b=this._protocol.writeMessage(a),c=Promise.resolve();if(this._isInvocationMessage(a)){this._totalMessageCount++;let a=()=>{},d=()=>{};N(b)?this._bufferedByteCount+=b.byteLength:this._bufferedByteCount+=b.length,this._bufferedByteCount>=this._bufferSize&&(c=new Promise((b,c)=>{a=b,d=c})),this._messages.push(new ac(b,this._totalMessageCount,a,d))}try{this._reconnectInProgress||await this._connection.send(b)}catch{this._disconnected()}await c}_ack(a){let b=-1;for(let c=0;c<this._messages.length;c++){let d=this._messages[c];if(d._id<=a.sequenceId)b=c,N(d._message)?this._bufferedByteCount-=d._message.byteLength:this._bufferedByteCount-=d._message.length,d._resolver();else if(this._bufferedByteCount<this._bufferSize)d._resolver();else break}-1!==b&&(this._messages=this._messages.slice(b+1))}_shouldProcessMessage(a){if(this._waitForSequenceMessage)if(a.type!==h.Sequence)return!1;else return this._waitForSequenceMessage=!1,!0;if(!this._isInvocationMessage(a))return!0;let b=this._nextReceivingSequenceId;return(this._nextReceivingSequenceId++,b<=this._latestReceivedSequenceId)?(b===this._latestReceivedSequenceId&&this._ackTimer(),!1):(this._latestReceivedSequenceId=b,this._ackTimer(),!0)}_resetSequence(a){a.sequenceId>this._nextReceivingSequenceId?this._connection.stop(Error("Sequence ID greater than amount of messages we've received.")):this._nextReceivingSequenceId=a.sequenceId}_disconnected(){this._reconnectInProgress=!0,this._waitForSequenceMessage=!0}async _resend(){let a=0!==this._messages.length?this._messages[0]._id:this._totalMessageCount+1;for(let b of(await this._connection.send(this._protocol.writeMessage({type:h.Sequence,sequenceId:a})),this._messages))await this._connection.send(b._message);this._reconnectInProgress=!1}_dispose(a){for(let b of(null!=a||(a=Error("Unable to reconnect to server.")),this._messages))b._rejector(a)}_isInvocationMessage(a){switch(a.type){case h.Invocation:case h.StreamItem:case h.Completion:case h.StreamInvocation:case h.CancelInvocation:return!0;case h.Close:case h.Sequence:case h.Ping:case h.Ack:return!1}}_ackTimer(){void 0===this._ackTimerHandle&&(this._ackTimerHandle=setTimeout(async()=>{try{this._reconnectInProgress||await this._connection.send(this._protocol.writeMessage({type:h.Ack,sequenceId:this._latestReceivedSequenceId}))}catch{}clearTimeout(this._ackTimerHandle),this._ackTimerHandle=void 0},1e3))}}class ac{constructor(a,b,c,d){this._message=a,this._id=b,this._resolver=c,this._rejector=d}}(d=i||(i={})).Disconnected="Disconnected",d.Connecting="Connecting",d.Connected="Connected",d.Disconnecting="Disconnecting",d.Reconnecting="Reconnecting";class ad{static create(a,b,c,d,e,f,g){return new ad(a,b,c,d,e,f,g)}constructor(a,b,c,d,e,f,j){this._nextKeepAlive=0,this._freezeEventListener=()=>{this._logger.log(g.Warning,"The page is being frozen, this will likely lead to the connection being closed and messages being lost. For more information see the docs at https://learn.microsoft.com/aspnet/core/signalr/javascript-client#bsleep")},K.isRequired(a,"connection"),K.isRequired(b,"logger"),K.isRequired(c,"protocol"),this.serverTimeoutInMilliseconds=null!=e?e:3e4,this.keepAliveIntervalInMilliseconds=null!=f?f:15e3,this._statefulReconnectBufferSize=null!=j?j:1e5,this._logger=b,this._protocol=c,this.connection=a,this._reconnectPolicy=d,this._handshakeProtocol=new T,this.connection.onreceive=a=>this._processIncomingData(a),this.connection.onclose=a=>this._connectionClosed(a),this._callbacks={},this._methods={},this._closedCallbacks=[],this._reconnectingCallbacks=[],this._reconnectedCallbacks=[],this._invocationId=0,this._receivedHandshakeResponse=!1,this._connectionState=i.Disconnected,this._connectionStarted=!1,this._cachedPingMessage=this._protocol.writeMessage({type:h.Ping})}get state(){return this._connectionState}get connectionId(){return this.connection&&this.connection.connectionId||null}get baseUrl(){return this.connection.baseUrl||""}set baseUrl(a){if(this._connectionState!==i.Disconnected&&this._connectionState!==i.Reconnecting)throw Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!a)throw Error("The HubConnection url must be a valid url.");this.connection.baseUrl=a}start(){return this._startPromise=this._startWithStateTransitions(),this._startPromise}async _startWithStateTransitions(){if(this._connectionState!==i.Disconnected)return Promise.reject(Error("Cannot start a HubConnection that is not in the 'Disconnected' state."));this._connectionState=i.Connecting,this._logger.log(g.Debug,"Starting HubConnection.");try{await this._startInternal(),L.isBrowser&&window.document.addEventListener("freeze",this._freezeEventListener),this._connectionState=i.Connected,this._connectionStarted=!0,this._logger.log(g.Debug,"HubConnection connected successfully.")}catch(a){return this._connectionState=i.Disconnected,this._logger.log(g.Debug,`HubConnection failed to start successfully because of error '${a}'.`),Promise.reject(a)}}async _startInternal(){this._stopDuringStartError=void 0,this._receivedHandshakeResponse=!1;let a=new Promise((a,b)=>{this._handshakeResolver=a,this._handshakeRejecter=b});await this.connection.start(this._protocol.transferFormat);try{let b=this._protocol.version;this.connection.features.reconnect||(b=1);let c={protocol:this._protocol.name,version:b};if(this._logger.log(g.Debug,"Sending handshake request."),await this._sendMessage(this._handshakeProtocol.writeHandshakeRequest(c)),this._logger.log(g.Information,`Using HubProtocol '${this._protocol.name}'.`),this._cleanupTimeout(),this._resetTimeoutPeriod(),this._resetKeepAliveInterval(),await a,this._stopDuringStartError)throw this._stopDuringStartError;(this.connection.features.reconnect||0)&&(this._messageBuffer=new ab(this._protocol,this.connection,this._statefulReconnectBufferSize),this.connection.features.disconnected=this._messageBuffer._disconnected.bind(this._messageBuffer),this.connection.features.resend=()=>{if(this._messageBuffer)return this._messageBuffer._resend()}),this.connection.features.inherentKeepAlive||await this._sendMessage(this._cachedPingMessage)}catch(a){throw this._logger.log(g.Debug,`Hub handshake failed with error '${a}' during start(). Stopping HubConnection.`),this._cleanupTimeout(),this._cleanupPingTimer(),await this.connection.stop(a),a}}async stop(){let a=this._startPromise;this.connection.features.reconnect=!1,this._stopPromise=this._stopInternal(),await this._stopPromise;try{await a}catch(a){}}_stopInternal(a){if(this._connectionState===i.Disconnected)return this._logger.log(g.Debug,`Call to HubConnection.stop(${a}) ignored because it is already in the disconnected state.`),Promise.resolve();if(this._connectionState===i.Disconnecting)return this._logger.log(g.Debug,`Call to HttpConnection.stop(${a}) ignored because the connection is already in the disconnecting state.`),this._stopPromise;let b=this._connectionState;return(this._connectionState=i.Disconnecting,this._logger.log(g.Debug,"Stopping HubConnection."),this._reconnectDelayHandle)?(this._logger.log(g.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this._reconnectDelayHandle),this._reconnectDelayHandle=void 0,this._completeClose(),Promise.resolve()):(b===i.Connected&&this._sendCloseMessage(),this._cleanupTimeout(),this._cleanupPingTimer(),this._stopDuringStartError=a||new W("The connection was stopped before the hub handshake could complete."),this.connection.stop(a))}async _sendCloseMessage(){try{await this._sendWithProtocol(this._createCloseMessage())}catch{}}stream(a,...b){let c,[d,e]=this._replaceStreamingParams(b),f=this._createStreamInvocation(a,b,e),g=new aa;return g.cancelCallback=()=>{let a=this._createCancelInvocation(f.invocationId);return delete this._callbacks[f.invocationId],c.then(()=>this._sendWithProtocol(a))},this._callbacks[f.invocationId]=(a,b)=>{b?g.error(b):a&&(a.type===h.Completion?a.error?g.error(Error(a.error)):g.complete():g.next(a.item))},c=this._sendWithProtocol(f).catch(a=>{g.error(a),delete this._callbacks[f.invocationId]}),this._launchStreams(d,c),g}_sendMessage(a){return this._resetKeepAliveInterval(),this.connection.send(a)}_sendWithProtocol(a){return this._messageBuffer?this._messageBuffer._send(a):this._sendMessage(this._protocol.writeMessage(a))}send(a,...b){let[c,d]=this._replaceStreamingParams(b),e=this._sendWithProtocol(this._createInvocation(a,b,!0,d));return this._launchStreams(c,e),e}invoke(a,...b){let[c,d]=this._replaceStreamingParams(b),e=this._createInvocation(a,b,!1,d);return new Promise((a,b)=>{this._callbacks[e.invocationId]=(c,d)=>{d?b(d):c&&(c.type===h.Completion?c.error?b(Error(c.error)):a(c.result):b(Error(`Unexpected message type: ${c.type}`)))};let d=this._sendWithProtocol(e).catch(a=>{b(a),delete this._callbacks[e.invocationId]});this._launchStreams(c,d)})}on(a,b){a&&b&&(a=a.toLowerCase(),this._methods[a]||(this._methods[a]=[]),-1===this._methods[a].indexOf(b)&&this._methods[a].push(b))}off(a,b){if(!a)return;a=a.toLowerCase();let c=this._methods[a];if(c)if(b){let d=c.indexOf(b);-1!==d&&(c.splice(d,1),0===c.length&&delete this._methods[a])}else delete this._methods[a]}onclose(a){a&&this._closedCallbacks.push(a)}onreconnecting(a){a&&this._reconnectingCallbacks.push(a)}onreconnected(a){a&&this._reconnectedCallbacks.push(a)}_processIncomingData(a){if(this._cleanupTimeout(),this._receivedHandshakeResponse||(a=this._processHandshakeResponse(a),this._receivedHandshakeResponse=!0),a){for(let b of this._protocol.parseMessages(a,this._logger))if(!this._messageBuffer||this._messageBuffer._shouldProcessMessage(b))switch(b.type){case h.Invocation:this._invokeClientMethod(b).catch(a=>{this._logger.log(g.Error,`Invoke client method threw error: ${S(a)}`)});break;case h.StreamItem:case h.Completion:{let a=this._callbacks[b.invocationId];if(a){b.type===h.Completion&&delete this._callbacks[b.invocationId];try{a(b)}catch(a){this._logger.log(g.Error,`Stream callback threw error: ${S(a)}`)}}break}case h.Ping:break;case h.Close:{this._logger.log(g.Information,"Close message received from server.");let a=b.error?Error("Server returned an error on close: "+b.error):void 0;!0===b.allowReconnect?this.connection.stop(a):this._stopPromise=this._stopInternal(a);break}case h.Ack:this._messageBuffer&&this._messageBuffer._ack(b);break;case h.Sequence:this._messageBuffer&&this._messageBuffer._resetSequence(b);break;default:this._logger.log(g.Warning,`Invalid message type: ${b.type}.`)}}this._resetTimeoutPeriod()}_processHandshakeResponse(a){let b,c;try{[c,b]=this._handshakeProtocol.parseHandshakeResponse(a)}catch(c){let a="Error parsing handshake response: "+c;this._logger.log(g.Error,a);let b=Error(a);throw this._handshakeRejecter(b),b}if(b.error){let a="Server returned handshake error: "+b.error;this._logger.log(g.Error,a);let c=Error(a);throw this._handshakeRejecter(c),c}return this._logger.log(g.Debug,"Server handshake complete."),this._handshakeResolver(),c}_resetKeepAliveInterval(){this.connection.features.inherentKeepAlive||(this._nextKeepAlive=new Date().getTime()+this.keepAliveIntervalInMilliseconds,this._cleanupPingTimer())}_resetTimeoutPeriod(){if((!this.connection.features||!this.connection.features.inherentKeepAlive)&&(this._timeoutHandle=setTimeout(()=>this.serverTimeout(),this.serverTimeoutInMilliseconds),void 0===this._pingServerHandle)){let a=this._nextKeepAlive-new Date().getTime();a<0&&(a=0),this._pingServerHandle=setTimeout(async()=>{if(this._connectionState===i.Connected)try{await this._sendMessage(this._cachedPingMessage)}catch{this._cleanupPingTimer()}},a)}}serverTimeout(){this.connection.stop(Error("Server timeout elapsed without receiving a message from the server."))}async _invokeClientMethod(a){let b,c,d,e=a.target.toLowerCase(),f=this._methods[e];if(!f){this._logger.log(g.Warning,`No client method with the name '${e}' found.`),a.invocationId&&(this._logger.log(g.Warning,`No result given for '${e}' method and invocation ID '${a.invocationId}'.`),await this._sendWithProtocol(this._createCompletionMessage(a.invocationId,"Client didn't provide a result.",null)));return}let h=f.slice(),i=!!a.invocationId;for(let f of h)try{let h=b;b=await f.apply(this,a.arguments),i&&b&&h&&(this._logger.log(g.Error,`Multiple results provided for '${e}'. Sending error to server.`),d=this._createCompletionMessage(a.invocationId,"Client provided multiple results.",null)),c=void 0}catch(a){c=a,this._logger.log(g.Error,`A callback for the method '${e}' threw error '${a}'.`)}d?await this._sendWithProtocol(d):i?(c?d=this._createCompletionMessage(a.invocationId,`${c}`,null):void 0!==b?d=this._createCompletionMessage(a.invocationId,null,b):(this._logger.log(g.Warning,`No result given for '${e}' method and invocation ID '${a.invocationId}'.`),d=this._createCompletionMessage(a.invocationId,"Client didn't provide a result.",null)),await this._sendWithProtocol(d)):b&&this._logger.log(g.Error,`Result given for '${e}' method but server is not expecting a result.`)}_connectionClosed(a){this._logger.log(g.Debug,`HubConnection.connectionClosed(${a}) called while in state ${this._connectionState}.`),this._stopDuringStartError=this._stopDuringStartError||a||new W("The underlying connection was closed before the hub handshake could complete."),this._handshakeResolver&&this._handshakeResolver(),this._cancelCallbacksWithError(a||Error("Invocation canceled due to the underlying connection being closed.")),this._cleanupTimeout(),this._cleanupPingTimer(),this._connectionState===i.Disconnecting?this._completeClose(a):this._connectionState===i.Connected&&this._reconnectPolicy?this._reconnect(a):this._connectionState===i.Connected&&this._completeClose(a)}_completeClose(a){if(this._connectionStarted){this._connectionState=i.Disconnected,this._connectionStarted=!1,this._messageBuffer&&(this._messageBuffer._dispose(null!=a?a:Error("Connection closed.")),this._messageBuffer=void 0),L.isBrowser&&window.document.removeEventListener("freeze",this._freezeEventListener);try{this._closedCallbacks.forEach(b=>b.apply(this,[a]))}catch(b){this._logger.log(g.Error,`An onclose callback called with error '${a}' threw error '${b}'.`)}}}async _reconnect(a){let b=Date.now(),c=0,d=void 0!==a?a:Error("Attempting to reconnect due to a unknown error."),e=this._getNextRetryDelay(c++,0,d);if(null===e){this._logger.log(g.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),this._completeClose(a);return}if(this._connectionState=i.Reconnecting,a?this._logger.log(g.Information,`Connection reconnecting because of error '${a}'.`):this._logger.log(g.Information,"Connection reconnecting."),0!==this._reconnectingCallbacks.length){try{this._reconnectingCallbacks.forEach(b=>b.apply(this,[a]))}catch(b){this._logger.log(g.Error,`An onreconnecting callback called with error '${a}' threw error '${b}'.`)}if(this._connectionState!==i.Reconnecting)return void this._logger.log(g.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting.")}for(;null!==e;){if(this._logger.log(g.Information,`Reconnect attempt number ${c} will start in ${e} ms.`),await new Promise(a=>{this._reconnectDelayHandle=setTimeout(a,e)}),this._reconnectDelayHandle=void 0,this._connectionState!==i.Reconnecting)return void this._logger.log(g.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting.");try{if(await this._startInternal(),this._connectionState=i.Connected,this._logger.log(g.Information,"HubConnection reconnected successfully."),0!==this._reconnectedCallbacks.length)try{this._reconnectedCallbacks.forEach(a=>a.apply(this,[this.connection.connectionId]))}catch(a){this._logger.log(g.Error,`An onreconnected callback called with connectionId '${this.connection.connectionId}; threw error '${a}'.`)}return}catch(a){if(this._logger.log(g.Information,`Reconnect attempt failed because of error '${a}'.`),this._connectionState!==i.Reconnecting){this._logger.log(g.Debug,`Connection moved to the '${this._connectionState}' from the reconnecting state during reconnect attempt. Done reconnecting.`),this._connectionState===i.Disconnecting&&this._completeClose();return}d=a instanceof Error?a:Error(a.toString()),e=this._getNextRetryDelay(c++,Date.now()-b,d)}}this._logger.log(g.Information,`Reconnect retries have been exhausted after ${Date.now()-b} ms and ${c} failed attempts. Connection disconnecting.`),this._completeClose()}_getNextRetryDelay(a,b,c){try{return this._reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:b,previousRetryCount:a,retryReason:c})}catch(c){return this._logger.log(g.Error,`IRetryPolicy.nextRetryDelayInMilliseconds(${a}, ${b}) threw error '${c}'.`),null}}_cancelCallbacksWithError(a){let b=this._callbacks;this._callbacks={},Object.keys(b).forEach(c=>{let d=b[c];try{d(null,a)}catch(b){this._logger.log(g.Error,`Stream 'error' callback called with '${a}' threw error: ${S(b)}`)}})}_cleanupPingTimer(){this._pingServerHandle&&(clearTimeout(this._pingServerHandle),this._pingServerHandle=void 0)}_cleanupTimeout(){this._timeoutHandle&&clearTimeout(this._timeoutHandle)}_createInvocation(a,b,c,d){if(c)if(0!==d.length)return{target:a,arguments:b,streamIds:d,type:h.Invocation};else return{target:a,arguments:b,type:h.Invocation};{let c=this._invocationId;return(this._invocationId++,0!==d.length)?{target:a,arguments:b,invocationId:c.toString(),streamIds:d,type:h.Invocation}:{target:a,arguments:b,invocationId:c.toString(),type:h.Invocation}}}_launchStreams(a,b){if(0!==a.length)for(let c in b||(b=Promise.resolve()),a)a[c].subscribe({complete:()=>{b=b.then(()=>this._sendWithProtocol(this._createCompletionMessage(c)))},error:a=>{let d;d=a instanceof Error?a.message:a&&a.toString?a.toString():"Unknown error",b=b.then(()=>this._sendWithProtocol(this._createCompletionMessage(c,d)))},next:a=>{b=b.then(()=>this._sendWithProtocol(this._createStreamItemMessage(c,a)))}})}_replaceStreamingParams(a){let b=[],c=[];for(let d=0;d<a.length;d++){let e=a[d];if(this._isObservable(e)){let f=this._invocationId;this._invocationId++,b[f]=e,c.push(f.toString()),a.splice(d,1)}}return[b,c]}_isObservable(a){return a&&a.subscribe&&"function"==typeof a.subscribe}_createStreamInvocation(a,b,c){let d=this._invocationId;return(this._invocationId++,0!==c.length)?{target:a,arguments:b,invocationId:d.toString(),streamIds:c,type:h.StreamInvocation}:{target:a,arguments:b,invocationId:d.toString(),type:h.StreamInvocation}}_createCancelInvocation(a){return{invocationId:a,type:h.CancelInvocation}}_createStreamItemMessage(a,b){return{invocationId:a,item:b,type:h.StreamItem}}_createCompletionMessage(a,b,c){return b?{error:b,invocationId:a,type:h.Completion}:{invocationId:a,result:c,type:h.Completion}}_createCloseMessage(){return{type:h.Close}}}let ae=[0,2e3,1e4,3e4,null];class af{constructor(a){this._retryDelays=void 0!==a?[...a,null]:ae}nextRetryDelayInMilliseconds(a){return this._retryDelays[a.previousRetryCount]}}class ag{}ag.Authorization="Authorization",ag.Cookie="Cookie";class ah{constructor(a,b,c){this.statusCode=a,this.statusText=b,this.content=c}}class ai{get(a,b){return this.send({...b,method:"GET",url:a})}post(a,b){return this.send({...b,method:"POST",url:a})}delete(a,b){return this.send({...b,method:"DELETE",url:a})}getCookieString(a){return""}}class aj extends ai{constructor(a,b){super(),this._innerClient=a,this._accessTokenFactory=b}async send(a){let b=!0;this._accessTokenFactory&&(!this._accessToken||a.url&&a.url.indexOf("/negotiate?")>0)&&(b=!1,this._accessToken=await this._accessTokenFactory()),this._setAuthorizationHeader(a);let c=await this._innerClient.send(a);return b&&401===c.statusCode&&this._accessTokenFactory?(this._accessToken=await this._accessTokenFactory(),this._setAuthorizationHeader(a),await this._innerClient.send(a)):c}_setAuthorizationHeader(a){a.headers||(a.headers={}),this._accessToken?a.headers[ag.Authorization]=`Bearer ${this._accessToken}`:this._accessTokenFactory&&a.headers[ag.Authorization]&&delete a.headers[ag.Authorization]}getCookieString(a){return this._innerClient.getCookieString(a)}}class ak extends ai{constructor(b){if(super(),this._logger=b,"undefined"==typeof fetch||L.isNode){const b="function"==typeof __webpack_require__?__non_webpack_require__:a.z;this._jar=new(b("tough-cookie")).CookieJar,"undefined"==typeof fetch?this._fetchType=b("node-fetch"):this._fetchType=fetch,this._fetchType=b("fetch-cookie")(this._fetchType,this._jar)}else this._fetchType=fetch.bind("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:a.g);if("undefined"==typeof AbortController){const b="function"==typeof __webpack_require__?__non_webpack_require__:a.z;this._abortControllerType=b("abort-controller")}else this._abortControllerType=AbortController}async send(a){let b,c;if(a.abortSignal&&a.abortSignal.aborted)throw new W;if(!a.method)throw Error("No method defined.");if(!a.url)throw Error("No url defined.");let d=new this._abortControllerType;a.abortSignal&&(a.abortSignal.onabort=()=>{d.abort(),b=new W});let e=null;a.timeout&&(e=setTimeout(()=>{d.abort(),this._logger.log(g.Warning,"Timeout from HTTP request."),b=new V},a.timeout)),""===a.content&&(a.content=void 0),a.content&&(a.headers=a.headers||{},N(a.content)?a.headers["Content-Type"]="application/octet-stream":a.headers["Content-Type"]="text/plain;charset=UTF-8");try{c=await this._fetchType(a.url,{body:a.content,cache:"no-cache",credentials:!0===a.withCredentials?"include":"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",...a.headers},method:a.method,mode:"cors",redirect:"follow",signal:d.signal})}catch(a){if(b)throw b;throw this._logger.log(g.Warning,`Error from HTTP request. ${a}.`),a}finally{e&&clearTimeout(e),a.abortSignal&&(a.abortSignal.onabort=null)}if(!c.ok)throw new U(await al(c,"text")||c.statusText,c.status);let f=al(c,a.responseType),h=await f;return new ah(c.status,c.statusText,h)}getCookieString(a){let b="";return L.isNode&&this._jar&&this._jar.getCookies(a,(a,c)=>b=c.join("; ")),b}}function al(a,b){let c;switch(b){case"arraybuffer":c=a.arrayBuffer();break;case"text":default:c=a.text();break;case"blob":case"document":case"json":throw Error(`${b} is not supported.`)}return c}class am extends ai{constructor(a){super(),this._logger=a}send(a){return a.abortSignal&&a.abortSignal.aborted?Promise.reject(new W):a.method?a.url?new Promise((b,c)=>{let d=new XMLHttpRequest;d.open(a.method,a.url,!0),d.withCredentials=void 0===a.withCredentials||a.withCredentials,d.setRequestHeader("X-Requested-With","XMLHttpRequest"),""===a.content&&(a.content=void 0),a.content&&(N(a.content)?d.setRequestHeader("Content-Type","application/octet-stream"):d.setRequestHeader("Content-Type","text/plain;charset=UTF-8"));let e=a.headers;e&&Object.keys(e).forEach(a=>{d.setRequestHeader(a,e[a])}),a.responseType&&(d.responseType=a.responseType),a.abortSignal&&(a.abortSignal.onabort=()=>{d.abort(),c(new W)}),a.timeout&&(d.timeout=a.timeout),d.onload=()=>{a.abortSignal&&(a.abortSignal.onabort=null),d.status>=200&&d.status<300?b(new ah(d.status,d.statusText,d.response||d.responseText)):c(new U(d.response||d.responseText||d.statusText,d.status))},d.onerror=()=>{this._logger.log(g.Warning,`Error from HTTP request. ${d.status}: ${d.statusText}.`),c(new U(d.statusText,d.status))},d.ontimeout=()=>{this._logger.log(g.Warning,"Timeout from HTTP request."),c(new V)},d.send(a.content)}):Promise.reject(Error("No url defined.")):Promise.reject(Error("No method defined."))}}class an extends ai{constructor(a){if(super(),"undefined"!=typeof fetch||L.isNode)this._httpClient=new ak(a);else if("undefined"!=typeof XMLHttpRequest)this._httpClient=new am(a);else throw Error("No usable HttpClient found.")}send(a){return a.abortSignal&&a.abortSignal.aborted?Promise.reject(new W):a.method?a.url?this._httpClient.send(a):Promise.reject(Error("No url defined.")):Promise.reject(Error("No method defined."))}getCookieString(a){return this._httpClient.getCookieString(a)}}(e=j||(j={}))[e.None=0]="None",e[e.WebSockets=1]="WebSockets",e[e.ServerSentEvents=2]="ServerSentEvents",e[e.LongPolling=4]="LongPolling",(f=k||(k={}))[f.Text=1]="Text",f[f.Binary=2]="Binary";class ao{constructor(){this._isAborted=!1,this.onabort=null}abort(){!this._isAborted&&(this._isAborted=!0,this.onabort&&this.onabort())}get signal(){return this}get aborted(){return this._isAborted}}class ap{get pollAborted(){return this._pollAbort.aborted}constructor(a,b,c){this._httpClient=a,this._logger=b,this._pollAbort=new ao,this._options=c,this._running=!1,this.onreceive=null,this.onclose=null}async connect(a,b){if(K.isRequired(a,"url"),K.isRequired(b,"transferFormat"),K.isIn(b,k,"transferFormat"),this._url=a,this._logger.log(g.Trace,"(LongPolling transport) Connecting."),b===k.Binary&&"undefined"!=typeof XMLHttpRequest&&"string"!=typeof new XMLHttpRequest().responseType)throw Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");let[c,d]=R(),e={[c]:d,...this._options.headers},f={abortSignal:this._pollAbort.signal,headers:e,timeout:1e5,withCredentials:this._options.withCredentials};b===k.Binary&&(f.responseType="arraybuffer");let h=`${a}&_=${Date.now()}`;this._logger.log(g.Trace,`(LongPolling transport) polling: ${h}.`);let i=await this._httpClient.get(h,f);200!==i.statusCode?(this._logger.log(g.Error,`(LongPolling transport) Unexpected response code: ${i.statusCode}.`),this._closeError=new U(i.statusText||"",i.statusCode),this._running=!1):this._running=!0,this._receiving=this._poll(this._url,f)}async _poll(a,b){try{for(;this._running;)try{let c=`${a}&_=${Date.now()}`;this._logger.log(g.Trace,`(LongPolling transport) polling: ${c}.`);let d=await this._httpClient.get(c,b);204===d.statusCode?(this._logger.log(g.Information,"(LongPolling transport) Poll terminated by server."),this._running=!1):200!==d.statusCode?(this._logger.log(g.Error,`(LongPolling transport) Unexpected response code: ${d.statusCode}.`),this._closeError=new U(d.statusText||"",d.statusCode),this._running=!1):d.content?(this._logger.log(g.Trace,`(LongPolling transport) data received. ${M(d.content,this._options.logMessageContent)}.`),this.onreceive&&this.onreceive(d.content)):this._logger.log(g.Trace,"(LongPolling transport) Poll timed out, reissuing.")}catch(a){this._running?a instanceof V?this._logger.log(g.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this._closeError=a,this._running=!1):this._logger.log(g.Trace,`(LongPolling transport) Poll errored after shutdown: ${a.message}`)}}finally{this._logger.log(g.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this._raiseOnClose()}}async send(a){return this._running?O(this._logger,"LongPolling",this._httpClient,this._url,a,this._options):Promise.reject(Error("Cannot send until the transport is connected"))}async stop(){this._logger.log(g.Trace,"(LongPolling transport) Stopping polling."),this._running=!1,this._pollAbort.abort();try{let a;await this._receiving,this._logger.log(g.Trace,`(LongPolling transport) sending DELETE request to ${this._url}.`);let b={},[c,d]=R();b[c]=d;let e={headers:{...b,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials};try{await this._httpClient.delete(this._url,e)}catch(b){a=b}a?a instanceof U&&(404===a.statusCode?this._logger.log(g.Trace,"(LongPolling transport) A 404 response was returned from sending a DELETE request."):this._logger.log(g.Trace,`(LongPolling transport) Error sending a DELETE request: ${a}`)):this._logger.log(g.Trace,"(LongPolling transport) DELETE request accepted.")}finally{this._logger.log(g.Trace,"(LongPolling transport) Stop finished."),this._raiseOnClose()}}_raiseOnClose(){if(this.onclose){let a="(LongPolling transport) Firing onclose event.";this._closeError&&(a+=" Error: "+this._closeError),this._logger.log(g.Trace,a),this.onclose(this._closeError)}}}class aq{constructor(a,b,c,d){this._httpClient=a,this._accessToken=b,this._logger=c,this._options=d,this.onreceive=null,this.onclose=null}async connect(a,b){return K.isRequired(a,"url"),K.isRequired(b,"transferFormat"),K.isIn(b,k,"transferFormat"),this._logger.log(g.Trace,"(SSE transport) Connecting."),this._url=a,this._accessToken&&(a+=(0>a.indexOf("?")?"?":"&")+`access_token=${encodeURIComponent(this._accessToken)}`),new Promise((c,d)=>{let e,f=!1;if(b!==k.Text)return void d(Error("The Server-Sent Events transport only supports the 'Text' transfer format"));if(L.isBrowser||L.isWebWorker)e=new this._options.EventSource(a,{withCredentials:this._options.withCredentials});else{let b=this._httpClient.getCookieString(a),c={};c.Cookie=b;let[d,f]=R();c[d]=f,e=new this._options.EventSource(a,{withCredentials:this._options.withCredentials,headers:{...c,...this._options.headers}})}try{e.onmessage=a=>{if(this.onreceive)try{this._logger.log(g.Trace,`(SSE transport) data received. ${M(a.data,this._options.logMessageContent)}.`),this.onreceive(a.data)}catch(a){this._close(a);return}},e.onerror=a=>{f?this._close():d(Error("EventSource failed to connect. The connection could not be found on the server, either the connection ID is not present on the server, or a proxy is refusing/buffering the connection. If you have multiple servers check that sticky sessions are enabled."))},e.onopen=()=>{this._logger.log(g.Information,`SSE connected to ${this._url}`),this._eventSource=e,f=!0,c()}}catch(a){d(a);return}})}async send(a){return this._eventSource?O(this._logger,"SSE",this._httpClient,this._url,a,this._options):Promise.reject(Error("Cannot send until the transport is connected"))}stop(){return this._close(),Promise.resolve()}_close(a){this._eventSource&&(this._eventSource.close(),this._eventSource=void 0,this.onclose&&this.onclose(a))}}class ar{constructor(a,b,c,d,e,f){this._logger=c,this._accessTokenFactory=b,this._logMessageContent=d,this._webSocketConstructor=e,this._httpClient=a,this.onreceive=null,this.onclose=null,this._headers=f}async connect(a,b){let c;return K.isRequired(a,"url"),K.isRequired(b,"transferFormat"),K.isIn(b,k,"transferFormat"),this._logger.log(g.Trace,"(WebSockets transport) Connecting."),this._accessTokenFactory&&(c=await this._accessTokenFactory()),new Promise((d,e)=>{let f;a=a.replace(/^http/,"ws");let h=this._httpClient.getCookieString(a),i=!1;if(L.isNode||L.isReactNative){let b={},[d,e]=R();b[d]=e,c&&(b[ag.Authorization]=`Bearer ${c}`),h&&(b[ag.Cookie]=h),f=new this._webSocketConstructor(a,void 0,{headers:{...b,...this._headers}})}else c&&(a+=(0>a.indexOf("?")?"?":"&")+`access_token=${encodeURIComponent(c)}`);f||(f=new this._webSocketConstructor(a)),b===k.Binary&&(f.binaryType="arraybuffer"),f.onopen=b=>{this._logger.log(g.Information,`WebSocket connected to ${a}.`),this._webSocket=f,i=!0,d()},f.onerror=a=>{let b=null;b="undefined"!=typeof ErrorEvent&&a instanceof ErrorEvent?a.error:"There was an error with the transport",this._logger.log(g.Information,`(WebSockets transport) ${b}.`)},f.onmessage=a=>{if(this._logger.log(g.Trace,`(WebSockets transport) data received. ${M(a.data,this._logMessageContent)}.`),this.onreceive)try{this.onreceive(a.data)}catch(a){this._close(a);return}},f.onclose=a=>{if(i)this._close(a);else e(Error("undefined"!=typeof ErrorEvent&&a instanceof ErrorEvent?a.error:"WebSocket failed to connect. The connection could not be found on the server, either the endpoint may not be a SignalR endpoint, the connection ID is not present on the server, or there is a proxy blocking WebSockets. If you have multiple servers check that sticky sessions are enabled."))}})}send(a){return this._webSocket&&this._webSocket.readyState===this._webSocketConstructor.OPEN?(this._logger.log(g.Trace,`(WebSockets transport) sending data. ${M(a,this._logMessageContent)}.`),this._webSocket.send(a),Promise.resolve()):Promise.reject("WebSocket is not in the OPEN state")}stop(){return this._webSocket&&this._close(void 0),Promise.resolve()}_close(a){this._webSocket&&(this._webSocket.onclose=()=>{},this._webSocket.onmessage=()=>{},this._webSocket.onerror=()=>{},this._webSocket.close(),this._webSocket=void 0),this._logger.log(g.Trace,"(WebSockets transport) socket closed."),this.onclose&&(this._isCloseEvent(a)&&(!1===a.wasClean||1e3!==a.code)?this.onclose(Error(`WebSocket closed with status code: ${a.code} (${a.reason||"no reason given"}).`)):a instanceof Error?this.onclose(a):this.onclose())}_isCloseEvent(a){return a&&"boolean"==typeof a.wasClean&&"number"==typeof a.code}}class as{constructor(b,c={}){if(this._stopPromiseResolver=()=>{},this.features={},this._negotiateVersion=1,K.isRequired(b,"url"),this._logger=function(a){return void 0===a?new Q(g.Information):null===a?J.instance:void 0!==a.log?a:new Q(a)}(c.logger),this.baseUrl=this._resolveUrl(b),(c=c||{}).logMessageContent=void 0!==c.logMessageContent&&c.logMessageContent,"boolean"==typeof c.withCredentials||void 0===c.withCredentials)c.withCredentials=void 0===c.withCredentials||c.withCredentials;else throw Error("withCredentials option was not a 'boolean' or 'undefined' value");c.timeout=void 0===c.timeout?1e5:c.timeout;let d=null,e=null;if(L.isNode&&1){const b="function"==typeof __webpack_require__?__non_webpack_require__:a.z;d=b("ws"),e=b("eventsource")}L.isNode||"undefined"==typeof WebSocket||c.WebSocket?L.isNode&&!c.WebSocket&&d&&(c.WebSocket=d):c.WebSocket=WebSocket,L.isNode||"undefined"==typeof EventSource||c.EventSource?L.isNode&&!c.EventSource&&void 0!==e&&(c.EventSource=e):c.EventSource=EventSource,this._httpClient=new aj(c.httpClient||new an(this._logger),c.accessTokenFactory),this._connectionState="Disconnected",this._connectionStarted=!1,this._options=c,this.onreceive=null,this.onclose=null}async start(a){if(a=a||k.Binary,K.isIn(a,k,"transferFormat"),this._logger.log(g.Debug,`Starting connection with transfer format '${k[a]}'.`),"Disconnected"!==this._connectionState)return Promise.reject(Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."));if(this._connectionState="Connecting",this._startInternalPromise=this._startInternal(a),await this._startInternalPromise,"Disconnecting"===this._connectionState){let a="Failed to start the HttpConnection before stop() was called.";return this._logger.log(g.Error,a),await this._stopPromise,Promise.reject(new W(a))}if("Connected"!==this._connectionState){let a="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!";return this._logger.log(g.Error,a),Promise.reject(new W(a))}this._connectionStarted=!0}send(a){return"Connected"!==this._connectionState?Promise.reject(Error("Cannot send data if the connection is not in the 'Connected' State.")):(this._sendQueue||(this._sendQueue=new at(this.transport)),this._sendQueue.send(a))}async stop(a){return"Disconnected"===this._connectionState?(this._logger.log(g.Debug,`Call to HttpConnection.stop(${a}) ignored because the connection is already in the disconnected state.`),Promise.resolve()):"Disconnecting"===this._connectionState?(this._logger.log(g.Debug,`Call to HttpConnection.stop(${a}) ignored because the connection is already in the disconnecting state.`),this._stopPromise):void(this._connectionState="Disconnecting",this._stopPromise=new Promise(a=>{this._stopPromiseResolver=a}),await this._stopInternal(a),await this._stopPromise)}async _stopInternal(a){this._stopError=a;try{await this._startInternalPromise}catch(a){}if(this.transport){try{await this.transport.stop()}catch(a){this._logger.log(g.Error,`HttpConnection.transport.stop() threw error '${a}'.`),this._stopConnection()}this.transport=void 0}else this._logger.log(g.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed.")}async _startInternal(a){let b=this.baseUrl;this._accessTokenFactory=this._options.accessTokenFactory,this._httpClient._accessTokenFactory=this._accessTokenFactory;try{if(this._options.skipNegotiation)if(this._options.transport===j.WebSockets)this.transport=this._constructTransport(j.WebSockets),await this._startTransport(b,a);else throw Error("Negotiation can only be skipped when using the WebSocket transport directly.");else{let c=null,d=0;do{if(c=await this._getNegotiationResponse(b),"Disconnecting"===this._connectionState||"Disconnected"===this._connectionState)throw new W("The connection was stopped during negotiation.");if(c.error)throw Error(c.error);if(c.ProtocolVersion)throw Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");if(c.url&&(b=c.url),c.accessToken){let a=c.accessToken;this._accessTokenFactory=()=>a,this._httpClient._accessToken=a,this._httpClient._accessTokenFactory=void 0}d++}while(c.url&&d<100)if(100===d&&c.url)throw Error("Negotiate redirection limit exceeded.");await this._createTransport(b,this._options.transport,c,a)}this.transport instanceof ap&&(this.features.inherentKeepAlive=!0),"Connecting"===this._connectionState&&(this._logger.log(g.Debug,"The HttpConnection connected successfully."),this._connectionState="Connected")}catch(a){return this._logger.log(g.Error,"Failed to start the connection: "+a),this._connectionState="Disconnected",this.transport=void 0,this._stopPromiseResolver(),Promise.reject(a)}}async _getNegotiationResponse(a){let b={},[c,d]=R();b[c]=d;let e=this._resolveNegotiateUrl(a);this._logger.log(g.Debug,`Sending negotiation request: ${e}.`);try{let a=await this._httpClient.post(e,{content:"",headers:{...b,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials});if(200!==a.statusCode)return Promise.reject(Error(`Unexpected status code returned from negotiate '${a.statusCode}'`));let c=JSON.parse(a.content);if((!c.negotiateVersion||c.negotiateVersion<1)&&(c.connectionToken=c.connectionId),c.useStatefulReconnect&&!0!==this._options._useStatefulReconnect)return Promise.reject(new $("Client didn't negotiate Stateful Reconnect but the server did."));return c}catch(b){let a="Failed to complete negotiation with the server: "+b;return b instanceof U&&404===b.statusCode&&(a+=" Either this is not a SignalR endpoint or there is a proxy blocking the connection."),this._logger.log(g.Error,a),Promise.reject(new $(a))}}_createConnectUrl(a,b){return b?a+(-1===a.indexOf("?")?"?":"&")+`id=${b}`:a}async _createTransport(a,b,c,d){let e=this._createConnectUrl(a,c.connectionToken);if(this._isITransport(b)){this._logger.log(g.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=b,await this._startTransport(e,d),this.connectionId=c.connectionId;return}let f=[],h=c.availableTransports||[],i=c;for(let c of h){let h=this._resolveTransportOrError(c,b,d,(null==i?void 0:i.useStatefulReconnect)===!0);if(h instanceof Error)f.push(`${c.transport} failed:`),f.push(h);else if(this._isITransport(h)){if(this.transport=h,!i){try{i=await this._getNegotiationResponse(a)}catch(a){return Promise.reject(a)}e=this._createConnectUrl(a,i.connectionToken)}try{await this._startTransport(e,d),this.connectionId=i.connectionId;return}catch(a){if(this._logger.log(g.Error,`Failed to start the transport '${c.transport}': ${a}`),i=void 0,f.push(new Z(`${c.transport} failed: ${a}`,j[c.transport])),"Connecting"!==this._connectionState){let a="Failed to select transport before stop() was called.";return this._logger.log(g.Debug,a),Promise.reject(new W(a))}}}}return f.length>0?Promise.reject(new _(`Unable to connect to the server with any of the available transports. ${f.join(" ")}`,f)):Promise.reject(Error("None of the transports supported by the client are supported by the server."))}_constructTransport(a){switch(a){case j.WebSockets:if(!this._options.WebSocket)throw Error("'WebSocket' is not supported in your environment.");return new ar(this._httpClient,this._accessTokenFactory,this._logger,this._options.logMessageContent,this._options.WebSocket,this._options.headers||{});case j.ServerSentEvents:if(!this._options.EventSource)throw Error("'EventSource' is not supported in your environment.");return new aq(this._httpClient,this._httpClient._accessToken,this._logger,this._options);case j.LongPolling:return new ap(this._httpClient,this._logger,this._options);default:throw Error(`Unknown transport: ${a}.`)}}_startTransport(a,b){return this.transport.onreceive=this.onreceive,this.features.reconnect?this.transport.onclose=async c=>{let d=!1;if(!this.features.reconnect)return void this._stopConnection(c);try{this.features.disconnected(),await this.transport.connect(a,b),await this.features.resend()}catch{d=!0}d&&this._stopConnection(c)}:this.transport.onclose=a=>this._stopConnection(a),this.transport.connect(a,b)}_resolveTransportOrError(a,b,c,d){var e,f;let h=j[a.transport];if(null==h)return this._logger.log(g.Debug,`Skipping transport '${a.transport}' because it is not supported by this client.`),Error(`Skipping transport '${a.transport}' because it is not supported by this client.`);if(e=b,f=h,e&&(f&e)==0)return this._logger.log(g.Debug,`Skipping transport '${j[h]}' because it was disabled by the client.`),new Y(`'${j[h]}' is disabled by the client.`,h);if(!(a.transferFormats.map(a=>k[a]).indexOf(c)>=0))return this._logger.log(g.Debug,`Skipping transport '${j[h]}' because it does not support the requested transfer format '${k[c]}'.`),Error(`'${j[h]}' does not support ${k[c]}.`);if(h===j.WebSockets&&!this._options.WebSocket||h===j.ServerSentEvents&&!this._options.EventSource)return this._logger.log(g.Debug,`Skipping transport '${j[h]}' because it is not supported in your environment.'`),new X(`'${j[h]}' is not supported in your environment.`,h);this._logger.log(g.Debug,`Selecting transport '${j[h]}'.`);try{return this.features.reconnect=h===j.WebSockets?d:void 0,this._constructTransport(h)}catch(a){return a}}_isITransport(a){return a&&"object"==typeof a&&"connect"in a}_stopConnection(a){if(this._logger.log(g.Debug,`HttpConnection.stopConnection(${a}) called while in state ${this._connectionState}.`),this.transport=void 0,a=this._stopError||a,this._stopError=void 0,"Disconnected"===this._connectionState)return void this._logger.log(g.Debug,`Call to HttpConnection.stopConnection(${a}) was ignored because the connection is already in the disconnected state.`);if("Connecting"===this._connectionState)throw this._logger.log(g.Warning,`Call to HttpConnection.stopConnection(${a}) was ignored because the connection is still in the connecting state.`),Error(`HttpConnection.stopConnection(${a}) was called while the connection is still in the connecting state.`);if("Disconnecting"===this._connectionState&&this._stopPromiseResolver(),a?this._logger.log(g.Error,`Connection disconnected with error '${a}'.`):this._logger.log(g.Information,"Connection disconnected."),this._sendQueue&&(this._sendQueue.stop().catch(a=>{this._logger.log(g.Error,`TransportSendQueue.stop() threw error '${a}'.`)}),this._sendQueue=void 0),this.connectionId=void 0,this._connectionState="Disconnected",this._connectionStarted){this._connectionStarted=!1;try{this.onclose&&this.onclose(a)}catch(b){this._logger.log(g.Error,`HttpConnection.onclose(${a}) threw error '${b}'.`)}}}_resolveUrl(a){if(0===a.lastIndexOf("https://",0)||0===a.lastIndexOf("http://",0))return a;if(!L.isBrowser)throw Error(`Cannot resolve '${a}'.`);let b=window.document.createElement("a");return b.href=a,this._logger.log(g.Information,`Normalizing '${a}' to '${b.href}'.`),b.href}_resolveNegotiateUrl(a){let b=new URL(a);b.pathname.endsWith("/")?b.pathname+="negotiate":b.pathname+="/negotiate";let c=new URLSearchParams(b.searchParams);return c.has("negotiateVersion")||c.append("negotiateVersion",this._negotiateVersion.toString()),c.has("useStatefulReconnect")?"true"===c.get("useStatefulReconnect")&&(this._options._useStatefulReconnect=!0):!0===this._options._useStatefulReconnect&&c.append("useStatefulReconnect","true"),b.search=c.toString(),b.toString()}}class at{constructor(a){this._transport=a,this._buffer=[],this._executing=!0,this._sendBufferedData=new au,this._transportResult=new au,this._sendLoopPromise=this._sendLoop()}send(a){return this._bufferData(a),this._transportResult||(this._transportResult=new au),this._transportResult.promise}stop(){return this._executing=!1,this._sendBufferedData.resolve(),this._sendLoopPromise}_bufferData(a){if(this._buffer.length&&typeof this._buffer[0]!=typeof a)throw Error(`Expected data to be of type ${typeof this._buffer} but was of type ${typeof a}`);this._buffer.push(a),this._sendBufferedData.resolve()}async _sendLoop(){for(;;){if(await this._sendBufferedData.promise,!this._executing){this._transportResult&&this._transportResult.reject("Connection stopped.");break}this._sendBufferedData=new au;let a=this._transportResult;this._transportResult=void 0;let b="string"==typeof this._buffer[0]?this._buffer.join(""):at._concatBuffers(this._buffer);this._buffer.length=0;try{await this._transport.send(b),a.resolve()}catch(b){a.reject(b)}}}static _concatBuffers(a){let b=new Uint8Array(a.map(a=>a.byteLength).reduce((a,b)=>a+b)),c=0;for(let d of a)b.set(new Uint8Array(d),c),c+=d.byteLength;return b.buffer}}class au{constructor(){this.promise=new Promise((a,b)=>([this._resolver,this._rejecter]=[a,b]))}resolve(){this._resolver()}reject(a){this._rejecter(a)}}class av{constructor(){this.name="json",this.version=2,this.transferFormat=k.Text}parseMessages(a,b){if("string"!=typeof a)throw Error("Invalid input for JSON hub protocol. Expected a string.");if(!a)return[];null===b&&(b=J.instance);let c=I.parse(a),d=[];for(let a of c){let c=JSON.parse(a);if("number"!=typeof c.type)throw Error("Invalid payload.");switch(c.type){case h.Invocation:this._isInvocationMessage(c);break;case h.StreamItem:this._isStreamItemMessage(c);break;case h.Completion:this._isCompletionMessage(c);break;case h.Ping:case h.Close:break;case h.Ack:this._isAckMessage(c);break;case h.Sequence:this._isSequenceMessage(c);break;default:b.log(g.Information,"Unknown message type '"+c.type+"' ignored.");continue}d.push(c)}return d}writeMessage(a){return I.write(JSON.stringify(a))}_isInvocationMessage(a){this._assertNotEmptyString(a.target,"Invalid payload for Invocation message."),void 0!==a.invocationId&&this._assertNotEmptyString(a.invocationId,"Invalid payload for Invocation message.")}_isStreamItemMessage(a){if(this._assertNotEmptyString(a.invocationId,"Invalid payload for StreamItem message."),void 0===a.item)throw Error("Invalid payload for StreamItem message.")}_isCompletionMessage(a){if(a.result&&a.error)throw Error("Invalid payload for Completion message.");!a.result&&a.error&&this._assertNotEmptyString(a.error,"Invalid payload for Completion message."),this._assertNotEmptyString(a.invocationId,"Invalid payload for Completion message.")}_isAckMessage(a){if("number"!=typeof a.sequenceId)throw Error("Invalid SequenceId for Ack message.")}_isSequenceMessage(a){if("number"!=typeof a.sequenceId)throw Error("Invalid SequenceId for Sequence message.")}_assertNotEmptyString(a,b){if("string"!=typeof a||""===a)throw Error(b)}}let aw={trace:g.Trace,debug:g.Debug,info:g.Information,information:g.Information,warn:g.Warning,warning:g.Warning,error:g.Error,critical:g.Critical,none:g.None};class ax{configureLogging(a){if(K.isRequired(a,"logging"),void 0!==a.log)this.logger=a;else if("string"==typeof a){let b=function(a){let b=aw[a.toLowerCase()];if(void 0!==b)return b;throw Error(`Unknown log level: ${a}`)}(a);this.logger=new Q(b)}else this.logger=new Q(a);return this}withUrl(a,b){return K.isRequired(a,"url"),K.isNotEmpty(a,"url"),this.url=a,"object"==typeof b?this.httpConnectionOptions={...this.httpConnectionOptions,...b}:this.httpConnectionOptions={...this.httpConnectionOptions,transport:b},this}withHubProtocol(a){return K.isRequired(a,"protocol"),this.protocol=a,this}withAutomaticReconnect(a){if(this.reconnectPolicy)throw Error("A reconnectPolicy has already been set.");return a?Array.isArray(a)?this.reconnectPolicy=new af(a):this.reconnectPolicy=a:this.reconnectPolicy=new af,this}withServerTimeout(a){return K.isRequired(a,"milliseconds"),this._serverTimeoutInMilliseconds=a,this}withKeepAliveInterval(a){return K.isRequired(a,"milliseconds"),this._keepAliveIntervalInMilliseconds=a,this}withStatefulReconnect(a){return void 0===this.httpConnectionOptions&&(this.httpConnectionOptions={}),this.httpConnectionOptions._useStatefulReconnect=!0,this._statefulReconnectBufferSize=null==a?void 0:a.bufferSize,this}build(){let a=this.httpConnectionOptions||{};if(void 0===a.logger&&(a.logger=this.logger),!this.url)throw Error("The 'HubConnectionBuilder.withUrl' method must be called before building the connection.");let b=new as(this.url,a);return ad.create(b,this.logger||J.instance,this.protocol||new av,this.reconnectPolicy,this._serverTimeoutInMilliseconds,this._keepAliveIntervalInMilliseconds,this._statefulReconnectBufferSize)}}class ay{connection=null;reconnectAttempts=0;maxReconnectAttempts=5;listeners=new Map;async connect(){if(this.connection?.state!==i.Connected)try{this.connection=new ax().withUrl("/api/proxy/messaging/messageHub",{accessTokenFactory:async()=>"",headers:{"X-User-Email":"","X-User-Name":"","X-User-Role":"Administrator","X-User-Id":""}}).withAutomaticReconnect({nextRetryDelayInMilliseconds:a=>a.previousRetryCount<this.maxReconnectAttempts?Math.min(1e3*Math.pow(2,a.previousRetryCount),3e4):null}).configureLogging(g.Information).build(),this.setupEventHandlers(),await this.connection.start(),console.log("[SignalR] Connected to messaging hub"),this.reconnectAttempts=0}catch(a){throw console.error("[SignalR] Connection error:",a),this.reconnectAttempts++,a}}setupEventHandlers(){this.connection&&(this.connection.on("ReceiveMessage",a=>{console.log("[SignalR] Received message:",a),this.notifyListeners("ReceiveMessage",a)}),this.connection.on("MessageSent",a=>{console.log("[SignalR] Message sent:",a),this.notifyListeners("MessageSent",a)}),this.connection.on("MessageError",a=>{console.error("[SignalR] Message error:",a),this.notifyListeners("MessageError",a)}),this.connection.on("UserTyping",a=>{this.notifyListeners("UserTyping",a)}),this.connection.on("MessageRead",a=>{this.notifyListeners("MessageRead",a)}),this.connection.onreconnecting(a=>{console.warn("[SignalR] Reconnecting...",a),this.notifyListeners("Reconnecting",a)}),this.connection.onreconnected(a=>{console.log("[SignalR] Reconnected:",a),this.notifyListeners("Reconnected",a)}),this.connection.onclose(a=>{console.error("[SignalR] Connection closed:",a),this.notifyListeners("ConnectionClosed",a)}))}async disconnect(){this.connection&&(await this.connection.stop(),this.connection=null,this.listeners.clear(),console.log("[SignalR] Disconnected"))}async joinThread(a){if(this.connection?.state===i.Connected){if(!a||"00000000-0000-0000-0000-000000000000"===a)return void console.warn("[SignalR] Invalid threadId provided to JoinThread:",a);try{if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a))return void console.warn("[SignalR] threadId is not a valid GUID:",a);await this.connection.invoke("JoinThread",a),console.log("[SignalR] Joined thread:",a)}catch(b){throw console.error("[SignalR] Failed to join thread:",a,b),b}}}async leaveThread(a){this.connection?.state===i.Connected&&await this.connection.invoke("LeaveThread",a)}async sendTypingIndicator(a){this.connection?.state===i.Connected&&await this.connection.invoke("UserTyping",a)}on(a,b){return this.listeners.has(a)||this.listeners.set(a,new Set),this.listeners.get(a).add(b),()=>{this.listeners.get(a)?.delete(b)}}notifyListeners(a,b){let c=this.listeners.get(a);c&&c.forEach(c=>{try{c(b)}catch(b){console.error(`[SignalR] Error in listener for ${a}:`,b)}})}isConnected(){return this.connection?.state===i.Connected}getConnectionState(){return this.connection?.state||i.Disconnected}generateUserIdFromEmail(a){let b=0;for(let c=0;c<a.length;c++)b=(b<<5)-b+a.charCodeAt(c),b&=b;return Math.abs(b).toString()}}let az=new ay;class aA{static instance;permission="default";constructor(){}static getInstance(){return aA.instance||(aA.instance=new aA),aA.instance}async requestPermission(){if(!("Notification"in window))return console.warn("[PushNotifications] This browser does not support notifications"),!1;if("granted"===this.permission)return!0;if("denied"===this.permission)return console.warn("[PushNotifications] Notification permission denied"),!1;let a=await Notification.requestPermission();return this.permission=a,"granted"===a}async showNotification(a,b={}){!("Notification"in window)||("granted"===this.permission||await this.requestPermission())&&new Notification(a,{icon:"/mukuru-logo.png",badge:"/mukuru-logo.png",tag:"message",requireInteraction:!1,...b})}async showMessageNotification(a,b,c){await this.showNotification(`New message from ${a}`,{body:b.length>100?b.substring(0,100)+"...":b,tag:`message-${c||"new"}`,data:{threadId:c},requireInteraction:!1})}getPermission(){return this.permission}isSupported(){return"Notification"in window}}let aB=aA.getInstance();async function aC(a,b,c,d){let e="";if(d){let a=d.toLowerCase(),b=0;for(let c=0;c<a.length;c++)b=(b<<5)-b+a.charCodeAt(c),b&=b;let c=Math.abs(b).toString(16).padStart(32,"0");e=`${c.substring(0,8)}-${c.substring(8,12)}-${c.substring(12,16)}-${c.substring(16,20)}-${c.substring(20,32)}`}let f=new FormData;f.append("file",b),f.append("caseId",a),f.append("partnerId",e),f.append("type","99"),c&&f.append("description",c),d&&f.append("uploadedBy",d);let g=await fetch("/api/proxy/api/v1/documents/upload",{method:"POST",body:f});if(!g.ok){let a=await g.text();throw Error(`Document upload failed: ${g.status} - ${a}`)}let h=await g.json(),i="";if(h.storageKey)try{let a=await fetch(`/api/proxy/api/v1/documents/download/${encodeURIComponent(h.storageKey)}`,{method:"GET"});if(a.ok){let b=await a.json();i=b.url||b.downloadUrl||""}}catch(a){console.warn("Failed to get download URL:",a)}return{documentId:h.documentId||h.id||"",documentNumber:h.documentNumber||"",wasDuplicate:h.wasDuplicate||!1,existingDocumentId:h.existingDocumentId,storageKey:h.storageKey||"",storageUrl:i}}var aD=a.i(255145),aE=a.i(238246);function aF(){let[a,b]=(0,D.useState)([]),[c,d]=(0,D.useState)(null),[e,f]=(0,D.useState)([]),[g,h]=(0,D.useState)(!0),[i,j]=(0,D.useState)(!1),[k,F]=(0,D.useState)(null),[G,I]=(0,D.useState)(0),[J,K]=(0,D.useState)(""),[L,M]=(0,D.useState)("ALL"),[N,O]=(0,D.useState)("ALL"),[P,Q]=(0,D.useState)(!1),[R,S]=(0,D.useState)(!1),[T,U]=(0,D.useState)(""),[V,W]=(0,D.useState)(!1),[X,Y]=(0,D.useState)({applicationId:"",content:"",receiverId:""}),[Z,$]=(0,D.useState)(!1),[_,aa]=(0,D.useState)(!1),[ab,ac]=(0,D.useState)({}),[ad,ae]=(0,D.useState)(!1),[af,ag]=(0,D.useState)(null),[ah,ai]=(0,D.useState)(null),[aj,ak]=(0,D.useState)([]),[al,am]=(0,D.useState)(!1),[an,ao]=(0,D.useState)({}),ap=(0,D.useRef)(null),aq=(0,D.useRef)(null),ar=(0,D.useRef)(null);(0,D.useEffect)(()=>{(async()=>{try{await az.connect(),ae(!0);let a=az.on("ReceiveMessage",async a=>{if(aD.logger.debug("[Admin Messages] Received SignalR message",{messageId:a.id}),document.hidden||!c||a.threadId!==c.id)try{await aB.showMessageNotification(a.senderName||"Admin",a.content||"New message",a.threadId)}catch(a){aD.logger.error(a,"[Messages] Failed to show notification",{tags:{error_type:"notification_error"}})}if(c&&a.threadId===c.id){let b=(a.senderName||"").toLowerCase(),d=(a.senderEmail||a.senderId||"").toLowerCase(),e=b.includes("@mukuru.com")||d.includes("@mukuru.com")||"Admin"===a.senderRole||"ComplianceManager"===a.senderRole,g={id:a.id,sender:a.senderName,senderType:e?"ADMIN":"PARTNER",subject:av(c),content:a.content,timestamp:a.sentAt,applicationId:a.applicationId||c.applicationId,attachments:a.attachments||[],isRead:!1,isStarred:!1,priority:aw({content:a.content}),threadId:a.threadId};f(b=>b.some(b=>b.id===a.id)?b:[...b,g].sort((a,b)=>new Date(a.timestamp).getTime()-new Date(b.timestamp).getTime())),setTimeout(()=>{ap.current&&ap.current.scrollIntoView({behavior:"smooth"})},100),setTimeout(async()=>{try{await au(c.id)}catch(a){aD.logger.error(a,"[Admin Messages] Failed to reload messages after SignalR update",{tags:{error_type:"messages_reload_error"}})}},500)}as(),at()}),b=az.on("MessageSent",a=>{c&&a.threadId===c.id&&au(c.id),as(),at()}),d=az.on("UserTyping",a=>{c&&a.threadId===c.id&&(ac(b=>({...b,[a.threadId]:{userName:a.userName}})),aq.current&&clearTimeout(aq.current),aq.current=setTimeout(()=>{ac(b=>{let c={...b};return delete c[a.threadId],c})},3e3))}),e=az.on("MessageRead",a=>{f(b=>b.map(b=>b.id===a?{...b,isRead:!0}:b))});return()=>{a(),b(),d(),e(),az.disconnect()}}catch(a){aD.logger.error(a,"[Messages] Failed to connect SignalR",{tags:{error_type:"signalr_connection_error"}}),ae(!1)}})()},[]),(0,D.useEffect)(()=>{if(c&&ad&&c.id){if(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(c.id)&&"00000000-0000-0000-0000-000000000000"!==c.id)return az.joinThread(c.id).catch(a=>{aD.logger.error(a,"[Messages] Failed to join thread",{tags:{error_type:"thread_join_error"}})}),()=>{az.leaveThread(c.id).catch(a=>{aD.logger.error(a,"[Messages] Failed to leave thread",{tags:{error_type:"thread_leave_error"}})})};aD.logger.warn("[Messages] Invalid thread ID, skipping join",{tags:{warning_type:"invalid_thread_id"},extra:{threadId:c.id}})}},[c,ad]),(0,D.useEffect)(()=>{(async()=>{try{let a=await fetch("/api/proxy/messaging/api/v1/messages/diagnostic/identity");if(a.ok){let b=await a.json();aD.logger.debug("[Messages] Identity Diagnostic",{identity:b})}else aD.logger.warn("[Messages] Identity diagnostic endpoint returned non-OK status",{tags:{warning_type:"diagnostic_endpoint_error"},extra:{status:a.status}})}catch(a){aD.logger.warn("[Messages] Failed to get identity (non-critical)",{tags:{warning_type:"identity_check_failed"},extra:{error:a}})}})(),as(),at()},[]),(0,D.useEffect)(()=>{if(ad)return;let a=setInterval(()=>{as(),at(),c&&au(c.id)},3e4);return()=>clearInterval(a)},[c,ad]),(0,D.useEffect)(()=>{c&&c.id&&(i||au(c.id),Y(a=>({...a,applicationId:c.applicationId})))},[c?.id]),(0,D.useEffect)(()=>{ap.current&&ap.current.scrollIntoView({behavior:"smooth"})},[e]);let as=async()=>{try{let a;h(!0),F(null),aD.logger.debug("[Messages] Loading threads...");try{a=await H.getAllThreads(1,100),aD.logger.debug("[Messages] Using getAllThreads - loaded all threads")}catch(b){aD.logger.warn("[Messages] getAllThreads failed, falling back to getMyThreads",{tags:{warning_type:"getallthreads_fallback"},extra:{error:b}}),a=await H.getMyThreads(1,100)}aD.logger.debug("[Messages] Threads loaded",{totalCount:a.totalCount,itemsCount:a.items?.length||0}),b(a.items||[]),a.items&&a.items.length>=0&&F(null),a.items&&0!==a.items.length||aD.logger.warn("[Messages] No threads found",{tags:{warning_type:"no_threads"},extra:{totalCount:a.totalCount}})}catch(c){let a=c instanceof Error?c.message:"Failed to load messages";a.includes("connect")||a.includes("unavailable")||a.includes("ECONNREFUSED")?F("Cannot connect to messaging service. Please ensure the backend messaging service is running on port 8087."):F(a),b([])}finally{h(!1)}},at=async()=>{try{let a=await H.getUnreadCount();I(a.count||0)}catch(a){}},au=async a=>{try{j(!0);let b=((await H.getThreadMessages(a,1,100)).items||[]).map(a=>{let b,d=(a.senderName||"").toLowerCase(),e=(a.senderId||"").toLowerCase(),f=(a.senderRole||"").trim(),g=f.toUpperCase(),h=d.includes("@mukuru.com")||e.includes("@mukuru.com"),i=d.includes("@kurasika.com")||e.includes("@kurasika.com"),j=["tendai gatahwa","tendai","admin","compliance","mukuru"].some(a=>d.includes(a)),k=["alpha tembo","alpha","customer","applicant"].some(a=>d.includes(a));return b="Admin"===f||"ComplianceManager"===f||"ADMIN"===g||"COMPLIANCEMANAGER"===g||g.includes("ADMIN")||g.includes("COMPLIANCE")||h||j&&!k&&!i?"ADMIN":g.includes("PARTNER")||i?"PARTNER":"CUSTOMER",{id:a.id,sender:a.senderName,senderType:b,recipient:a.receiverName||void 0,subject:av(c),content:a.content,timestamp:a.sentAt,applicationId:c?.applicationId||"",attachments:a.attachments?.map(a=>({id:a.id,fileName:a.fileName,contentType:a.contentType,fileSizeBytes:a.fileSizeBytes,storageKey:a.storageKey,storageUrl:a.storageUrl,documentId:a.documentId||void 0,description:a.description||void 0})),isRead:a.isRead,isStarred:a.isStarred||!1,priority:aw(a),threadId:a.threadId,replyToMessageId:a.replyToMessageId||void 0}}),d=b.sort((a,b)=>new Date(a.timestamp).getTime()-new Date(b.timestamp).getTime());f(d);let e=b.filter(a=>!a.isRead);e.length>0&&Promise.all(e.map(a=>H.markMessageRead(a.id).catch(a=>{aD.logger.warn("Failed to mark message as read",{tags:{warning_type:"mark_read_failed"},extra:{error:a}})}))).then(()=>{setTimeout(()=>{i||(as().catch(a=>{}),at().catch(a=>{}))},2e3)})}catch(a){aD.logger.error(a,"Failed to load messages",{tags:{error_type:"messages_load_error"}})}finally{j(!1)}},av=a=>a?`Application ${a.applicationReference||a.applicationId}`:"No Subject",aw=a=>{let b=a.content.toLowerCase();return b.includes("urgent")||b.includes("asap")||b.includes("immediate")?"HIGH":"MEDIUM"},ax=async()=>{if(!X.content.trim()&&0===aj.length||!c)return void await C.SweetAlert.warning("Message Required","Please enter a message or attach a file");try{$(!0),F(null);let a=[];if(aj.length>0){am(!0),ao({});try{a=await Promise.all(aj.map(async(a,b)=>{try{ao(b=>({...b,[a.name]:50}));let b=await aC(c.applicationId,a,`Message attachment: ${a.name}`,void 0);return ao(b=>({...b,[a.name]:100})),{fileName:a.name,contentType:a.type||"application/octet-stream",fileSizeBytes:a.size,storageKey:b.storageKey,storageUrl:b.storageUrl||"",documentId:b.documentId,description:`Message attachment: ${a.name}`}}catch(b){if(aD.logger.error(b,`Failed to upload attachment ${a.name}`,{tags:{error_type:"attachment_upload_error"},extra:{fileName:a.name}}),ao(b=>({...b,[a.name]:-1})),!(await C.SweetAlert.confirm("Upload Failed",`Failed to upload "${a.name}". Do you want to continue sending the message without this attachment?`,"Continue Without It","Cancel","warning")).isConfirmed)throw Error("User cancelled message send due to attachment upload failure");return{fileName:a.name,contentType:a.type||"application/octet-stream",fileSizeBytes:a.size,storageKey:`messages/${c.applicationId}/${Date.now()}-${a.name}`,storageUrl:"",description:void 0}}}))}catch(a){if(aD.logger.error(a,"Error uploading attachments",{tags:{error_type:"attachments_upload_error"}}),a instanceof Error&&a.message.includes("User cancelled")){am(!1),ao({});return}await C.SweetAlert.warning("Upload Warning","Some attachments failed to upload. The message will be sent without attachments.")}finally{am(!1),ao({})}}aD.logger.debug("Sending message",{applicationId:c.applicationId,content:X.content.substring(0,50)+"...",receiverId:X.receiverId||"none",replyToMessageId:af?.id,attachmentsCount:a.length});let b=await H.sendMessage(c.applicationId,X.content.trim(),X.receiverId||void 0,af?.id,a.length>0?a:void 0);if(b.success)aa(!0),setTimeout(()=>aa(!1),3e3),Y({applicationId:"",content:"",receiverId:""}),ak([]),ag(null),ar.current&&(ar.current.value=""),setTimeout(async()=>{await au(c.id),await as(),await at(),setTimeout(()=>{ap.current&&ap.current.scrollIntoView({behavior:"smooth"})},100)},500);else throw Error(b.errorMessage||"Failed to send message")}catch(b){aD.logger.error(b,"Failed to send message",{tags:{error_type:"message_send_error"}});let a=b instanceof Error?b.message:"Failed to send message";F(a),await C.SweetAlert.error("Failed to Send",a)}finally{$(!1)}},ay=a.filter(a=>{let b=a.applicantName.toLowerCase().includes(J.toLowerCase())||a.applicationReference?.toLowerCase().includes(J.toLowerCase())||a.lastMessage?.content.toLowerCase().includes(J.toLowerCase())||a.applicationId.toLowerCase().includes(J.toLowerCase()),c="ALL"===L||"UNREAD"===L&&a.unreadCount>0||"ACTIVE"===L&&a.isActive,d=P?a.isArchived:!a.isArchived,e=!R||a.isStarred;return b&&c&&d&&e}),aA=e.filter(a=>{if(!T)return!0;let b=T.toLowerCase();return a.content.toLowerCase().includes(b)||a.sender.toLowerCase().includes(b)||a.subject.toLowerCase().includes(b)}).sort((a,b)=>new Date(a.timestamp).getTime()-new Date(b.timestamp).getTime());return g?(0,l.jsxs)(m.Box,{height:"100vh",overflow:"hidden",display:"flex",children:[(0,l.jsx)(E.default,{}),(0,l.jsx)(m.Box,{ml:"240px",p:"8",bg:"gray.50",h:"100vh",flex:"1",display:"flex",alignItems:"center",justifyContent:"center",children:(0,l.jsx)(s.Spinner,{size:"xl",color:"orange.500"})})]}):(0,l.jsxs)(m.Box,{height:"100vh",overflow:"hidden",display:"flex",children:[(0,l.jsx)(E.default,{}),(0,l.jsx)(m.Box,{ml:"240px",bg:"gray.50",h:"100vh",display:"flex",flexDirection:"column",overflow:"hidden",flex:"1",children:(0,l.jsx)(n.Container,{maxW:"full",flex:"1",display:"flex",flexDirection:"column",p:"6",overflow:"hidden",minH:"0",children:(0,l.jsxs)(o.VStack,{gap:"4",align:"stretch",flex:"1",minH:"0",overflow:"hidden",children:[(0,l.jsxs)(r.Flex,{justify:"space-between",align:"center",flexShrink:0,children:[(0,l.jsxs)(o.VStack,{align:"start",gap:"1",children:[(0,l.jsx)(v.Typography,{fontSize:"2xl",fontWeight:"bold",color:"gray.900",children:"Messages"}),(0,l.jsx)(v.Typography,{fontSize:"sm",color:"gray.600",children:"Communicate with partners and customers"})]}),(0,l.jsxs)(p.HStack,{gap:"3",children:[(0,l.jsxs)(w.Button,{variant:"secondary",size:"sm",disabled:!0,children:[G," Unread"]}),ad?(0,l.jsx)(x.Tag,{variant:"success",children:" Live"}):(0,l.jsx)(x.Tag,{variant:"inactive",children:"Offline"}),(0,l.jsxs)(w.Button,{variant:"primary",size:"sm",onClick:()=>{W(!0),d(null),f([])},children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiPlus,{size:16})}),"New Message"]}),(0,l.jsxs)(w.Button,{variant:"secondary",size:"sm",onClick:()=>{as(),at(),c&&au(c.id)},children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiRefreshCw,{size:16})}),"Refresh"]})]})]}),_&&(0,l.jsx)(m.Box,{p:"3",bg:"green.50",borderRadius:"md",border:"1px",borderColor:"green.200",flexShrink:0,children:(0,l.jsxs)(p.HStack,{gap:"2",children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiCheckCircle,{size:16,color:"#38A169"})}),(0,l.jsx)(v.Typography,{fontSize:"sm",fontWeight:"medium",color:"green.800",children:"Message sent successfully!"})]})}),k&&(0,l.jsx)(m.Box,{p:"3",bg:"red.50",borderRadius:"md",border:"1px",borderColor:"red.200",flexShrink:0,children:(0,l.jsxs)(p.HStack,{gap:"2",justify:"space-between",align:"start",children:[(0,l.jsxs)(p.HStack,{gap:"2",flex:"1",children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiAlertCircle,{size:16,color:"#E53E3E"})}),(0,l.jsxs)(o.VStack,{align:"start",gap:"1",flex:"1",children:[(0,l.jsx)(v.Typography,{fontSize:"sm",fontWeight:"medium",color:"red.800",children:"Error loading messages"}),(0,l.jsx)(v.Typography,{fontSize:"xs",color:"red.700",children:k})]})]}),(0,l.jsx)(w.Button,{size:"sm",variant:"secondary",onClick:()=>{F(null),as(),at()},children:"Retry"})]})}),(0,l.jsxs)(r.Flex,{gap:"4",flex:"1",minH:"0",align:"stretch",overflow:"hidden",children:[(0,l.jsxs)(m.Box,{width:"380px",bg:"white",borderRadius:"lg",boxShadow:"sm",border:"1px",borderColor:"gray.200",display:"flex",flexDirection:"column",overflow:"hidden",flexShrink:0,children:[(0,l.jsx)(m.Box,{p:"3",borderBottom:"1px",borderColor:"gray.200",bg:"gray.50",flexShrink:0,children:(0,l.jsxs)(o.VStack,{gap:"2",align:"stretch",children:[(0,l.jsx)(m.Box,{flex:"1",maxW:"300px",children:(0,l.jsx)(u.Search,{placeholder:"Search messages...",onSearchChange:a=>K(a)})}),(0,l.jsxs)(p.HStack,{gap:"2",children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiFilter,{size:16,color:"#A0AEC0"})}),(0,l.jsxs)("select",{value:L,onChange:a=>M(a.target.value),style:{padding:"6px 12px",borderRadius:"6px",border:"1px solid #E2E8F0",backgroundColor:"white",fontSize:"13px",width:"100%",cursor:"pointer",color:"#000000"},children:[(0,l.jsx)("option",{value:"ALL",children:"All Messages"}),(0,l.jsx)("option",{value:"UNREAD",children:"Unread"}),(0,l.jsx)("option",{value:"ACTIVE",children:"Active"})]})]}),(0,l.jsxs)(p.HStack,{gap:"2",children:[(0,l.jsxs)(w.Button,{size:"sm",variant:P?"primary":"secondary",onClick:()=>Q(!P),children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiArchive,{size:14})}),P?"Show Archived":"Hide Archived"]}),(0,l.jsxs)(w.Button,{size:"sm",variant:R?"primary":"secondary",onClick:()=>S(!R),children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiStar,{size:14})}),"Starred"]})]})]})}),(0,l.jsx)(m.Box,{flex:"1",overflowY:"auto",minH:"0",p:"2",children:0!==ay.length||g?0===ay.length&&g?(0,l.jsx)(r.Flex,{justify:"center",align:"center",height:"100%",minH:"300px",children:(0,l.jsx)(s.Spinner,{size:"lg",color:"orange.500"})}):(0,l.jsx)(o.VStack,{gap:"2",align:"stretch",children:ay.map(a=>(0,l.jsxs)(m.Box,{p:"3",borderRadius:"md",cursor:"pointer",bg:a.id===c?.id?"orange.50":"white",border:"1px",borderColor:a.id===c?.id?"orange.200":"gray.200",_hover:{bg:a.id===c?.id?"orange.50":"gray.50",borderColor:a.id===c?.id?"orange.300":"gray.300"},onClick:()=>d(a),transition:"all 0.2s",position:"relative",children:[a.id===c?.id&&(0,l.jsx)(m.Box,{position:"absolute",left:"0",top:"0",bottom:"0",width:"3px",bg:"orange.500",borderRadius:"md"}),(0,l.jsxs)(o.VStack,{gap:"2",align:"stretch",children:[(0,l.jsxs)(r.Flex,{justify:"space-between",align:"start",children:[(0,l.jsxs)(p.HStack,{gap:"2",flex:"1",minW:"0",children:[a.unreadCount>0&&(0,l.jsx)(m.Box,{px:"2",py:"0.5",borderRadius:"full",bg:"orange.500",color:"white",fontSize:"2xs",fontWeight:"bold",minW:"20px",textAlign:"center",children:a.unreadCount}),(0,l.jsx)(v.Typography,{fontSize:"xs",fontWeight:"semibold",color:"gray.700",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:a.applicantName})]}),(0,l.jsx)(v.Typography,{fontSize:"2xs",color:"gray.500",flexShrink:0,ml:"2",children:new Date(a.lastMessageAt).toLocaleDateString("en-US",{month:"short",day:"numeric"})})]}),a.lastMessage&&(0,l.jsx)(v.Typography,{fontSize:"xs",color:"gray.600",lineHeight:"1.4",style:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:a.lastMessage.content}),(0,l.jsxs)(p.HStack,{gap:"2",fontSize:"2xs",color:"gray.500",children:[(0,l.jsx)(x.Tag,{variant:"info",children:a.applicationReference||a.applicationId.substring(0,8)}),(0,l.jsx)(v.Typography,{children:""}),(0,l.jsxs)(v.Typography,{children:[a.messageCount," msgs"]})]})]})]},a.id))}):(0,l.jsx)(r.Flex,{justify:"center",align:"center",height:"100%",minH:"300px",children:(0,l.jsxs)(o.VStack,{gap:"3",children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiMessageSquare,{size:40,color:"#CBD5E0"})}),(0,l.jsx)(v.Typography,{color:"gray.500",fontSize:"sm",fontWeight:"medium",children:"No messages found"}),J||"ALL"!==L?(0,l.jsx)(v.Typography,{color:"gray.400",fontSize:"xs",children:"Try adjusting your search or filter"}):(0,l.jsx)(v.Typography,{color:"gray.400",fontSize:"xs",children:"Messages will appear here when available"})]})})})]}),(0,l.jsx)(m.Box,{flex:"1",bg:"white",borderRadius:"lg",boxShadow:"sm",border:"1px",borderColor:"gray.200",display:"flex",flexDirection:"column",overflow:"hidden",minW:"0",children:c?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(m.Box,{p:"4",borderBottom:"1px",borderColor:"gray.200",bg:"gray.50",flexShrink:0,children:(0,l.jsxs)(o.VStack,{gap:"2",align:"stretch",children:[(0,l.jsxs)(r.Flex,{justify:"space-between",align:"start",children:[(0,l.jsxs)(o.VStack,{align:"start",gap:"1",children:[(0,l.jsx)(v.Typography,{fontSize:"md",fontWeight:"semibold",color:"gray.900",children:av(c)}),(0,l.jsx)(v.Typography,{fontSize:"sm",color:"gray.600",children:c.applicantName})]}),(0,l.jsx)(aE.default,{href:`/applications/${c.applicationId}`,children:(0,l.jsx)(w.Button,{size:"sm",variant:"secondary",children:"View Application"})})]}),(0,l.jsxs)(p.HStack,{gap:"4",fontSize:"xs",color:"gray.600",children:[(0,l.jsxs)(p.HStack,{gap:"1",children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiUser,{size:12})}),(0,l.jsxs)(v.Typography,{children:["Assigned: ",c.assignedAdminName||"Unassigned"]})]}),(0,l.jsxs)(p.HStack,{gap:"1",children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiMessageSquare,{size:12})}),(0,l.jsxs)(v.Typography,{children:[c.messageCount," messages"]})]})]})]})}),(0,l.jsxs)(m.Box,{flex:"1",overflowY:"auto",p:"4",bg:"gray.50",minH:"0",display:"flex",flexDirection:"column",children:[e.length>0&&(0,l.jsx)(m.Box,{mb:"3",flexShrink:0,children:(0,l.jsx)(m.Box,{flex:"1",maxW:"300px",children:(0,l.jsx)(u.Search,{placeholder:"Search messages in thread...",onSearchChange:a=>U(a)})})}),i?(0,l.jsx)(r.Flex,{justify:"center",align:"center",h:"200px",children:(0,l.jsx)(s.Spinner,{size:"md",color:"orange.500"})}):0===aA.length?(0,l.jsx)(r.Flex,{justify:"center",align:"center",height:"100%",minH:"300px",children:(0,l.jsxs)(o.VStack,{gap:"3",children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiMessageSquare,{size:40,color:"#CBD5E0"})}),(0,l.jsx)(v.Typography,{color:"gray.500",fontSize:"sm",fontWeight:"medium",children:T?"No messages match your search":"No messages in this thread"}),T&&(0,l.jsx)(w.Button,{size:"sm",variant:"ghost",onClick:()=>U(""),children:"Clear Search"})]})}):(0,l.jsxs)(o.VStack,{gap:"3",align:"stretch",children:[aA.map(a=>{let b=(a=>{if(!a.sender)return!1;let b=a.sender.toLowerCase();return!!("ADMIN"===a.senderType||b.includes("@mukuru.com"))||!!["tendai gatahwa","tendai","admin","compliance","mukuru"].some(a=>b.includes(a))||!["alpha tembo","alpha","customer","applicant"].some(a=>b.includes(a))&&"CUSTOMER"!==a.senderType&&(b.includes("mukuru")||b.includes("admin"))})(a);return 2>aA.indexOf(a)&&aD.logger.debug("[Messages] Rendering message",{sender:a.sender,senderType:a.senderType,isAdmin:b,willAlignRight:b}),(0,l.jsxs)(r.Flex,{justify:b?"flex-end":"flex-start",align:"flex-start",gap:"2",px:"2",children:[!b&&(0,l.jsx)(t.Avatar.Root,{size:"sm",children:(0,l.jsx)(t.Avatar.Fallback,{bg:"blue.500",children:a.sender.split(" ").map(a=>a[0]).join("").substring(0,2).toUpperCase()})}),(0,l.jsx)(m.Box,{maxW:"70%",p:"3",bg:b?"orange.500":"white",color:b?"white":"gray.800",borderRadius:"lg",boxShadow:"sm",border:b?"none":"1px",borderColor:b?"transparent":"gray.200",position:"relative",children:(0,l.jsxs)(o.VStack,{gap:"1.5",align:"stretch",children:[(0,l.jsxs)(r.Flex,{justify:"space-between",align:"center",gap:"2",children:[(0,l.jsx)(v.Typography,{fontSize:"xs",fontWeight:"semibold",color:b?"white":"gray.800",children:a.sender.split(",")[0].trim()}),(0,l.jsx)(v.Typography,{fontSize:"2xs",color:b?"orange.100":"gray.500",children:new Date(a.timestamp).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})})]}),(0,l.jsx)(v.Typography,{fontSize:"sm",whiteSpace:"pre-wrap",lineHeight:"1.5",color:b?"white":"gray.700",children:a.content}),a.attachments&&a.attachments.length>0&&(0,l.jsx)(m.Box,{mt:"2",p:"2",bg:b?"orange.600":"blue.50",borderRadius:"md",border:b?"none":"1px",borderColor:b?"transparent":"blue.100",children:(0,l.jsx)(o.VStack,{gap:"2",align:"stretch",children:a.attachments.map((a,c)=>(0,l.jsxs)(p.HStack,{gap:"2",justify:"space-between",children:[(0,l.jsxs)(p.HStack,{gap:"2",flex:"1",minW:"0",children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiPaperclip,{size:12,color:b?"white":"#3182CE"})}),(0,l.jsxs)(o.VStack,{align:"start",gap:"0",flex:"1",minW:"0",children:[(0,l.jsx)(v.Typography,{fontSize:"2xs",color:b?"white":"blue.700",fontWeight:"medium",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:a.fileName||`Attachment ${c+1}`}),(0,l.jsxs)(v.Typography,{fontSize:"2xs",color:b?"orange.100":"blue.600",children:[(a.fileSizeBytes/1024).toFixed(1)," KB"]})]})]}),(a.storageUrl||a.storageKey)&&(0,l.jsxs)(w.Button,{size:"sm",variant:b?"primary":"secondary",onClick:async()=>{try{let b=a.storageUrl;if(!b&&a.storageKey)try{let c=await fetch(`/api/proxy/api/v1/documents/download/${encodeURIComponent(a.storageKey)}`);if(c.ok){let a=await c.json();b=a.url||a.downloadUrl||""}}catch(a){aD.logger.error(a,"Failed to get download URL",{tags:{error_type:"download_url_error"}})}if(!b&&a.documentId)try{let c=await fetch(`/api/proxy/api/v1/documents/${a.documentId}/download`);if(c.ok){let a=await c.json();b=a.url||a.downloadUrl||""}}catch(a){aD.logger.error(a,"Failed to get document download URL",{tags:{error_type:"document_download_url_error"}})}b?window.open(b,"_blank"):await C.SweetAlert.warning("Download Unavailable","Download URL is not available for this attachment.")}catch(a){aD.logger.error(a,"Error downloading attachment",{tags:{error_type:"attachment_download_error"}}),await C.SweetAlert.error("Download Failed","Failed to download attachment. Please try again.")}},flexShrink:0,children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiDownload,{size:12})}),(0,l.jsx)(v.Typography,{ml:"1",children:"Download"})]})]},c))})}),a.replyToMessageId&&(0,l.jsx)(m.Box,{mt:"2",p:"2",bg:b?"orange.600":"gray.100",borderRadius:"md",borderLeft:b?"none":"3px",borderColor:b?"transparent":"blue.400",children:(0,l.jsxs)(v.Typography,{fontSize:"2xs",color:b?"orange.100":"gray.600",fontStyle:"italic",style:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:["Replying to: ",e.find(b=>b.id===a.replyToMessageId)?.content.substring(0,100)||"Previous message"]})}),(0,l.jsxs)(p.HStack,{gap:"1",mt:"2",justify:"flex-end",children:[(0,l.jsx)(w.Button,{size:"icon",variant:"ghost",onClick:()=>ag(a),title:"Reply",children:(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiCornerUpRight,{size:14})})}),(0,l.jsx)(w.Button,{size:"icon",variant:"ghost",onClick:()=>ai(a),title:"Forward",children:(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiShare2,{size:14})})}),(0,l.jsx)(w.Button,{size:"icon",variant:"ghost",onClick:async()=>{try{(await H.starMessage(a.id)).success&&c&&await au(c.id)}catch(a){aD.logger.error(a,"Failed to star message",{tags:{error_type:"star_message_error"}})}},title:a.isStarred?"Unstar":"Star",children:(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiStar,{size:14,color:a.isStarred?"#ECC94B":b?"white":"#A0AEC0"})})}),(0,l.jsx)(w.Button,{size:"icon",variant:"ghost",onClick:async()=>{if((await C.SweetAlert.confirm("Delete Message","Are you sure you want to delete this message? This action cannot be undone.","Yes, delete it!","Cancel","warning")).isConfirmed)try{C.SweetAlert.loading("Deleting...","Please wait while we delete the message.");let b=await H.deleteMessage(a.id);b.success?(f(b=>b.filter(b=>b.id!==a.id)),await as(),C.SweetAlert.close(),await C.SweetAlert.success("Deleted!","Message has been deleted successfully.")):(C.SweetAlert.close(),await C.SweetAlert.error("Delete Failed",b.errorMessage||"Failed to delete message"))}catch(a){aD.logger.error(a,"Failed to delete message",{tags:{error_type:"delete_message_error"}}),C.SweetAlert.close(),await C.SweetAlert.error("Delete Failed","Failed to delete message. Please try again.")}},title:"Delete",children:(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiTrash2,{size:16})})})]})]})}),b&&(0,l.jsx)(t.Avatar.Root,{size:"sm",children:(0,l.jsx)(t.Avatar.Fallback,{bg:"orange.500",children:a.sender.split(" ").map(a=>a[0]).join("").substring(0,2).toUpperCase()})})]},a.id)}),(0,l.jsx)("div",{ref:ap})]})]}),(0,l.jsx)(m.Box,{p:"3",borderTop:"1px",borderColor:"gray.200",bg:"white",flexShrink:0,children:(0,l.jsxs)(o.VStack,{gap:"2",align:"stretch",children:[af&&(0,l.jsx)(m.Box,{p:"2",bg:"blue.50",borderRadius:"md",borderLeft:"3px",borderColor:"blue.400",children:(0,l.jsxs)(p.HStack,{justify:"space-between",children:[(0,l.jsxs)(o.VStack,{align:"start",gap:"0",flex:"1",minW:"0",children:[(0,l.jsxs)(v.Typography,{fontSize:"2xs",fontWeight:"semibold",color:"blue.800",children:["Replying to ",af.sender]}),(0,l.jsx)(v.Typography,{fontSize:"2xs",color:"blue.600",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:af.content.substring(0,100)})]}),(0,l.jsx)(w.Button,{size:"icon",variant:"ghost",onClick:()=>ag(null),children:(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiX,{size:12})})})]})}),(0,l.jsx)(q.Textarea,{placeholder:af?`Reply to ${af.sender}...`:"Type your message...",value:X.content,onChange:a=>{Y(b=>({...b,content:a.target.value})),c&&ad&&a.target.value.length>0&&az.sendTypingIndicator(c.id)},onKeyDown:a=>{"Enter"!==a.key||a.shiftKey||(a.preventDefault(),ax())},size:"sm",rows:3,resize:"none",fontSize:"sm",color:"black",_focus:{color:"black"},_placeholder:{color:"gray.400"}}),aj.length>0&&(0,l.jsx)(o.VStack,{gap:"1.5",align:"stretch",children:aj.map((a,b)=>{let c=an[a.name],d=-1===c;return(0,l.jsxs)(p.HStack,{p:"2",bg:d?"red.50":"gray.50",borderRadius:"md",justify:"space-between",border:d?"1px":"none",borderColor:d?"red.200":"transparent",children:[(0,l.jsxs)(p.HStack,{gap:"2",flex:"1",minW:"0",children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiPaperclip,{size:12,color:d?"#E53E3E":"#718096"})}),(0,l.jsxs)(o.VStack,{align:"start",gap:"0",flex:"1",minW:"0",children:[(0,l.jsx)(v.Typography,{fontSize:"xs",fontWeight:"medium",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:d?"red.700":"gray.800",children:a.name}),(0,l.jsxs)(p.HStack,{gap:"2",align:"center",children:[(0,l.jsxs)(v.Typography,{fontSize:"2xs",color:d?"red.600":"gray.500",children:[(a.size/1024).toFixed(1)," KB"]}),void 0!==c&&c>0&&c<100&&(0,l.jsxs)(v.Typography,{fontSize:"2xs",color:"blue.600",children:[c,"%"]}),d&&(0,l.jsx)(v.Typography,{fontSize:"2xs",color:"red.600",fontWeight:"medium",children:"Upload failed"})]})]})]}),(0,l.jsx)(w.Button,{size:"icon",variant:"ghost",onClick:()=>{ak(a=>a.filter((a,c)=>c!==b)),ao(b=>{let c={...b};return delete c[a.name],c})},children:(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiX,{size:12})})})]},b)})}),c&&ab[c.id]&&(0,l.jsxs)(v.Typography,{fontSize:"2xs",color:"gray.500",fontStyle:"italic",children:[ab[c.id].userName," is typing..."]}),(0,l.jsxs)(p.HStack,{justify:"space-between",gap:"2",children:[(0,l.jsxs)(p.HStack,{gap:"2",flex:"1",children:[(0,l.jsx)("input",{ref:ar,type:"file",multiple:!0,style:{display:"none"},onChange:a=>{let b=Array.from(a.target.files||[]);ak(a=>[...a,...b])}}),(0,l.jsxs)(w.Button,{variant:"secondary",size:"sm",onClick:()=>ar.current?.click(),children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiPaperclip,{size:12})}),(0,l.jsx)(v.Typography,{children:"Attach"})]}),c&&(0,l.jsxs)(w.Button,{variant:"secondary",size:"sm",onClick:async()=>{try{let a=await H.archiveThread(c.id,!c.isArchived);a.success&&(await as(),a.isArchived&&d(null))}catch(a){aD.logger.error(a,"Failed to archive thread",{tags:{error_type:"archive_thread_error"}}),await C.SweetAlert.error("Archive Failed","Failed to archive thread. Please try again.")}},fontSize:"xs",children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiArchive,{size:12})}),(0,l.jsx)(v.Typography,{ml:"1.5",children:c.isArchived?"Unarchive":"Archive"})]})]}),(0,l.jsx)(w.Button,{variant:"primary",size:"sm",onClick:ax,disabled:Z||al,children:(0,l.jsxs)(p.HStack,{gap:"1.5",children:[Z||al?(0,l.jsx)(s.Spinner,{size:"xs"}):(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiSend,{size:12})}),(0,l.jsx)(v.Typography,{children:al?"Uploading...":Z?"Sending...":"Send"})]})})]})]})})]}):V?(0,l.jsx)(r.Flex,{justify:"center",align:"center",height:"100%",children:(0,l.jsxs)(o.VStack,{gap:"4",p:"8",children:[(0,l.jsx)(v.Typography,{fontSize:"md",fontWeight:"semibold",color:"gray.800",children:"Compose New Message"}),(0,l.jsx)(v.Typography,{fontSize:"sm",color:"gray.600",textAlign:"center",children:"To send a message, please select a thread or navigate to an application to start a conversation."}),(0,l.jsx)(w.Button,{variant:"secondary",size:"sm",onClick:()=>W(!1),children:"Cancel"})]})}):(0,l.jsx)(r.Flex,{justify:"center",align:"center",height:"100%",children:(0,l.jsxs)(o.VStack,{gap:"3",children:[(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiMessageSquare,{size:40,color:"#CBD5E0"})}),(0,l.jsx)(v.Typography,{fontSize:"sm",color:"gray.500",fontWeight:"medium",children:"Select a message to view details"})]})})})]})]})})}),(0,l.jsxs)(z.Modal,{isOpen:!!ah,onClose:()=>{ai(null),Y({applicationId:"",content:"",receiverId:""})},title:"Forward Message",size:"large",closeOnBackdropClick:!0,closeOnEsc:!0,children:[(0,l.jsx)(z.ModalHeader,{children:(0,l.jsx)(v.Typography,{fontSize:"lg",fontWeight:"semibold",color:"gray.800",children:"Forward Message"})}),(0,l.jsx)(z.ModalBody,{children:(0,l.jsxs)(o.VStack,{gap:"4",align:"stretch",children:[(0,l.jsxs)(m.Box,{p:"3",bg:"gray.50",borderRadius:"md",borderLeft:"3px",borderColor:"blue.400",children:[(0,l.jsx)(v.Typography,{fontSize:"sm",fontWeight:"medium",color:"gray.700",mb:"2",children:"Original Message:"}),(0,l.jsxs)(v.Typography,{fontSize:"sm",color:"gray.600",mb:"1",children:["From: ",ah?.sender]}),(0,l.jsx)(v.Typography,{fontSize:"sm",color:"gray.600",whiteSpace:"pre-wrap",children:ah?.content})]}),(0,l.jsxs)(o.VStack,{gap:"3",align:"stretch",children:[(0,l.jsxs)(m.Box,{children:[(0,l.jsx)(v.Typography,{fontSize:"sm",fontWeight:"medium",color:"gray.700",mb:"2",children:"To Application ID:"}),(0,l.jsx)(A.Input,{placeholder:"Enter application ID (GUID)",value:X.receiverId||"",onChange:a=>Y(b=>({...b,receiverId:a.target.value}))})]}),(0,l.jsxs)(m.Box,{children:[(0,l.jsx)(v.Typography,{fontSize:"sm",fontWeight:"medium",color:"gray.700",mb:"2",children:"Additional Message (Optional):"}),(0,l.jsx)(q.Textarea,{placeholder:"Add any additional context...",value:X.content,onChange:a=>Y(b=>({...b,content:a.target.value})),rows:4})]})]})]})}),(0,l.jsx)(z.ModalFooter,{children:(0,l.jsxs)(p.HStack,{justify:"flex-end",gap:"3",w:"full",children:[(0,l.jsx)(w.Button,{variant:"secondary",onClick:()=>{ai(null),Y({applicationId:"",content:"",receiverId:""})},children:"Cancel"}),(0,l.jsxs)(w.Button,{variant:"primary",onClick:async()=>{if(!X.receiverId?.trim())return void await C.SweetAlert.warning("Application ID Required","Please enter an application ID to forward to");try{$(!0);let a=await H.forwardMessage(ah.id,X.receiverId.trim(),void 0,X.content.trim()||void 0);if(a.success)await C.SweetAlert.success("Message Forwarded","The message has been forwarded successfully."),ai(null),Y({applicationId:"",content:"",receiverId:""}),await as();else throw Error(a.errorMessage||"Failed to forward message")}catch(a){aD.logger.error(a,"Failed to forward message",{tags:{error_type:"forward_message_error"}}),await C.SweetAlert.error("Forward Failed",a instanceof Error?a.message:"Failed to forward message")}finally{$(!1)}},disabled:Z,children:[Z?(0,l.jsx)(s.Spinner,{size:"sm"}):(0,l.jsx)(y.IconWrapper,{children:(0,l.jsx)(B.FiShare2,{size:16})}),(0,l.jsx)(v.Typography,{ml:"2",children:Z?"Forwarding...":"Forward"})]})]})})]})]})}a.s(["default",()=>aF],526680)}];

//# debugId=67af6edb-9620-a148-5ea3-3e493eaf5c3d
//# sourceMappingURL=src_app_messages_page_tsx_77cf07ec._.js.map