---
# Keycloak Realm Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-realm-config
  namespace: keycloak
data:
  kyc-realm.json: |
    {
      "realm": "kyc-platform",
      "displayName": "KYC Platform",
      "enabled": true,
      "sslRequired": "external",
      "registrationAllowed": true,
      "registrationEmailAsUsername": true,
      "rememberMe": true,
      "verifyEmail": false,
      "loginWithEmailAllowed": true,
      "duplicateEmailsAllowed": false,
      "resetPasswordAllowed": true,
      "editUsernameAllowed": false,
      "bruteForceProtected": true,
      "permanentLockout": false,
      "maxFailureWaitSeconds": 900,
      "minimumQuickLoginWaitSeconds": 60,
      "waitIncrementSeconds": 60,
      "quickLoginCheckMilliSeconds": 1000,
      "maxDeltaTimeSeconds": 43200,
      "failureFactor": 30,
      "defaultRoles": ["default-roles-kyc-platform"],
      "requiredCredentials": ["password"],
      "clients": [
        {
          "clientId": "kyc-frontend",
          "name": "KYC Frontend Application",
          "description": "Frontend application for external users",
          "enabled": true,
          "clientAuthenticatorType": "client-secret",
          "secret": "kyc-frontend-secret-changeme",
          "redirectUris": [
            "http://158.220.110.88.nip.io/*",
            "https://158.220.110.88.nip.io/*"
          ],
          "webOrigins": [
            "http://158.220.110.88.nip.io",
            "https://158.220.110.88.nip.io"
          ],
          "protocol": "openid-connect",
          "publicClient": false,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "directAccessGrantsEnabled": true,
          "serviceAccountsEnabled": false,
          "fullScopeAllowed": true,
          "attributes": {
            "saml.assertion.signature": "false",
            "saml.force.post.binding": "false",
            "saml.multivalued.roles": "false",
            "saml.encrypt": "false",
            "saml.server.signature": "false",
            "saml.server.signature.keyinfo.ext": "false",
            "exclude.session.state.from.auth.response": "false",
            "saml_force_name_id_format": "false",
            "saml.client.signature": "false",
            "tls.client.certificate.bound.access.tokens": "false",
            "saml.authnstatement": "false",
            "display.on.consent.screen": "false",
            "saml.onetimeuse.condition": "false"
          }
        },
        {
          "clientId": "kyc-admin",
          "name": "KYC Admin Application", 
          "description": "Admin application for internal users",
          "enabled": true,
          "clientAuthenticatorType": "client-secret",
          "secret": "kyc-admin-secret-changeme",
          "redirectUris": [
            "http://158.220.110.88.nip.io/admin/*",
            "https://158.220.110.88.nip.io/admin/*"
          ],
          "webOrigins": [
            "http://158.220.110.88.nip.io",
            "https://158.220.110.88.nip.io"
          ],
          "protocol": "openid-connect",
          "publicClient": false,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "directAccessGrantsEnabled": true,
          "serviceAccountsEnabled": false,
          "fullScopeAllowed": true
        }
      ],
      "roles": {
        "realm": [
          {
            "name": "customer",
            "description": "External customer role",
            "composite": false
          },
          {
            "name": "admin",
            "description": "Internal admin role",
            "composite": false
          },
          {
            "name": "reviewer",
            "description": "Internal reviewer role", 
            "composite": false
          },
          {
            "name": "approver",
            "description": "Internal approver role",
            "composite": false
          }
        ]
      },
      "groups": [
        {
          "name": "External Users",
          "path": "/External Users",
          "realmRoles": ["customer"]
        },
        {
          "name": "Internal Users",
          "path": "/Internal Users",
          "realmRoles": ["admin", "reviewer", "approver"]
        }
      ],
      "users": [
        {
          "username": "admin@company.com",
          "email": "admin@company.com",
          "firstName": "Admin",
          "lastName": "User",
          "enabled": true,
          "emailVerified": true,
          "credentials": [
            {
              "type": "password",
              "value": "admin123",
              "temporary": false
            }
          ],
          "realmRoles": ["admin"],
          "groups": ["/Internal Users"]
        },
        {
          "username": "customer@example.com",
          "email": "customer@example.com", 
          "firstName": "Customer",
          "lastName": "User",
          "enabled": true,
          "emailVerified": true,
          "credentials": [
            {
              "type": "password",
              "value": "customer123",
              "temporary": false
            }
          ],
          "realmRoles": ["customer"],
          "groups": ["/External Users"]
        }
      ],
      "identityProviders": [
        {
          "alias": "active-directory",
          "displayName": "Active Directory (Internal Users)",
          "providerId": "saml",
          "enabled": true,
          "trustEmail": true,
          "storeToken": false,
          "addReadTokenRoleOnCreate": false,
          "authenticateByDefault": false,
          "linkOnly": false,
          "firstBrokerLoginFlowAlias": "first broker login",
          "config": {
            "singleSignOnServiceUrl": "https://your-ad-server.com/adfs/ls/",
            "singleLogoutServiceUrl": "https://your-ad-server.com/adfs/ls/",
            "nameIDPolicyFormat": "urn:oasis:names:tc:SAML:2.0:nameid-format:persistent",
            "principalType": "SUBJECT",
            "signatureAlgorithm": "RSA_SHA256",
            "xmlSigKeyInfoKeyNameTransformer": "KEY_ID",
            "allowCreate": "true",
            "entityId": "https://keycloak.158.220.110.88.nip.io/realms/kyc-platform",
            "authnContextComparisonType": "exact",
            "hideOnLoginPage": "false",
            "loginHint": "false",
            "uiLocales": "false",
            "backchannelSupported": "false",
            "postBindingResponse": "true",
            "postBindingAuthnRequest": "true",
            "postBindingLogout": "true",
            "wantAuthnRequestsSigned": "false",
            "wantAssertionsSigned": "false",
            "wantAssertionsEncrypted": "false",
            "forceAuthn": "false",
            "validateSignature": "false",
            "signSpMetadata": "false"
          }
        }
      ],
      "identityProviderMappers": [
        {
          "name": "ad-role-mapper",
          "identityProviderAlias": "active-directory",
          "identityProviderMapper": "saml-role-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "attribute.name": "http://schemas.microsoft.com/ws/2008/06/identity/claims/role",
            "role": "admin"
          }
        }
      ],
      "clientScopes": [
        {
          "name": "kyc-scope",
          "description": "KYC Platform specific scope",
          "protocol": "openid-connect",
          "attributes": {
            "include.in.token.scope": "true",
            "display.on.consent.screen": "true"
          },
          "protocolMappers": [
            {
              "name": "role-mapper",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-realm-role-mapper",
              "consentRequired": false,
              "config": {
                "multivalued": "true",
                "userinfo.token.claim": "true",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "claim.name": "roles",
                "jsonType.label": "String"
              }
            }
          ]
        }
      ]
    }
