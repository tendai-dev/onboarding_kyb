upstream kyb-case-api {
    server kyb_case_api:8001;
}

upstream kyb-entity-config-api {
    server kyb_entity_config_api:8003;
}

upstream kyb-work-queue-service {
    server kyb_work_queue_service:8005;
}

upstream kyb-risk-api {
    server kyb_risk_api:8006;
}

upstream kyb-projections-api {
    server kyb_projections_api:8007;
}

upstream kyb-document-api {
    server kyb_document_api:8008;
}

upstream kyb-notification-api {
    server kyb_notification_api:8010;
}

upstream kyb-audit-api {
    server kyb_audit_api:8011;
}

upstream kyb-checklist-api {
    server kyb_checklist_api:8086;
}

upstream kyb-messaging-api {
    server kyb_messaging_api:8087;
}

# Map to handle workqueue path rewriting
map $request_uri $workqueue_backend_path {
    ~^/api/workqueue(\?.*)?$ /api/v1/workqueue$1;
    default $request_uri;
}

# Map to capture workqueue sub-path for proxy_pass
map $request_uri $workqueue_sub_path {
    ~^/api/workqueue/(.+)$ /api/v1/workqueue/$1;
    default $request_uri;
}

server {
    listen 80;
    server_name gateway.kyb.local;
    
    # Disable automatic trailing slash redirects
    merge_slashes off;
    
    # Prevent automatic directory redirects
    disable_symlinks off;
    
    # Disable absolute redirects (use relative redirects)
    absolute_redirect off;
    
    # Disable proxy redirect modifications
    proxy_redirect off;


    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Case/Application API
    location /api/cases/ {
        rewrite ^/api/cases/(.*)$ /$1 break;
        proxy_pass http://kyb-case-api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/applications {
        proxy_pass http://kyb-case-api/api/applications;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Entity Configuration API
    location ~ ^/api/entities/(.*)$ {
        rewrite ^/api/entities/(.*)$ /api/v1/$1 break;
        proxy_pass http://kyb-entity-config-api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location = /api/entities {
        proxy_pass http://kyb-entity-config-api/api/v1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/entity-config {
        proxy_pass http://kyb-entity-config-api/api/entity-config;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Work Queue Service
    location /api/tasks {
        proxy_pass http://kyb-work-queue-service/api/tasks;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/work-items {
        proxy_pass http://kyb-work-queue-service/api/work-items;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Work Queue API - Exact match location (highest precedence) to prevent redirects
    location = /api/workqueue {
        # Handle OPTIONS preflight requests FIRST - return immediately before any redirect
        if ($request_method = OPTIONS) {
            add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role,x-request-id' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Content-Type' 'text/plain; charset=utf-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        
        # Add CORS headers for actual requests
        add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role,x-request-id' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
        
        # Use proxy_pass with variable to prevent redirects
        proxy_pass http://kyb-work-queue-service$workqueue_backend_path;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-Id $http_x_user_id;
        proxy_set_header X-User-Email $http_x_user_email;
        proxy_set_header X-User-Name $http_x_user_name;
        proxy_set_header X-User-Role $http_x_user_role;
        proxy_set_header X-Trace-Id $http_x_trace_id;
        proxy_set_header X-Request-Id $http_x_request_id;
        proxy_intercept_errors on;
        error_page 502 503 504 = @workqueue_error;
    }
    
    # Work Queue API - Handle sub-paths (like /api/workqueue/pending-approvals)
    location ~ ^/api/workqueue/(.+)$ {
        # Handle OPTIONS preflight requests
        if ($request_method = OPTIONS) {
            add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role,x-request-id' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Content-Type' 'text/plain; charset=utf-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        
        add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role,x-request-id' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
        
        # Proxy directly using the captured group - /api/v1/workqueue/{captured_path}
        proxy_pass http://kyb-work-queue-service/api/v1/workqueue/$1$is_args$args;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-Id $http_x_user_id;
        proxy_set_header X-User-Email $http_x_user_email;
        proxy_set_header X-User-Name $http_x_user_name;
        proxy_set_header X-User-Role $http_x_user_role;
        proxy_set_header X-Trace-Id $http_x_trace_id;
        proxy_set_header X-Request-Id $http_x_request_id;
        proxy_intercept_errors on;
        error_page 502 503 504 = @workqueue_error;
    }
    
    # Error handler for work queue service
    location @workqueue_error {
        add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
        add_header 'Content-Type' 'application/json' always;
        return 502 '{"error":"Work queue service is unavailable. Please check if the service is running."}';
    }

    # Risk API - rewrite /api/risk/risk-assessments to /api/v1/risk-assessments
    location ~ ^/api/risk/(.+)$ {
        # Proxy directly using the captured group - /api/v1/{captured_path}
        proxy_pass http://kyb-risk-api/api/v1/$1$is_args$args;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Projections API
    location /api/projections {
        proxy_pass http://kyb-projections-api/api/projections;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Dashboard and reporting endpoints (projections API)
    location /api/v1/dashboard {
        # Add CORS headers
        add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Content-Type' 'text/plain; charset=utf-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        
        proxy_pass http://kyb-projections-api/api/v1/dashboard;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/v1/statistics {
        # Add CORS headers
        add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Content-Type' 'text/plain; charset=utf-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        
        proxy_pass http://kyb-projections-api/api/v1/statistics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/v1/trends {
        # Add CORS headers
        add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Content-Type' 'text/plain; charset=utf-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        
        proxy_pass http://kyb-projections-api/api/v1/trends;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/v1/cases {
        # Add CORS headers
        add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-trace-id,x-entity-type,x-country,x-user-id,x-user-email,x-user-name,x-user-role' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Content-Type' 'text/plain; charset=utf-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        
        proxy_pass http://kyb-projections-api/api/v1/cases;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/v1/sync {
        proxy_pass http://kyb-projections-api/api/v1/sync;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Document API
    location /api/documents {
        proxy_pass http://kyb-document-api/api/documents;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Handle file uploads
        client_max_body_size 50M;
        client_body_timeout 120s;
    }

    # Notifications API
    location /api/notifications/ {
        rewrite ^/api/notifications/(.*)$ /$1 break;
        proxy_pass http://kyb-notification-api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Audit API
    location /api/audit/ {
        rewrite ^/api/audit/(.*)$ /$1 break;
        proxy_pass http://kyb-audit-api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Checklist API
    location /api/checklists/ {
        rewrite ^/api/checklists/(.*)$ /$1 break;
        proxy_pass http://kyb-checklist-api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Messaging API
    location /api/messages/ {
        rewrite ^/api/messages/(.*)$ /$1 break;
        proxy_pass http://kyb-messaging-api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Let the messaging service handle its own CORS headers
        # No additional CORS headers needed here to avoid conflicts
    }

    # User Management API (routed through projections API)
    location /api/users {
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Content-Type' 'text/plain; charset=utf-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        
        # Add CORS headers for actual requests
        add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        
        rewrite ^/api/users(.*)$ /api/users$1 break;
        proxy_pass http://kyb-projections-api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Roles API (routed through projections API)
    location /api/roles {
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Content-Type' 'text/plain; charset=utf-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        
        # Add CORS headers for actual requests
        add_header 'Access-Control-Allow-Origin' 'http://localhost:3001' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        
        rewrite ^/api/roles(.*)$ /api/roles$1 break;
        proxy_pass http://kyb-projections-api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket support for real-time updates
    location /ws {
        proxy_pass http://kyb-projections-api/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Default timeout settings
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}
