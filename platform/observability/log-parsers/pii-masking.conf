# Fluent Bit PII Masking Configuration
# This parser redacts sensitive information from logs

[PARSER]
    Name   json_with_pii_masking
    Format json
    Time_Key timestamp
    Time_Format %Y-%m-%dT%H:%M:%S.%L%z

[FILTER]
    Name    modify
    Match   *
    
    # Mask common PII patterns in log messages
    # Email addresses
    Condition Key_Value_Matches message .*[\w\.-]+@[\w\.-]+\.\w+.*
    Set message ${message/[\w\.-]+@[\w\.-]+\.\w+/***@***.***}
    
    # Credit card numbers (basic pattern)
    Condition Key_Value_Matches message .*\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b.*
    Set message ${message/\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/****-****-****-****}
    
    # SSN/Tax ID (US format)
    Condition Key_Value_Matches message .*\b\d{3}-\d{2}-\d{4}\b.*
    Set message ${message/\b\d{3}-\d{2}-\d{4}\b/***-**-****}
    
    # Phone numbers (basic international)
    Condition Key_Value_Matches message .*\+?\d{1,3}[\s-]?\(?\d{3}\)?[\s-]?\d{3}[\s-]?\d{4}.*
    Set message ${message/\+?\d{1,3}[\s-]?\(?\d{3}\)?[\s-]?\d{3}[\s-]?\d{4}/***-***-****}

[FILTER]
    Name    lua
    Match   *
    script  /fluent-bit/scripts/pii_redaction.lua
    call    redact_sensitive_fields

# Lua script for advanced PII redaction
# /fluent-bit/scripts/pii_redaction.lua content:
#
# function redact_sensitive_fields(tag, timestamp, record)
#     local sensitive_keys = {
#         "password", "token", "secret", "api_key", "apikey",
#         "access_token", "refresh_token", "authorization",
#         "credit_card", "ssn", "tax_id", "passport",
#         "drivers_license", "date_of_birth", "dob"
#     }
#     
#     for key, value in pairs(record) do
#         local lower_key = string.lower(key)
#         for _, sensitive in ipairs(sensitive_keys) do
#             if string.find(lower_key, sensitive) then
#                 record[key] = "***REDACTED***"
#                 break
#             end
#         end
#     end
#     
#     return 2, timestamp, record
# end

[FILTER]
    Name    nest
    Match   *
    Operation lift
    Nested_under kubernetes
    Add_prefix k8s_

[FILTER]
    Name    record_modifier
    Match   *
    Record environment dev
    Record platform k3s-onboarding

